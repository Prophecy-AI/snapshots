# Santa 2025 - Christmas Tree Packing Challenge

## Current Status
- Best CV score: 70.619825 from exp_004 (005_ensemble_from_snapshots + bbox3)
- Best LB score: pending (need to submit to verify)
- Target: 68.896973 | Gap to target: 1.722852 (2.44%)

## Progress This Loop
- **Ensemble approach worked!** Scanned 3166 CSV files from snapshots
- Found 87 improvements from 7 different source files
- Improved from 70.626027 → 70.619825 (0.006202 improvement)
- Key improvements: N=65 (0.002180), N=87 (0.001803), N=88 (0.000608)
- After bbox3 optimization: additional 0.000011 improvement

## CV-LB Relationship Analysis
- CV and LB match exactly when solution is valid (no distribution shift)
- **CRITICAL**: Local overlap detection is LESS strict than Kaggle's
- Must use stricter overlap detection (buffer=0.0005) to avoid LB failures
- All improvements validated with overlap detection before inclusion

## Response to Evaluator
- Technical verdict was TRUSTWORTHY. The advanced bbox3 experiment confirmed the solution is at an extremely strong local optimum.
- Evaluator's top priority: **IMPLEMENT THE ENSEMBLE APPROACH** - DONE ✓
- Key insight: bbox3 with 10000 iterations and 128 restarts found only 0.00006 improvement
- This confirms local search is exhausted - need fundamentally different approaches

**My response to evaluator:**
- I AGREE that the ensemble approach was the right thing to try
- It found 87 improvements totaling 0.006202 points
- However, the gap to target (1.72 points) is still too large for local search
- Need to explore other approaches:
  1. Submit current best to verify LB score
  2. Try shake_public optimizer (different from bbox3)
  3. Research what top LB teams are doing differently
  4. Consider manual optimization of specific N values

## Data Understanding
- Reference notebooks: See `exploration/evolver_loop4_analysis.ipynb` for ensemble analysis
- Key patterns:
  - Ensemble from 3166 files found improvements in 87 N values
  - Most improvements came from N=65, N=87, N=88 (mid-range N values)
  - Small N values (1-10) are already well-optimized
  - Large N values (150-200) have less room for improvement

## Problem Overview
This is a 2D bin packing optimization problem where we need to fit Christmas tree-shaped polygons into the smallest possible square bounding box for configurations of N=1 to 200 trees.

**Scoring:** score = Σ(S_n²/n) for n=1 to 200, where S_n is the side length of the bounding square for n trees. **Lower is better.**

**Target Score:** Beat 68.896973

## Recommended Approaches (Priority Ordered)

### 1. **Submit Current Best for LB Verification** (HIGHEST PRIORITY)
- Current CV: 70.619825
- Need to verify this passes LB validation
- If it fails, identify which N values have overlaps

### 2. **Continue Ensemble Improvements**
- The ensemble approach found improvements - there may be more
- Look for additional CSV files in other locations
- Try combining with different optimization runs

### 3. **Shake_Public Optimizer** (NEW - NOT TRIED)
From saspav kernel, there's a shake_public optimizer that's different from bbox3:
- May find different improvements
- Need to locate the binary or source code

### 4. **SA with Fractional Translation** (From jonathanchan kernel)
The jonathanchan kernel has a sophisticated SA implementation:
- Fractional translation (0.001, 0.0005, 0.0002, 0.0001 step sizes)
- SA with translation/rotation/swap moves
- Global squeeze (scale toward centroid)
- May find improvements bbox3 missed

### 5. **Manual Optimization of Specific N Values**
For N values with largest potential improvement:
- N=65: Current score 0.3616, improved by 0.002180
- N=87: Current score 0.3504, improved by 0.001803
- N=88: Current score 0.3476, improved by 0.000608
- Try exhaustive search or specialized optimization

### 6. **Research Top LB Teams**
- The target (68.896973) exists - someone achieved it
- Check discussions for insights on what techniques work
- Look for patterns in top solutions

## What NOT to Try (Exhausted)
- Standard bbox3 iterations (tried extensively, only 0.00006 improvement)
- NFP-based placement (tried, baseline already better)
- Simple local search (tried, no improvement)
- Tessellation patterns (tried, worse than baseline)

## Validation Notes
- **ALWAYS** use strict overlap detection with buffer=0.0005
- Test on LB early to verify solutions are valid
- CV matches LB when solution is valid
- If CV improves but LB fails, the solution has overlaps

## Key Techniques from Top Kernels

### Ensemble Approach (WORKING)
From jonathanchan kernel:
- Scan ALL available CSV files
- For each N, find the configuration with smallest bounding box
- Validate no overlaps before including
- Combine best configurations into new submission

### C++ Optimizers
- **bbox3**: Main optimizer with parameters `-n` (iterations) and `-r` (restarts)
- **shake_public**: Different optimizer, may find different improvements
- Uses OpenMP for parallelization

### Post-Processing
1. Apply fix_direction() to optimize rotation of each configuration
2. Run fractional_translation for fine-tuning
3. Validate no overlaps exist with STRICT detection (buffer=0.0005)

## File Format
```csv
id,x,y,deg
001_0,s0.0,s0.0,s90.0
002_0,s0.0,s0.0,s90.0
002_1,s0.202736,s-0.511271,s90.0
...
```

## Reference Implementations
- Getting Started: `../research/kernels/inversion_santa-2025-getting-started/`
- bbox3 Runner: `../research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/`
- Advanced bbox3: `../research/kernels/jazivxt_why-not/`
- SA + Fractional Translation: `../research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`
- Ensemble + shake_public: `../research/kernels/saspav_santa-submission/`

## Pre-optimized Solutions Available
- Current best: `/home/submission/submission.csv` (70.619825)
- Ensemble source: `/home/code/experiments/005_ensemble_from_snapshots/submission_optimized.csv`
- Snapshot candidates: `/home/nonroot/snapshots/santa-2025/` (3166 CSV files)

## Key Insights
1. **Ensemble approach works** - Found 87 improvements from 7 files
2. **Local validation is less strict than Kaggle's** - Use conservative overlap detection (buffer=0.0005)
3. **bbox3 is exhausted** - 10000 iterations found only 0.00006 improvement
4. **Mid-range N values have most room for improvement** - N=65, N=87, N=88
5. **Gap to target is still 1.72 points** - Need fundamentally different approaches

## Score Contribution Analysis
The score formula S²/n means:
- N=1: S² contributes fully (weight = 1.0) - ALREADY OPTIMAL
- N=10: S² contributes S²/10 (weight = 0.1)
- N=100: S² contributes S²/100 (weight = 0.01)
- N=200: S² contributes S²/200 (weight = 0.005)

**Score breakdown (current best 70.619825):**
- N=1-10: ~4.33 (6.1%)
- N=11-50: ~14.70 (20.8%)
- N=51-100: ~17.61 (24.9%)
- N=101-150: ~17.14 (24.3%)
- N=151-200: ~16.84 (23.8%)

## CRITICAL PATH TO TARGET
The gap (1.72 points) requires ~1.22% reduction in ALL side lengths uniformly.
This is NOT achievable by fixing individual N values - it requires GLOBAL improvement.

**Approaches that could achieve this:**
1. Find additional ensemble sources with better configurations
2. Try shake_public optimizer (different from bbox3)
3. SA with fractional translation from jonathanchan kernel
4. Research what top LB teams are doing differently
5. Consider that the target may require techniques not in public kernels

**The target IS achievable** - we just need to find the right approach that escapes the current local optimum.
