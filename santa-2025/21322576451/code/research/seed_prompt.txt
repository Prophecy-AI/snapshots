# Santa 2025 - Christmas Tree Packing Challenge

## Current Status
- Best CV score: 70.626088 from exp_002 (003_nfp_placement)
- Best LB score: 70.626088 (verified from previous run)
- Target: 68.896973 | Gap to target: 1.729115 (2.51%)

## CV-LB Relationship Analysis
- CV and LB match exactly when solution is valid (no distribution shift)
- **CRITICAL**: Local overlap detection is LESS strict than Kaggle's
- candidate_029.csv (score 70.624381) FAILED LB with "Overlapping trees in group 040"
- Must use stricter overlap detection (buffer=0.001) to avoid LB failures

## Response to Evaluator
- Technical verdict was TRUSTWORTHY. The NFP experiment confirmed the baseline is at a strong local optimum.
- Evaluator's top priority: **COMPILE AND RUN THE ADVANCED bbox3 OPTIMIZER** from jazivxt kernel
- Key insight from experiment: Current N=2 config (side=0.949504) is BETTER than exhaustive search found (1.277835)
- This means the current solution uses sophisticated non-obvious configurations that simple optimization cannot discover

**My response to evaluator:**
- I AGREE that the advanced bbox3 optimizer should be tried
- The bbox3.cpp in jazivxt kernel has features not in standard version:
  - Global Boundary Tension (GLOBAL_TENSION_STRENGTH = 0.05)
  - Density Gradient Flow
  - Complex Number Vector Coordination
  - Hinge Pivot mechanics
  - Aggressive Overlap-and-Repair Cycle
- However, I also want to try other fundamentally different approaches

## Data Understanding
- Reference notebooks: See `exploration/evolver_loop3_analysis.ipynb` for gap analysis
- Key patterns:
  - Current packing efficiency is ~70% (score 70.626 vs theoretical 70.178 at 70% efficiency)
  - N=1 is already at theoretical minimum (0.813 side at 45°)
  - Score = Σ(S²/n), so small N has disproportionate impact
  - Need ~1.23% reduction in ALL side lengths uniformly to reach target
  - 38 experiments in previous run tried bbox3, SA, GA, MIP, tessellation, basin hopping, deletion cascade, asymmetric solutions, ensemble from 107 sources - ALL converged to same local optimum

## Problem Overview
This is a 2D bin packing optimization problem where we need to fit Christmas tree-shaped polygons into the smallest possible square bounding box for configurations of N=1 to 200 trees.

**Scoring:** score = Σ(S_n²/n) for n=1 to 200, where S_n is the side length of the bounding square for n trees. **Lower is better.**

**Target Score:** Beat 68.896973

## Recommended Approaches (Priority Ordered)

### 1. **Advanced bbox3 Optimizer** (HIGHEST PRIORITY)
The jazivxt "why-not" kernel has an advanced bbox3.cpp with features not tried:
- Global Boundary Tension (GLOBAL_TENSION_STRENGTH = 0.05)
- Density Gradient Flow
- Complex Number Vector Coordination
- Hinge Pivot mechanics
- Aggressive Overlap-and-Repair Cycle

**Implementation:**
```bash
# Extract bbox3.cpp from the kernel
# Compile with optimizations
g++ -O3 -march=native -fopenmp bbox3.cpp -o bbox3

# Run with long iterations
./bbox3 -n 5000 -r 256

# Apply fix_direction post-processing
# Validate with strict overlap detection (buffer=0.001)
```

### 2. **Guided Local Search (GLS)** (NEW - NOT TRIED)
From academic research, GLS is effective for escaping local optima:
- Penalize features of local optima to escape them
- Systematically explore different regions of solution space
- Has been successfully applied to 2D nesting problems

### 3. **L-BFGS Overlap Minimization** (NEW - NOT TRIED)
From CG:SHOP 2024 challenge approach:
- Use L-BFGS (limited memory BFGS) to minimize overlap
- Define overlap as minimum translation to separate polygons
- Converges to local optimum but depends on initialization
- Combine with perturbation moves to escape local optima

### 4. **Partitioning Approach** (NEW - NOT TRIED)
From recent research (CG:SHOP 2024):
- Partition the container into smaller regions
- Solve each subproblem independently
- Assemble solutions
- Can help escape global local optima by solving smaller problems

### 5. **Variable Neighborhood Search (VNS)** (NEW - NOT TRIED)
Systematically explore different neighborhoods:
- Start with small neighborhood (fine moves)
- If stuck, switch to larger neighborhood (coarse moves)
- Prevents cycling back to recently visited solutions

### 6. **Tabu Search** (NEW - NOT TRIED)
Prevent revisiting recent solutions:
- Maintain tabu list of recent moves
- Forbid moves that would return to recent configurations
- Forces exploration of new regions

## What NOT to Try (Exhausted in 38 experiments)
- Standard bbox3 iterations (tried extensively)
- Standard SA with same initialization
- Tessellation patterns (tried, worse than baseline)
- Genetic algorithm (tried, no improvement)
- MIP for small N (tried, baseline already optimal)
- Basin hopping (tried, no improvement)
- Greedy beam search (tried, no improvement)
- Deletion cascade (tried, no improvement)
- Cross-N extraction (tried, no improvement)
- Asymmetric solutions (tried, no improvement)
- Ensemble from 107 sources (tried, all converge to same optimum)

## Validation Notes
- **ALWAYS** use strict overlap detection with buffer=0.001
- Test on LB early to verify solutions are valid
- CV matches LB when solution is valid
- If CV improves but LB fails, the solution has overlaps

## Key Techniques from Top Kernels

### C++ Optimizers (Critical for Performance)
- **bbox3**: Main optimizer with parameters `-n` (iterations) and `-r` (restarts)
- **Advanced bbox3** (jazivxt): Has additional features for escaping local optima
- Uses OpenMP for parallelization

### Post-Processing
1. Apply fix_direction() to optimize rotation of each configuration
2. Run fractional_translation for fine-tuning
3. Validate no overlaps exist with STRICT detection (buffer=0.001)

## File Format
```csv
id,x,y,deg
001_0,s0.0,s0.0,s90.0
002_0,s0.0,s0.0,s90.0
002_1,s0.202736,s-0.511271,s90.0
...
```

## Reference Implementations
- Getting Started: `../research/kernels/inversion_santa-2025-getting-started/`
- bbox3 Runner: `../research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/`
- Advanced bbox3: `../research/kernels/jazivxt_why-not/` (HAS ADVANCED FEATURES)
- SA + Fractional Translation: `../research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`

## Pre-optimized Solutions Available
- Current best valid: `/home/submission/submission.csv` (70.626088)
- Snapshot candidates: `/home/nonroot/snapshots/santa-2025/21222392487/code/submission_candidates/`

## Key Insights
1. **38 experiments all converged to same optimum** - Need fundamentally different approach
2. **Local validation is less strict than Kaggle's** - Use conservative overlap detection (buffer=0.001)
3. **Current N=2 config is better than exhaustive search** - Solution uses sophisticated non-obvious configurations
4. **1.23% reduction in all side lengths needed** - This is the uniform improvement target
5. **Advanced bbox3 has untried features** - Global tension, density gradient, hinge pivot
6. **Academic techniques not tried** - GLS, L-BFGS, VNS, Tabu Search, Partitioning

## Score Contribution Analysis
The score formula S²/n means:
- N=1: S² contributes fully (weight = 1.0) - ALREADY OPTIMAL
- N=10: S² contributes S²/10 (weight = 0.1)
- N=100: S² contributes S²/100 (weight = 0.01)
- N=200: S² contributes S²/200 (weight = 0.005)

**Score breakdown:**
- N=1-10: 4.33 (6.1%)
- N=11-50: 14.70 (20.8%)
- N=51-100: 17.61 (24.9%)
- N=101-150: 17.14 (24.3%)
- N=151-200: 16.84 (23.8%)

## CRITICAL PATH TO TARGET
The gap (1.73 points) requires ~1.23% reduction in ALL side lengths uniformly.
This is NOT achievable by fixing individual N values - it requires GLOBAL improvement.

**Approaches that could achieve this:**
1. Advanced bbox3 with global tension features
2. Guided Local Search to escape current local optimum
3. L-BFGS-based overlap minimization with perturbation
4. Variable Neighborhood Search for systematic exploration
5. Partitioning approach to solve subproblems independently

**The target IS achievable** - we just need to find the right approach that escapes the current local optimum.