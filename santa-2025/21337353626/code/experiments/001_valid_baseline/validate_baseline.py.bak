{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "46f12916",
   "metadata": {},
   "source": [
    "# Valid Baseline Validation\n",
    "\n",
    "Validate the baseline from snapshot 21329067673 has no overlaps and calculate its score."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "3b4b505d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T19:21:31.905867Z",
     "iopub.status.busy": "2026-01-25T19:21:31.905312Z",
     "iopub.status.idle": "2026-01-25T19:21:32.252653Z",
     "shell.execute_reply": "2026-01-25T19:21:32.252216Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Functions defined!\n"
     ]
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from shapely.geometry import Polygon\n",
    "from shapely import affinity\n",
    "import json\n",
    "from decimal import Decimal, getcontext\n",
    "from tqdm import tqdm\n",
    "\n",
    "getcontext().prec = 30\n",
    "\n",
    "# Tree polygon vertices\n",
    "TX = [0, 0.125, 0.0625, 0.2, 0.1, 0.35, 0.075, 0.075, -0.075, -0.075, -0.35, -0.1, -0.2, -0.0625, -0.125]\n",
    "TY = [0.8, 0.5, 0.5, 0.25, 0.25, 0, 0, -0.2, -0.2, 0, 0, 0.25, 0.25, 0.5, 0.5]\n",
    "\n",
    "def get_tree_polygon(x, y, angle):\n",
    "    \"\"\"Create a tree polygon at position (x, y) with rotation angle.\"\"\"\n",
    "    coords = list(zip(TX, TY))\n",
    "    poly = Polygon(coords)\n",
    "    poly = affinity.rotate(poly, angle, origin=(0, 0))\n",
    "    poly = affinity.translate(poly, x, y)\n",
    "    return poly\n",
    "\n",
    "def parse_value(val):\n",
    "    \"\"\"Parse a value that may be prefixed with 's'.\"\"\"\n",
    "    if isinstance(val, str) and val.startswith('s'):\n",
    "        return float(val[1:])\n",
    "    return float(val)\n",
    "\n",
    "def load_submission(path):\n",
    "    \"\"\"Load a submission CSV and return trees by N.\"\"\"\n",
    "    df = pd.read_csv(path)\n",
    "    trees_by_n = {}\n",
    "    \n",
    "    for _, row in df.iterrows():\n",
    "        id_parts = row['id'].split('_')\n",
    "        n = int(id_parts[0])\n",
    "        x = parse_value(row['x'])\n",
    "        y = parse_value(row['y'])\n",
    "        deg = parse_value(row['deg'])\n",
    "        \n",
    "        if n not in trees_by_n:\n",
    "            trees_by_n[n] = []\n",
    "        trees_by_n[n].append((x, y, deg))\n",
    "    \n",
    "    return trees_by_n\n",
    "\n",
    "def calculate_bounding_box_side(trees):\n",
    "    \"\"\"Calculate the side length of the bounding square for a list of trees.\"\"\"\n",
    "    all_points = []\n",
    "    for x, y, angle in trees:\n",
    "        poly = get_tree_polygon(x, y, angle)\n",
    "        all_points.extend(list(poly.exterior.coords))\n",
    "    points = np.array(all_points)\n",
    "    min_xy = points.min(axis=0)\n",
    "    max_xy = points.max(axis=0)\n",
    "    return max(max_xy[0] - min_xy[0], max_xy[1] - min_xy[1])\n",
    "\n",
    "def check_overlap(trees):\n",
    "    \"\"\"Check if any trees overlap. Returns list of overlapping pairs.\"\"\"\n",
    "    polygons = []\n",
    "    for x, y, deg in trees:\n",
    "        poly = get_tree_polygon(x, y, deg)\n",
    "        polygons.append(poly)\n",
    "    \n",
    "    overlaps = []\n",
    "    for i in range(len(polygons)):\n",
    "        for j in range(i+1, len(polygons)):\n",
    "            if polygons[i].intersects(polygons[j]) and not polygons[i].touches(polygons[j]):\n",
    "                intersection = polygons[i].intersection(polygons[j])\n",
    "                if intersection.area > 1e-12:  # Small tolerance\n",
    "                    overlaps.append((i, j, intersection.area))\n",
    "    return overlaps\n",
    "\n",
    "print(\"Functions defined!\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "cb5fdc0f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T19:21:32.253813Z",
     "iopub.status.busy": "2026-01-25T19:21:32.253648Z",
     "iopub.status.idle": "2026-01-25T19:21:32.740073Z",
     "shell.execute_reply": "2026-01-25T19:21:32.739584Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Loaded 200 N values\n"
     ]
    }
   ],
   "source": [
    "# Load the valid baseline\n",
    "baseline_path = '/home/code/experiments/001_valid_baseline/submission.csv'\n",
    "trees_by_n = load_submission(baseline_path)\n",
    "print(f\"Loaded {len(trees_by_n)} N values\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "761cec6e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T19:21:32.741258Z",
     "iopub.status.busy": "2026-01-25T19:21:32.741142Z",
     "iopub.status.idle": "2026-01-25T19:21:40.699715Z",
     "shell.execute_reply": "2026-01-25T19:21:40.699295Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:   0%|          | 0/200 [00:00<?, ?it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  20%|█▉        | 39/200 [00:00<00:00, 374.56it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  38%|███▊      | 77/200 [00:00<00:01, 119.18it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  49%|████▉     | 98/200 [00:01<00:01, 72.58it/s] "
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  56%|█████▌    | 111/200 [00:01<00:01, 54.99it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  60%|██████    | 120/200 [00:01<00:01, 45.23it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  64%|██████▎   | 127/200 [00:02<00:01, 37.88it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  66%|██████▋   | 133/200 [00:02<00:02, 32.99it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  69%|██████▉   | 138/200 [00:02<00:02, 29.23it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  71%|███████   | 142/200 [00:03<00:02, 26.39it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  72%|███████▎  | 145/200 [00:03<00:02, 24.37it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  74%|███████▍  | 148/200 [00:03<00:02, 22.39it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  76%|███████▌  | 151/200 [00:03<00:02, 20.69it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  77%|███████▋  | 154/200 [00:03<00:02, 19.19it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  78%|███████▊  | 156/200 [00:03<00:02, 18.16it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  79%|███████▉  | 158/200 [00:04<00:02, 17.28it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  80%|████████  | 160/200 [00:04<00:02, 16.33it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  81%|████████  | 162/200 [00:04<00:02, 15.59it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  82%|████████▏ | 164/200 [00:04<00:02, 14.94it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  83%|████████▎ | 166/200 [00:04<00:02, 14.19it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  84%|████████▍ | 168/200 [00:04<00:02, 13.63it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  85%|████████▌ | 170/200 [00:05<00:02, 13.24it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  86%|████████▌ | 172/200 [00:05<00:02, 12.90it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  87%|████████▋ | 174/200 [00:05<00:02, 12.57it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  88%|████████▊ | 176/200 [00:05<00:01, 12.11it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  89%|████████▉ | 178/200 [00:05<00:01, 11.78it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  90%|█████████ | 180/200 [00:05<00:01, 11.56it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  91%|█████████ | 182/200 [00:06<00:01, 11.33it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  92%|█████████▏| 184/200 [00:06<00:01, 11.03it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  93%|█████████▎| 186/200 [00:06<00:01, 10.86it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  94%|█████████▍| 188/200 [00:06<00:01, 10.71it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  95%|█████████▌| 190/200 [00:06<00:00, 10.40it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  96%|█████████▌| 192/200 [00:07<00:00, 10.18it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  97%|█████████▋| 194/200 [00:07<00:00,  9.97it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  98%|█████████▊| 196/200 [00:07<00:00,  9.35it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  98%|█████████▊| 197/200 [00:07<00:00,  9.35it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps:  99%|█████████▉| 198/200 [00:07<00:00,  9.36it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps: 100%|█████████▉| 199/200 [00:07<00:00,  9.20it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps: 100%|██████████| 200/200 [00:07<00:00,  9.15it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking overlaps: 100%|██████████| 200/200 [00:07<00:00, 25.15it/s]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Total N values with overlaps: 0\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    }
   ],
   "source": [
    "# Check for overlaps in all N values\n",
    "overlapping_n = []\n",
    "for n in tqdm(range(1, 201), desc=\"Checking overlaps\"):\n",
    "    if n in trees_by_n:\n",
    "        overlaps = check_overlap(trees_by_n[n])\n",
    "        if overlaps:\n",
    "            overlapping_n.append(n)\n",
    "            if len(overlapping_n) <= 5:  # Only print first 5\n",
    "                print(f\"N={n}: {len(overlaps)} overlapping pairs\")\n",
    "\n",
    "print(f\"\\nTotal N values with overlaps: {len(overlapping_n)}\")\n",
    "if overlapping_n:\n",
    "    print(f\"Overlapping N values: {overlapping_n}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "bc63bb17",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T19:21:40.701184Z",
     "iopub.status.busy": "2026-01-25T19:21:40.700979Z",
     "iopub.status.idle": "2026-01-25T19:21:42.428140Z",
     "shell.execute_reply": "2026-01-25T19:21:42.427705Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Total score: 70.615745\n",
      "\n",
      "Top 10 score contributors:\n",
      "N=  1: side=0.813173, score=0.661250\n",
      "N=  2: side=0.949504, score=0.450779\n",
      "N=  3: side=1.142031, score=0.434745\n",
      "N=  5: side=1.443692, score=0.416850\n",
      "N=  4: side=1.290806, score=0.416545\n",
      "N=  7: side=1.673104, score=0.399897\n",
      "N=  6: side=1.548438, score=0.399610\n",
      "N=  9: side=1.867280, score=0.387415\n",
      "N=  8: side=1.755921, score=0.385407\n",
      "N= 15: side=2.377862, score=0.376949\n"
     ]
    }
   ],
   "source": [
    "# Calculate total score\n",
    "total_score = 0\n",
    "per_n_scores = {}\n",
    "\n",
    "for n in range(1, 201):\n",
    "    if n in trees_by_n:\n",
    "        side = calculate_bounding_box_side(trees_by_n[n])\n",
    "        score = (side ** 2) / n\n",
    "        per_n_scores[n] = score\n",
    "        total_score += score\n",
    "\n",
    "print(f\"Total score: {total_score:.6f}\")\n",
    "\n",
    "# Show top contributors\n",
    "print(\"\\nTop 10 score contributors:\")\n",
    "sorted_scores = sorted(per_n_scores.items(), key=lambda x: x[1], reverse=True)\n",
    "for n, score in sorted_scores[:10]:\n",
    "    side = calculate_bounding_box_side(trees_by_n[n])\n",
    "    print(f\"N={n:3d}: side={side:.6f}, score={score:.6f}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "22cac30c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T19:21:42.429260Z",
     "iopub.status.busy": "2026-01-25T19:21:42.429144Z",
     "iopub.status.idle": "2026-01-25T19:21:42.435813Z",
     "shell.execute_reply": "2026-01-25T19:21:42.435436Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Metrics saved!\n",
      "CV Score: 70.615745\n",
      "Overlapping N values: 0\n",
      "Submission copied to /home/submission/submission.csv\n"
     ]
    }
   ],
   "source": [
    "# Save metrics\n",
    "import shutil\n",
    "import os\n",
    "\n",
    "metrics = {\n",
    "    'cv_score': total_score,\n",
    "    'overlapping_n_count': len(overlapping_n),\n",
    "    'overlapping_n_values': overlapping_n,\n",
    "    'per_n_scores': {str(k): v for k, v in per_n_scores.items()}\n",
    "}\n",
    "\n",
    "with open('/home/code/experiments/001_valid_baseline/metrics.json', 'w') as f:\n",
    "    json.dump(metrics, f, indent=2)\n",
    "\n",
    "# Copy to submission folder\n",
    "os.makedirs('/home/submission', exist_ok=True)\n",
    "shutil.copy(baseline_path, '/home/submission/submission.csv')\n",
    "\n",
    "print(f\"\\nMetrics saved!\")\n",
    "print(f\"CV Score: {total_score:.6f}\")\n",
    "print(f\"Overlapping N values: {len(overlapping_n)}\")\n",
    "print(f\"Submission copied to /home/submission/submission.csv\")"
   ]
  }
 ],
 "metadata": {},
 "nbformat": 4,
 "nbformat_minor": 5
}
