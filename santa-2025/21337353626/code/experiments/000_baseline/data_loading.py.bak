{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "cc2bc477",
   "metadata": {},
   "source": [
    "# Baseline Experiment - Find Best Pre-Optimized Submission\n",
    "\n",
    "This notebook:\n",
    "1. Loads all pre-optimized submissions from snapshots\n",
    "2. Calculates scores for each\n",
    "3. Selects the best one as our baseline\n",
    "4. Copies it to submission folder"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "e7d3fd15",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T18:33:37.673821Z",
     "iopub.status.busy": "2026-01-25T18:33:37.673264Z",
     "iopub.status.idle": "2026-01-25T18:33:38.045904Z",
     "shell.execute_reply": "2026-01-25T18:33:38.045483Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Functions defined successfully!\n"
     ]
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from shapely.geometry import Polygon\n",
    "from shapely import affinity\n",
    "import os\n",
    "import glob\n",
    "import json\n",
    "from tqdm import tqdm\n",
    "\n",
    "# Tree polygon vertices\n",
    "TX = [0, 0.125, 0.0625, 0.2, 0.1, 0.35, 0.075, 0.075, -0.075, -0.075, -0.35, -0.1, -0.2, -0.0625, -0.125]\n",
    "TY = [0.8, 0.5, 0.5, 0.25, 0.25, 0, 0, -0.2, -0.2, 0, 0, 0.25, 0.25, 0.5, 0.5]\n",
    "\n",
    "def get_tree_polygon(x, y, angle):\n",
    "    \"\"\"Create a tree polygon at position (x, y) with rotation angle.\"\"\"\n",
    "    coords = list(zip(TX, TY))\n",
    "    poly = Polygon(coords)\n",
    "    poly = affinity.rotate(poly, angle, origin=(0, 0))\n",
    "    poly = affinity.translate(poly, x, y)\n",
    "    return poly\n",
    "\n",
    "def calculate_bounding_box_side(trees):\n",
    "    \"\"\"Calculate the side length of the bounding square for a list of trees.\"\"\"\n",
    "    all_points = []\n",
    "    for x, y, angle in trees:\n",
    "        poly = get_tree_polygon(x, y, angle)\n",
    "        all_points.extend(list(poly.exterior.coords))\n",
    "    points = np.array(all_points)\n",
    "    min_xy = points.min(axis=0)\n",
    "    max_xy = points.max(axis=0)\n",
    "    return max(max_xy[0] - min_xy[0], max_xy[1] - min_xy[1])\n",
    "\n",
    "def parse_value(val):\n",
    "    \"\"\"Parse a value that may be prefixed with 's'.\"\"\"\n",
    "    if isinstance(val, str) and val.startswith('s'):\n",
    "        return float(val[1:])\n",
    "    return float(val)\n",
    "\n",
    "def load_submission(path):\n",
    "    \"\"\"Load a submission CSV and return trees by N.\"\"\"\n",
    "    df = pd.read_csv(path)\n",
    "    trees_by_n = {}\n",
    "    \n",
    "    for _, row in df.iterrows():\n",
    "        id_parts = row['id'].split('_')\n",
    "        n = int(id_parts[0])\n",
    "        x = parse_value(row['x'])\n",
    "        y = parse_value(row['y'])\n",
    "        deg = parse_value(row['deg'])\n",
    "        \n",
    "        if n not in trees_by_n:\n",
    "            trees_by_n[n] = []\n",
    "        trees_by_n[n].append((x, y, deg))\n",
    "    \n",
    "    return trees_by_n\n",
    "\n",
    "def calculate_total_score(trees_by_n):\n",
    "    \"\"\"Calculate total score: sum(s_n^2 / n) for n=1 to 200.\"\"\"\n",
    "    total = 0\n",
    "    per_n_scores = {}\n",
    "    for n in range(1, 201):\n",
    "        if n in trees_by_n:\n",
    "            side = calculate_bounding_box_side(trees_by_n[n])\n",
    "            score = (side ** 2) / n\n",
    "            per_n_scores[n] = score\n",
    "            total += score\n",
    "    return total, per_n_scores\n",
    "\n",
    "print(\"Functions defined successfully!\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "cbb49767",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T18:33:38.047207Z",
     "iopub.status.busy": "2026-01-25T18:33:38.047017Z",
     "iopub.status.idle": "2026-01-25T18:33:38.051519Z",
     "shell.execute_reply": "2026-01-25T18:33:38.051145Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Found 87 submission files\n"
     ]
    }
   ],
   "source": [
    "# Find all submission files\n",
    "snapshot_dir = '/home/nonroot/snapshots/santa-2025'\n",
    "submission_files = glob.glob(f'{snapshot_dir}/*/submission/submission.csv')\n",
    "print(f\"Found {len(submission_files)} submission files\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "7c00c144",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T18:33:47.430979Z",
     "iopub.status.busy": "2026-01-25T18:33:47.430464Z",
     "iopub.status.idle": "2026-01-25T18:34:29.666572Z",
     "shell.execute_reply": "2026-01-25T18:34:29.666146Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:   0%|          | 0/20 [00:00<?, ?it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:   5%|▌         | 1/20 [00:02<00:41,  2.21s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "New best: 70.676102 from /home/nonroot/snapshots/santa-2025/21116303805/submission/submission.csv\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  10%|█         | 2/20 [00:04<00:39,  2.22s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "New best: 70.647327 from /home/nonroot/snapshots/santa-2025/21328309254/submission/submission.csv\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  15%|█▌        | 3/20 [00:06<00:37,  2.21s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  20%|██        | 4/20 [00:08<00:35,  2.20s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "New best: 70.647306 from /home/nonroot/snapshots/santa-2025/21165872902/submission/submission.csv\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  25%|██▌       | 5/20 [00:11<00:33,  2.22s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "New best: 70.625918 from /home/nonroot/snapshots/santa-2025/21198893057/submission/submission.csv\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  30%|███       | 6/20 [00:13<00:31,  2.23s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  35%|███▌      | 7/20 [00:15<00:29,  2.27s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  40%|████      | 8/20 [00:17<00:27,  2.25s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  45%|████▌     | 9/20 [00:20<00:24,  2.24s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "New best: 70.619825 from /home/nonroot/snapshots/santa-2025/21322576451/submission/submission.csv\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  50%|█████     | 10/20 [00:22<00:22,  2.23s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  55%|█████▌    | 11/20 [00:24<00:19,  2.21s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Error with /home/nonroot/snapshots/santa-2025/21145963314/submission/submission.csv: 'deg'\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  65%|██████▌   | 13/20 [00:26<00:11,  1.69s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  70%|███████   | 14/20 [00:28<00:10,  1.83s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  75%|███████▌  | 15/20 [00:31<00:09,  1.95s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  80%|████████  | 16/20 [00:33<00:08,  2.02s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  85%|████████▌ | 17/20 [00:35<00:06,  2.09s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  90%|█████████ | 18/20 [00:37<00:04,  2.12s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions:  95%|█████████▌| 19/20 [00:40<00:02,  2.13s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions: 100%|██████████| 20/20 [00:42<00:00,  2.15s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Evaluating submissions: 100%|██████████| 20/20 [00:42<00:00,  2.11s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Best score from sample: 70.619825\n",
      "Best file: /home/nonroot/snapshots/santa-2025/21322576451/submission/submission.csv\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    }
   ],
   "source": [
    "# Calculate scores for all submissions (sample first to find best)\n",
    "# This can take a while, so let's sample a few first\n",
    "\n",
    "best_score = float('inf')\n",
    "best_file = None\n",
    "best_per_n = None\n",
    "\n",
    "# Sample 20 submissions to find a good one quickly\n",
    "sample_files = submission_files[:20]\n",
    "\n",
    "for f in tqdm(sample_files, desc=\"Evaluating submissions\"):\n",
    "    try:\n",
    "        trees_by_n = load_submission(f)\n",
    "        score, per_n = calculate_total_score(trees_by_n)\n",
    "        if score < best_score:\n",
    "            best_score = score\n",
    "            best_file = f\n",
    "            best_per_n = per_n\n",
    "            print(f\"New best: {score:.6f} from {f}\")\n",
    "    except Exception as e:\n",
    "        print(f\"Error with {f}: {e}\")\n",
    "\n",
    "print(f\"\\nBest score from sample: {best_score:.6f}\")\n",
    "print(f\"Best file: {best_file}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "041330a5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T18:34:39.336021Z",
     "iopub.status.busy": "2026-01-25T18:34:39.335470Z",
     "iopub.status.idle": "2026-01-25T18:37:08.639105Z",
     "shell.execute_reply": "2026-01-25T18:37:08.638664Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:   0%|          | 0/67 [00:00<?, ?it/s]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:   1%|▏         | 1/67 [00:02<02:25,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:   3%|▎         | 2/67 [00:04<02:22,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:   4%|▍         | 3/67 [00:06<02:19,  2.17s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:   6%|▌         | 4/67 [00:08<02:16,  2.17s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:   7%|▋         | 5/67 [00:10<02:16,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:   9%|▉         | 6/67 [00:13<02:13,  2.19s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  10%|█         | 7/67 [00:15<02:11,  2.19s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  12%|█▏        | 8/67 [00:17<02:08,  2.18s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  13%|█▎        | 9/67 [00:19<02:06,  2.19s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  15%|█▍        | 10/67 [00:21<02:04,  2.18s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  16%|█▋        | 11/67 [00:24<02:02,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  18%|█▊        | 12/67 [00:26<02:00,  2.19s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  19%|█▉        | 13/67 [00:28<01:58,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  21%|██        | 14/67 [00:30<01:56,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  22%|██▏       | 15/67 [00:32<01:54,  2.21s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  24%|██▍       | 16/67 [00:35<01:52,  2.21s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  25%|██▌       | 17/67 [00:37<01:50,  2.21s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  27%|██▋       | 18/67 [00:39<01:48,  2.21s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  28%|██▊       | 19/67 [00:41<01:46,  2.21s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  30%|██▉       | 20/67 [00:43<01:43,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  31%|███▏      | 21/67 [00:46<01:41,  2.21s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  33%|███▎      | 22/67 [00:48<01:38,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  34%|███▍      | 23/67 [00:50<01:36,  2.19s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  36%|███▌      | 24/67 [00:52<01:33,  2.18s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  37%|███▋      | 25/67 [00:54<01:32,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  39%|███▉      | 26/67 [00:57<01:29,  2.19s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  40%|████      | 27/67 [00:59<01:27,  2.19s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  42%|████▏     | 28/67 [01:01<01:25,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  43%|████▎     | 29/67 [01:03<01:23,  2.20s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  45%|████▍     | 30/67 [01:05<01:21,  2.20s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "New best: 70.615745 from /home/nonroot/snapshots/santa-2025/21328310479/submission/submission.csv\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  46%|████▋     | 31/67 [01:08<01:19,  2.21s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  48%|████▊     | 32/67 [01:10<01:18,  2.23s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  49%|████▉     | 33/67 [01:12<01:15,  2.22s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  51%|█████     | 34/67 [01:14<01:13,  2.22s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  52%|█████▏    | 35/67 [01:17<01:11,  2.22s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  54%|█████▎    | 36/67 [01:19<01:08,  2.22s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  55%|█████▌    | 37/67 [01:21<01:06,  2.23s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  57%|█████▋    | 38/67 [01:23<01:04,  2.22s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "New best: 70.572798 from /home/nonroot/snapshots/santa-2025/21145966992/submission/submission.csv\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  58%|█████▊    | 39/67 [01:26<01:02,  2.23s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  60%|█████▉    | 40/67 [01:28<00:59,  2.22s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  61%|██████    | 41/67 [01:30<00:57,  2.23s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  63%|██████▎   | 42/67 [01:32<00:56,  2.24s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  64%|██████▍   | 43/67 [01:34<00:54,  2.25s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  66%|██████▌   | 44/67 [01:37<00:52,  2.26s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  67%|██████▋   | 45/67 [01:39<00:50,  2.29s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  69%|██████▊   | 46/67 [01:41<00:48,  2.31s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  70%|███████   | 47/67 [01:44<00:46,  2.30s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  72%|███████▏  | 48/67 [01:46<00:43,  2.30s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  73%|███████▎  | 49/67 [01:48<00:40,  2.27s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  75%|███████▍  | 50/67 [01:51<00:38,  2.27s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  76%|███████▌  | 51/67 [01:53<00:36,  2.27s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  78%|███████▊  | 52/67 [01:55<00:33,  2.27s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  79%|███████▉  | 53/67 [01:57<00:31,  2.26s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  81%|████████  | 54/67 [02:00<00:29,  2.26s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  82%|████████▏ | 55/67 [02:02<00:27,  2.26s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  84%|████████▎ | 56/67 [02:04<00:24,  2.26s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  85%|████████▌ | 57/67 [02:06<00:22,  2.26s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  87%|████████▋ | 58/67 [02:09<00:20,  2.26s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  88%|████████▊ | 59/67 [02:11<00:18,  2.26s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  90%|████████▉ | 60/67 [02:13<00:15,  2.25s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  91%|█████████ | 61/67 [02:15<00:13,  2.25s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  93%|█████████▎| 62/67 [02:18<00:11,  2.28s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  94%|█████████▍| 63/67 [02:20<00:09,  2.25s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  96%|█████████▌| 64/67 [02:22<00:06,  2.24s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  97%|█████████▋| 65/67 [02:24<00:04,  2.24s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining:  99%|█████████▊| 66/67 [02:27<00:02,  2.24s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining: 100%|██████████| 67/67 [02:29<00:00,  2.23s/it]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\r",
      "Checking remaining: 100%|██████████| 67/67 [02:29<00:00,  2.23s/it]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Final best score: 70.572798\n",
      "Best file: /home/nonroot/snapshots/santa-2025/21145966992/submission/submission.csv\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    }
   ],
   "source": [
    "# Check more submissions to find the absolute best\n",
    "remaining_files = submission_files[20:]\n",
    "\n",
    "for f in tqdm(remaining_files, desc=\"Checking remaining\"):\n",
    "    try:\n",
    "        trees_by_n = load_submission(f)\n",
    "        score, per_n = calculate_total_score(trees_by_n)\n",
    "        if score < best_score:\n",
    "            best_score = score\n",
    "            best_file = f\n",
    "            best_per_n = per_n\n",
    "            print(f\"New best: {score:.6f} from {f}\")\n",
    "    except Exception as e:\n",
    "        pass  # Skip errors silently\n",
    "\n",
    "print(f\"\\nFinal best score: {best_score:.6f}\")\n",
    "print(f\"Best file: {best_file}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "02e86b43",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T18:37:18.288564Z",
     "iopub.status.busy": "2026-01-25T18:37:18.288014Z",
     "iopub.status.idle": "2026-01-25T18:37:28.305598Z",
     "shell.execute_reply": "2026-01-25T18:37:28.305156Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Per-N Score Analysis (top 20 contributors):\n",
      "==================================================\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N=  1: side=0.813173, score=0.661250\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N=  2: side=0.935230, score=0.437328\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N=  3: side=1.142031, score=0.434745\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N=  4: side=1.282273, score=0.411056\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N=  7: side=1.673104, score=0.399897\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N=  6: side=1.548438, score=0.399610\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N=  5: side=1.403761, score=0.394109\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N=  9: side=1.867280, score=0.387415\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N=  8: side=1.755921, score=0.385407\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 15: side=2.384962, score=0.379203\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 10: side=1.940696, score=0.376630\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 21: side=2.811667, score=0.376451\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 20: side=2.742469, score=0.376057\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 11: side=2.033002, score=0.375736\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 22: side=2.873270, score=0.375258\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 26: side=3.118320, score=0.373997\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 16: side=2.445876, score=0.373894\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 12: side=2.114873, score=0.372724\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 13: side=2.200046, score=0.372323\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "N= 25: side=3.050182, score=0.372144\n",
      "\n",
      "Total score: 70.572798\n"
     ]
    }
   ],
   "source": [
    "# Analyze the best submission - per-N breakdown\n",
    "print(\"\\nPer-N Score Analysis (top 20 contributors):\")\n",
    "print(\"=\"*50)\n",
    "\n",
    "# Sort by score contribution (highest first)\n",
    "sorted_scores = sorted(best_per_n.items(), key=lambda x: x[1], reverse=True)\n",
    "\n",
    "for n, score in sorted_scores[:20]:\n",
    "    trees = load_submission(best_file)[n]\n",
    "    side = calculate_bounding_box_side(trees)\n",
    "    print(f\"N={n:3d}: side={side:.6f}, score={score:.6f}\")\n",
    "\n",
    "print(f\"\\nTotal score: {best_score:.6f}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "dbd0cf39",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T18:37:28.306729Z",
     "iopub.status.busy": "2026-01-25T18:37:28.306620Z",
     "iopub.status.idle": "2026-01-25T18:37:28.313221Z",
     "shell.execute_reply": "2026-01-25T18:37:28.312066Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Copied best submission to /home/submission/submission.csv\n",
      "Score: 70.572798\n"
     ]
    }
   ],
   "source": [
    "# Copy best submission to our submission folder\n",
    "import shutil\n",
    "\n",
    "os.makedirs('/home/submission', exist_ok=True)\n",
    "shutil.copy(best_file, '/home/submission/submission.csv')\n",
    "\n",
    "# Also save to experiment folder\n",
    "shutil.copy(best_file, '/home/code/experiments/000_baseline/submission.csv')\n",
    "\n",
    "print(f\"Copied best submission to /home/submission/submission.csv\")\n",
    "print(f\"Score: {best_score:.6f}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "9283ccb0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-25T18:37:28.314619Z",
     "iopub.status.busy": "2026-01-25T18:37:28.314267Z",
     "iopub.status.idle": "2026-01-25T18:37:28.317999Z",
     "shell.execute_reply": "2026-01-25T18:37:28.317610Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Saved metrics to experiments/000_baseline/metrics.json\n",
      "\n",
      "Baseline CV Score: 70.572798\n"
     ]
    }
   ],
   "source": [
    "# Save metrics\n",
    "metrics = {\n",
    "    'cv_score': best_score,\n",
    "    'best_file': best_file,\n",
    "    'per_n_scores': {str(k): v for k, v in best_per_n.items()}\n",
    "}\n",
    "\n",
    "with open('/home/code/experiments/000_baseline/metrics.json', 'w') as f:\n",
    "    json.dump(metrics, f, indent=2)\n",
    "\n",
    "print(f\"Saved metrics to experiments/000_baseline/metrics.json\")\n",
    "print(f\"\\nBaseline CV Score: {best_score:.6f}\")"
   ]
  }
 ],
 "metadata": {},
 "nbformat": 4,
 "nbformat_minor": 5
}
