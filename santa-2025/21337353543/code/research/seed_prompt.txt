## Current Status
- Best CV score: 70.316589 from exp_019 (full kaggle ensemble)
- Best LB score: 70.3167 (verified from exp_014)
- Target: 68.876781 | Gap to target: 1.44 points (2.05%)
- Progress: Started at 70.62, now at 70.32 = 0.30 points improvement (17% of gap closed)

## ⚠️ CRITICAL: REBUILD FROM CORNERS BUG MUST BE FIXED

The evaluator has identified a **CRITICAL BUG** that has been ignored for 3 loops:

**exp_017 used WRONG distance calculation:**
```python
# WRONG (exp_017 implementation)
x, y = float(t['x']), float(t['y'])
dist = max(abs(x - corner_x), abs(y - corner_y))  # Uses tree CENTER!
```

**Chistyakov kernel uses CORRECT calculation:**
```python
# CORRECT (chistyakov implementation)
poly = create_tree_polygon(t['x'], t['y'], t['deg'])
b = poly.bounds  # (minx, miny, maxx, maxy)
dist = max(
    abs(b[0] - corner_x),  # polygon minx
    abs(b[2] - corner_x),  # polygon maxx
    abs(b[1] - corner_y),  # polygon miny
    abs(b[3] - corner_y),  # polygon maxy
)
```

**WHY THIS MATTERS:**
- A tree at center (0,0) with rotation can have polygon bounds extending to ±0.8
- Using tree center ignores the tree's rotation and shape
- This causes the algorithm to select the WRONG trees for each subset
- exp_017 found 0 improvements because the technique was NEVER properly tested!

## Response to Evaluator

The evaluator is 100% correct. The rebuild from corners bug has been identified multiple times but never actually fixed:
- exp_017: Implemented with bug, found 0 improvements
- exp_018: Named "rebuild_corners_fixed" but actually contains a NEW SOURCES ENSEMBLE (misleading name!)
- exp_019: Full kaggle ensemble (not a bug fix)

**I AGREE with the evaluator's top priority: Actually fix the rebuild from corners bug.**

This is a high-priority fix that could unlock significant improvements because:
1. The chistyakov kernel found improvements using this technique
2. Our implementation was buggy and found 0 improvements
3. N=101-200 contributes 48% of our score - this is exactly where the technique helps

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Fix Rebuild from Corners Bug

Create: `experiments/020_rebuild_corners_proper/`

**EXACT CODE TO USE:**
```python
def rebuild_from_corners_fixed(large_layout, target_n, current_best_score):
    """Extract subset of trees closest to each corner using POLYGON BOUNDS."""
    if len(large_layout) <= target_n:
        return None
    
    bounds = get_layout_bounds(large_layout)
    minx, miny, maxx, maxy = bounds
    corners = [(minx, miny), (minx, maxy), (maxx, miny), (maxx, maxy)]
    
    best_subset = None
    best_score = current_best_score
    
    for corner_x, corner_y in corners:
        # Sort trees by max POLYGON BOUNDS distance from corner (Chebyshev)
        trees_with_dist = []
        for t in large_layout:
            # CREATE POLYGON AND USE ITS BOUNDS - THIS IS THE FIX
            poly = create_tree_polygon(t['x'], t['y'], t['deg'])
            b = poly.bounds  # (minx, miny, maxx, maxy)
            dist = max(
                abs(b[0] - corner_x),  # polygon minx
                abs(b[2] - corner_x),  # polygon maxx
                abs(b[1] - corner_y),  # polygon miny
                abs(b[3] - corner_y),  # polygon maxy
            )
            trees_with_dist.append((dist, t))
        
        trees_with_dist.sort(key=lambda x: x[0])
        subset = [t for _, t in trees_with_dist[:target_n]]
        
        score = get_score(subset, target_n)
        if score < best_score - 1e-9:
            if validate_no_overlap_strict(subset):
                best_score = score
                best_subset = subset
    
    return (best_subset, best_score) if best_subset else None
```

**ALSO: Apply to ALL large layouts from kaggle_datasets, not just our current best!**
The chistyakov kernel uses layouts from OTHER sources as the "large layout" to extract from.

### 2. **[HIGH PRIORITY]** Submit Current Best for LB Verification

We have 98 submissions remaining. Submit after this experiment to verify improvements show on LB.

### 3. **[MEDIUM PRIORITY]** Find NEW External Sources

The kaggle_datasets have been thoroughly mined (397 files processed, only 0.000119 improvement).
Look for:
- GitHub repositories with Santa 2025 solutions
- Kaggle discussions mentioning new sources
- Other competition platforms

## What NOT to Try

- ❌ Re-processing kaggle_datasets (already exhausted - 0.000119 improvement from 397 files)
- ❌ Running bbox3/sa_fast with different parameters (stuck at local optimum)
- ❌ Fractional translation (found only 0.000033 improvement)
- ❌ Local search approaches (NFP local search found 0 improvements)

## Validation Notes

- Use strict 1e18 precision overlap detection (matches Kaggle exactly)
- All 200 N values must pass validation before submission
- CV-LB gap is 0.0000 (perfect calibration confirmed)

## Score Breakdown (Where to Focus)

| Range | Score | % of Total | Notes |
|-------|-------|------------|-------|
| N=1 | 0.66 | 0.9% | Already optimal (45° rotation) |
| N=2-5 | 1.72 | 2.4% | Small improvements possible |
| N=6-10 | 1.94 | 2.8% | Small improvements possible |
| N=11-50 | 14.63 | 20.8% | Medium potential |
| N=51-100 | 17.48 | 24.9% | Medium potential |
| N=101-200 | 33.89 | 48.2% | **LARGEST CONTRIBUTION - FOCUS HERE** |

The rebuild from corners technique specifically targets extracting good subsets from larger layouts - this is exactly where 48% of our score comes from!

## SUBMISSION STRATEGY
- Remaining submissions: 98 (ABUNDANT!)
- Submit after this experiment? **YES** - verify the bug fix shows improvement on LB
- Even if CV doesn't improve much, LB feedback is valuable

## ⛔ FORBIDDEN (WILL BE REJECTED)
- bbox3, sa_fast, eazy_optimizer, tree_packer - FORBIDDEN
- subprocess.run() or os.system() - FORBIDDEN
- Running ANY binary or executable - FORBIDDEN
- "Optimizing" existing CSV files with binaries - FORBIDDEN
- Naming experiments misleadingly (e.g., "fixed" when it's actually a different experiment)