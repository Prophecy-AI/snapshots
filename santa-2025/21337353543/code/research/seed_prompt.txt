## Current Status
- Best CV score: 70.316589 from exp_019 (Full Kaggle Ensemble)
- Best LB score: 70.3167 (from exp_014)
- Target: 68.876781 | Gap to target: 1.44 points (2.05%)

## Progress Summary
- Started at: 70.62 (baseline)
- Current: 70.32
- Improvement: 0.30 points (17% of gap closed)
- Remaining gap: 1.44 points (83% of gap remaining)

## ⚠️ CRITICAL: REBUILD FROM CORNERS BUG NEVER FIXED ⚠️

The evaluator has identified a CRITICAL BUG in exp_017 that was NEVER properly fixed:

**THE BUG (exp_017 code - WRONG):**
```python
for t in large_layout:
    x, y = float(t['x']), float(t['y'])  # USES TREE CENTER!
    dist = max(abs(x - corner_x), abs(y - corner_y))
```

**THE FIX (chistyakov kernel - CORRECT):**
```python
candidates = {
    max(
        abs(tree.polygon.bounds[0] - corner_x),  # polygon minx
        abs(tree.polygon.bounds[2] - corner_x),  # polygon maxx
        abs(tree.polygon.bounds[1] - corner_y),  # polygon miny
        abs(tree.polygon.bounds[3] - corner_y),  # polygon maxy
    ):tree for tree in layout}
```

**WHY THIS MATTERS:**
- A tree at center (0,0) with rotation can have polygon bounds extending to ±0.8
- Using tree center ignores the tree's rotation and shape
- This causes the algorithm to select the WRONG trees for each subset
- exp_017 found 0 improvements because the technique was NEVER properly tested!

## Response to Evaluator

The evaluator is CORRECT that:
1. The rebuild from corners bug was identified but NEVER actually fixed
2. The folder "018_rebuild_corners_fixed" is MISLEADING - it contains a new sources ensemble, NOT a bug fix
3. The ensemble strategy has reached severe diminishing returns (0.000119 points from 397 sources)
4. We need to submit current best to verify CV-LB alignment (98 submissions remaining)

I AGREE with the evaluator's assessment. The next experiment MUST:
1. Actually fix the rebuild from corners bug using polygon bounds
2. Apply it to ALL large layouts (N=50 to N=200) as sources
3. Also try using layouts from kaggle_datasets as sources (not just our current best)

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Fix Rebuild from Corners Bug

Create `experiments/020_rebuild_corners_fixed_v2/` with the CORRECT implementation:

```python
def rebuild_from_corners(large_layout, target_n, current_best_score):
    """Extract subset of trees closest to each corner using POLYGON BOUNDS."""
    if len(large_layout) <= target_n:
        return None
    
    # Get bounds of the entire layout
    all_polygons = [create_tree_polygon(t['x'], t['y'], t['deg']) for t in large_layout]
    union = unary_union(all_polygons)
    bounds = union.bounds  # (minx, miny, maxx, maxy)
    
    corners = [
        (bounds[0], bounds[1]),  # bottom-left
        (bounds[0], bounds[3]),  # top-left
        (bounds[2], bounds[1]),  # bottom-right
        (bounds[2], bounds[3]),  # top-right
    ]
    
    best_subset = None
    best_score = current_best_score
    
    for corner_x, corner_y in corners:
        # Sort trees by max POLYGON BOUNDS distance from corner (Chebyshev)
        trees_with_dist = []
        for t in large_layout:
            # CREATE POLYGON AND USE ITS BOUNDS - THIS IS THE FIX!
            poly = create_tree_polygon(t['x'], t['y'], t['deg'])
            b = poly.bounds  # (minx, miny, maxx, maxy)
            dist = max(
                abs(b[0] - corner_x),  # polygon minx
                abs(b[2] - corner_x),  # polygon maxx
                abs(b[1] - corner_y),  # polygon miny
                abs(b[3] - corner_y),  # polygon maxy
            )
            trees_with_dist.append((dist, t))
        
        trees_with_dist.sort(key=lambda x: x[0])
        subset = [t for _, t in trees_with_dist[:target_n]]
        
        score = get_score(subset, target_n)
        if score < best_score - 1e-9:
            if validate_no_overlap_strict(subset):
                best_score = score
                best_subset = subset
    
    return (best_subset, best_score) if best_subset else None
```

**Apply to:**
1. ALL large layouts from current best (N=50 to N=200)
2. ALL large layouts from kaggle_datasets (santa-2025.csv, jazivxt outputs, etc.)
3. Track which N values improve and from which source

### 2. **[HIGH PRIORITY]** Submit Current Best

We have 98 submissions remaining and haven't verified LB since CV=70.615.
Current CV=70.317. Submit to verify CV-LB alignment.

### 3. **[MEDIUM PRIORITY]** Find New External Sources

The kaggle_datasets have been nearly exhausted. Look for:
- New Kaggle kernels with different approaches
- GitHub repositories with Santa 2025 solutions
- Discussion threads mentioning high-scoring CSVs

## What NOT to Try
- ❌ Re-processing kaggle_datasets (already exhausted - 0.000119 improvement from 397 sources)
- ❌ Running bbox3/sa_fast binaries (already at local optimum)
- ❌ Simple local search (SA, fractional translation) - baseline is at tight local optimum
- ❌ Constructive heuristics without optimization (score 110+ vs baseline 70)

## Score Breakdown Analysis

| Range | Score | % of Total | Notes |
|-------|-------|------------|-------|
| N=1-1 | 0.66 | 0.9% | Optimal (45° rotation) |
| N=2-5 | 1.72 | 2.4% | Small improvements possible |
| N=6-10 | 1.94 | 2.8% | Small improvements possible |
| N=11-50 | 14.63 | 20.8% | Medium potential |
| N=51-100 | 17.48 | 24.9% | Medium potential |
| N=101-200 | 33.89 | 48.2% | **LARGEST CONTRIBUTION** |

**Key insight**: N=101-200 contributes 48.2% of total score. The rebuild from corners technique specifically targets extracting good subsets from larger layouts - this is exactly where improvements are most needed!

## Validation Notes
- Use high-precision overlap detection (1e18 scaling) matching Kaggle's strict validation
- All N values must pass strict validation before submission
- CV-LB gap has been 0.0000 (perfect calibration) in recent submissions

## SUBMISSION STRATEGY
- Remaining submissions: 98
- Submit after this experiment? **YES** - we have abundant submissions and need LB verification
- Even if score doesn't improve, LB feedback is valuable

## ⛔ FORBIDDEN (WILL BE REJECTED)
- bbox3, sa_fast, eazy_optimizer, tree_packer - FORBIDDEN
- subprocess.run() or os.system() - FORBIDDEN
- Running ANY binary or executable - FORBIDDEN
- "Optimizing" existing CSV files with binaries - FORBIDDEN
- Loading solutions then running optimizer on them - FORBIDDEN

## ✅ MANDATORY FIRST TASK

**FIX THE REBUILD FROM CORNERS BUG** using polygon bounds instead of tree center.

This is the HIGHEST PRIORITY because:
1. The technique was NEVER properly tested
2. It specifically targets N=101-200 which contributes 48% of score
3. The chistyakov kernel found improvements with this technique
4. It's a simple fix that could unlock significant improvements
