# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.676102 from exp_002 (003_original_baseline)
- Best LB score: 70.676102 (CONFIRMED - passes Kaggle validation)
- Target: 68.922808 | Gap to target: 1.753294 (2.54%)

## Public Kernel Status (CRITICAL!)
- Have we implemented the best kernel yet? **NO** - jonathanchan kernel not yet implemented
- Top kernels identified:
  1. jonathanchan/santa25-ensemble-sa-fractional-translation (uses sa_v1_parallel.cpp)
  2. egortrushin/santa25-simulated-annealing-with-translations (uses grid packing + backward propagation)
  3. jazivxt/why-not (bbox3.cpp)
  4. smartmanoj/santa-claude (tree_packer_v21.cpp)
- Kernels we've implemented: Basic bbox3 (simplified version)
- Kernels still to implement: **sa_v1_parallel.cpp with fractional translation**

## Response to Evaluator

The evaluator correctly identified the critical issue: **we are not using the C++ optimizer with fractional translation**. The current bbox3.cpp only does random perturbations at 0.01-0.1 unit scale, while the top kernels use micro-adjustments at 0.00001 unit scale.

**Key points from evaluator:**
1. ✅ Correct diagnosis of precision issue - addressed by submitting original file
2. ⚠️ C++ optimizer not being used - **THIS IS THE PRIORITY**
3. ⚠️ Need more ensemble sources (19+ vs our 5)
4. ⚠️ Backward propagation not implemented

**I agree with the evaluator's assessment.** The next experiment MUST extract and run sa_v1_parallel.cpp.

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Extract and run sa_v1_parallel.cpp from jonathanchan kernel

**Location:** `/home/code/research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/santa25-ensemble-sa-fractional-translation.ipynb`

**Steps:**
1. Extract the C++ code from the notebook (it's in a cell that writes to sa_v1_parallel.cpp)
2. Compile with OpenMP:
   ```bash
   g++ -O3 -march=native -std=c++17 -fopenmp -o sa_v1_parallel sa_v1_parallel.cpp
   ```
3. Run on santa-2025.csv:
   ```bash
   ./sa_v1_parallel -i /home/code/preoptimized/santa-2025.csv -n 15000 -r 5
   ```
4. Validate output for overlaps before submitting

**Key features of sa_v1_parallel.cpp:**
- Simulated annealing with proper temperature schedule (1.0 → 0.000005)
- **Fractional translation** at micro-adjustment scales:
  - Step sizes: 0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001
  - 8 directions per step
- Population-based optimization (keeps top 3 solutions)
- Adaptive iterations based on N value
- Proper overlap detection

**Expected improvement:** 1-2 points (should get us to ~69 or below)

### 2. **[HIGH PRIORITY]** Ensemble from more sources

After running sa_v1_parallel, create ensemble from:
- sa_v1_parallel output
- santa-2025.csv (current best)
- bucket-of-chump
- telegram submissions (71.97, 72.49)
- chistyakov submission

For each N, pick the configuration with smallest bounding box.

### 3. **[MEDIUM PRIORITY]** Backward propagation

After ensemble, run backward propagation:
- For N=200 down to N=2
- Try removing each tree from N config
- If resulting (N-1) config is better than stored, save it

This is implemented in egortrushin kernel.

## What NOT to Try
- ❌ Running simplified bbox3 again (already at local optimum for coarse perturbations)
- ❌ fix_direction processing (causes precision loss leading to overlap failures)
- ❌ Multi-seed optimization without fractional translation (won't help)
- ❌ Building from scratch when proven C++ optimizer exists

## Technical Notes

### Precision Handling
- Use scale_factor = 1e15 for all geometric operations (as in egortrushin kernel)
- When saving, preserve original precision (15+ decimal places)
- The 's' prefix in coordinates is required for Kaggle submission format

### Overlap Detection
- Kaggle's overlap detection is stricter than local validation
- Use intersection area > 1e-12 threshold
- Always validate before submitting

### N=1 Optimization
- Optimal position: (0, 0, 45°) gives score 0.661250
- Current santa-2025.csv has N=1 at (-48.19, 58.77, 45°) - same score but unnecessary

## Validation Notes
- CV scheme: Score each N configuration, sum (side² / N) for N=1 to 200
- Check for overlaps using STRtree and intersection area
- Target: 68.922808 (lower is better)

## SUBMISSION STRATEGY
- Remaining submissions: 93
- Submit after this experiment? **YES** - we have abundant submissions
- LB feedback is free information - use it to calibrate

## The Path to Victory

The gap of 1.75 points IS closeable. The jonathanchan kernel achieves sub-68 scores using:
1. Fractional translation (micro-adjustments at 0.00001 scale)
2. Ensemble from 19+ sources
3. Population-based SA optimization

**The target of 68.922808 IS achievable.** We just need to implement the proven techniques.
