# Santa 2025 - Evolved Strategy (Loop 3)

## Current Status
- Best CV score: 70.676102 from santa-2025.csv (original, unmodified)
- Best LB score: FAILED (overlapping trees in group 004 due to precision loss)
- Target: 68.922808 | Gap to target: 1.75 points

## CRITICAL ISSUE: Precision Loss Caused Overlap
The previous submission failed because fix_direction reduced coordinate precision from ~18 to ~15 decimal places. Kaggle's overlap detection is stricter than ours.

**Solution:** Use original santa-2025.csv directly OR ensure any modifications preserve full precision (use Decimal with prec=25 and scale_factor=1e15 like top kernels).

## Public Kernel Status
- Have we implemented the best kernel yet? **NO** - We've only used pre-optimized submissions
- Top kernels identified:
  1. jonathanchan/santa25-ensemble-sa-fractional-translation (174 votes) - **KEY KERNEL**
  2. egortrushin/santa25-simulated-annealing-with-translations (126 votes)
  3. chistyakov/santa-2025-simple-optimization-new-slow-version (128 votes)
- Kernels we've implemented: None (only used pre-optimized CSVs)
- Kernels still to implement: **ALL OF THEM**

## Response to Evaluator
The evaluator correctly identified that:
1. **bbox3 perturbations are too coarse** (0.01-0.1 units) - CONFIRMED
2. **Need fractional translation** with micro-adjustments (0.001-0.00001 units) - AGREED
3. **Ensemble approach** - PARTIALLY USEFUL (all submissions are similar, santa-2025.csv is best for all N)
4. **Per-N analysis** - DONE (worst N values identified: N=1,2,3,5,4,7,6,9,8,15)

**NEW INSIGHT:** The precision issue is critical. Top kernels use:
- `getcontext().prec = 25`
- `scale_factor = Decimal("1e15")`
- This ensures coordinates maintain ~18+ decimal places

## Key Data Findings
1. All available pre-optimized submissions score 70.68 or worse
2. santa-2025.csv is best for all 200 N values
3. Gap to target is 1.75 points (need to reduce average side by ~0.053 units)
4. Worst-performing N values: N=1 (0.66), N=2 (0.45), N=3 (0.43), N=5 (0.42), N=4 (0.42)
5. **PRECISION IS CRITICAL** - Kaggle uses stricter overlap detection

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Submit original santa-2025.csv to establish baseline
Before any optimization, submit the unmodified santa-2025.csv to:
- Verify it passes Kaggle's overlap check
- Establish baseline LB score
- Calibrate CV-LB relationship

### 2. **[HIGH PRIORITY]** Implement C++ optimizer from jonathanchan kernel
The kernel at `research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/` contains:
- `tree_packer_v3.cpp` - Quick SA optimizer
- `tree_packer_v18.cpp` - Full parallel optimizer with:
  - Simulated annealing with proper temperature schedule
  - Fractional translation with micro-adjustments
  - Back propagation for smaller N values
  - OpenMP parallelization

**Steps:**
1. Extract the C++ code from the notebook cells
2. Compile with: `g++ -O3 -march=native -std=c++17 -fopenmp -o optimizer optimizer.cpp`
3. Run: `./optimizer -i santa-2025.csv -o submission.csv -n 150000 -r 32`
4. Validate no overlaps before submitting

### 3. **[MEDIUM PRIORITY]** Implement precision-preserving fix_direction
If we need to apply fix_direction, ensure it preserves precision:
```python
getcontext().prec = 25
scale_factor = Decimal("1e15")
# Use Decimal for all calculations
# Format output with full precision
```

### 4. **[LOWER PRIORITY]** Focus on worst-performing N values
For small N (1-20), run more iterations and rounds.

## What NOT to Try
- Running more rounds of the simple bbox3 optimizer (already at local optimum)
- Any processing that reduces coordinate precision
- Building from scratch (use proven kernel code)

## Validation Notes
- Score = Σ(s_n² / n) for n=1 to 200
- Lower is better
- **NO OVERLAPS ALLOWED** - Kaggle's check is stricter than ours
- Coordinates must be within [-100, 100]
- **PRESERVE FULL PRECISION** (~18 decimal places)

## SUBMISSION STRATEGY
- Remaining submissions: 94
- **SUBMIT original santa-2025.csv FIRST** to establish baseline
- Then submit optimized versions
- We have abundant submissions - use them for feedback!
