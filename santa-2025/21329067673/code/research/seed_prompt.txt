# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.615745 (strict ensemble in experiments/005_ensemble - NEVER SUBMITTED!)
- Best LB score: 70.676059 (exp_002, eazy optimizer)
- Target: 68.891380 | Gap to target: 1.72 points (2.44%)
- **CRITICAL**: exp_003 (70.675672) was REJECTED by Kaggle with "Overlapping trees in group 013"

## IMMEDIATE ACTION REQUIRED

### 1. LOG AND SUBMIT THE STRICT ENSEMBLE (70.615745)

The strict ensemble in `experiments/005_ensemble/submission_ensemble_strict.csv` is:
- Score: 70.615745 (0.06 points better than baseline!)
- Validated: NO overlaps with Shapely
- Status: NEVER SUBMITTED TO KAGGLE!

**DO THIS FIRST:**
```python
# Log the experiment
LogExperiment(
    name='005_strict_ensemble',
    model_type='ensemble',
    cv_score=70.615745,
    submission_path='experiments/005_ensemble/submission_ensemble_strict.csv',
    experiment_folder='experiments/005_ensemble',
    notes='Strict ensemble picks best valid config per N from 30+ CSV sources. Validated with Shapely - no overlaps. 0.06 points better than baseline.'
)
```

Then SUBMIT it to get LB feedback!

## Response to Evaluator

The evaluator correctly identified:
1. **We're stuck at a local optimum** - 4 experiments with only 0.000430 total improvement
2. **Local optimization cannot close the 1.78 point gap** - need fundamentally different approach
3. **The eazy optimizer is NOT safe** - exp_003 was rejected due to overlaps

**I AGREE with the evaluator's assessment.** However, there's an immediate opportunity:
- The strict ensemble (70.615745) was created but NEVER submitted
- This is 0.06 points better than baseline with NO overlaps
- We should submit this immediately to get LB feedback

**After submitting the ensemble, we should pivot to fundamentally different approaches:**
1. Run sa_v1_parallel for HOURS (not minutes)
2. Implement proper tessellation with lattice extraction
3. Try random restarts with different initial configurations
4. Implement backward propagation (deletion cascade)

## CV-LB Relationship Analysis

With 2 valid submissions:
- Submission 1: CV = 70.676102, LB = 70.676102 (exact match)
- Submission 2: CV = 70.676059, LB = 70.676059 (exact match)
- Submission 3: CV = 70.675672, LB = REJECTED (overlaps)

CV = LB exactly for this optimization problem. Any valid improvement in CV will directly translate to LB improvement. The issue is finding valid improvements.

## Recommended Approaches (Priority Order)

### 1. [IMMEDIATE] Submit the Strict Ensemble (70.615745)
- File: `experiments/005_ensemble/submission_ensemble_strict.csv`
- Score: 70.615745 (0.06 better than baseline)
- Validated: NO overlaps
- This is our best valid solution!

### 2. [HIGH PRIORITY] Run sa_v1_parallel for HOURS
The jonathanchan kernel runs sa_v1_parallel with:
- 15000 iterations per N
- 5-80 rounds
- Multiple generations

Our previous runs used only 4 generations. Run for HOURS:
```bash
cd experiments/003_long_sa
timeout 7200 ./sa_v1_parallel -i submission_best.csv -o submission_sa_long.csv -n 15000 -r 80
```

### 3. [HIGH PRIORITY] Implement Proper Tessellation
For large N (N >= 50), tessellation patterns can achieve better packing:
- Extract lattice parameters (dx, dy, blue_deg, pink_deg) from best solutions
- Generate tessellation configurations
- Compare with baseline, keep improvements

### 4. [MEDIUM PRIORITY] Random Restarts
- For each N, generate 10-100 random initial configurations
- Run SA on each
- Keep the best result
- This can escape the current local optimum

### 5. [MEDIUM PRIORITY] Backward Propagation (Deletion Cascade)
From chistyakov kernel:
- Start from N=200, work down to N=2
- For each N, try removing each tree that touches the bounding box
- Keep the deletion that gives best (N-1) score
- This propagates good packing patterns to smaller N

## What NOT to Try
- ❌ eazy optimizer - introduces subtle coordinate issues that Kaggle rejects
- ❌ Short SA runs (< 1 hour) - not enough time to escape local optima
- ❌ Simple grid tessellation - produces worse results than baseline
- ❌ Ensembling external CSVs alone - all are worse than baseline

## SUBMISSION STRATEGY
- Remaining submissions: 96
- Submit after EVERY valid experiment!
- LB feedback is FREE information - USE IT!

## Validation Notes
- ALWAYS validate with Shapely before submission
- Check for overlaps with area > 1e-10 threshold
- The eazy optimizer introduces subtle coordinate issues - avoid using its outputs directly

## Key Insight from Research
The jonathanchan kernel achieves good scores by:
1. Ensemble from 15+ sources (best config per N)
2. Override N=1 with optimal value (0, 0, 45°)
3. SA with fractional translation (steps 0.001-0.00001)
4. C++ optimizer sa_v1_parallel with 15000 iterations, 80 rounds

We have the ensemble (step 1). Now we need to run the SA optimizer for HOURS to refine it.
