# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.615745 from exp_004 (005_strict_ensemble) - BUT REJECTED by Kaggle
- Best LB score: 70.676059 from exp_002 (003_eazy_optimizer)
- Target: 68.890873 | Gap to target: 1.72 points (2.5%)
- **CRITICAL**: The simple ensemble (70.615745) uses baseline N=3 coordinates and should be VALID but was NEVER SUBMITTED!

## Submission History
| Experiment | CV Score | LB Score | Status |
|------------|----------|----------|--------|
| 001_baseline | 70.676102 | 70.676102 | ✓ Accepted |
| 003_eazy_optimizer | 70.676059 | 70.676059 | ✓ Accepted |
| 004_eazy_long_run | 70.675672 | REJECTED | Overlaps in N=13 |
| 005_strict_ensemble | 70.615745 | REJECTED | Overlaps in N=3 |

## Response to Evaluator

The evaluator correctly identified several critical issues:

1. **AGREE: Submit the simple ensemble immediately** - The simple ensemble (70.615745) uses baseline N=3 coordinates which were accepted by Kaggle. This is a 0.06-point improvement that should be submitted.

2. **AGREE: Expand ensemble to scan all CSVs** - Current ensemble only scans 50 CSVs out of 3340 available (98.5% unused!). This is the highest-leverage next step.

3. **AGREE: The gap is still 1.72 points** - Local optimization alone cannot close this gap. We need fundamentally different approaches.

4. **PARTIALLY AGREE: Backward propagation** - This has been tried but may not have been implemented correctly. Worth revisiting after expanding the ensemble.

## CV-LB Relationship Analysis
- CV = LB exactly (within floating point precision) for valid submissions
- This is expected for a deterministic optimization problem
- Any valid CV improvement directly translates to LB improvement
- The key challenge is avoiding overlaps that Kaggle detects but Shapely doesn't

## Recommended Approaches (Priority Order)

### 1. **[IMMEDIATE - DO FIRST]** Submit the Simple Ensemble
The simple ensemble (70.615745) in `/home/code/experiments/006_safe_ensemble/submission_simple.csv` uses baseline N=3 coordinates and should be valid. This is already in `/home/submission/submission.csv`.

**Action**: Submit exp_004 candidate (which is now the simple ensemble)

### 2. **[HIGH PRIORITY]** Expand Ensemble to Scan ALL 3340 CSVs
Current ensemble only uses 50 CSVs from 4 directories. There are 3340 CSVs across 107 directories in `/home/nonroot/snapshots/santa-2025/`.

**Implementation**:
```python
csv_dirs = ["/home/nonroot/snapshots/santa-2025/"]
all_csvs = glob.glob(csv_dirs[0] + "**/*.csv", recursive=True)
# This will find 3340 CSVs instead of 50
```

**Expected improvement**: If current ensemble found 0.06 from 50 CSVs, scanning 3340 could find 0.1-0.3 more.

### 3. **[MEDIUM PRIORITY]** Implement Proper Backward Propagation
From chistyakov kernel:
- Start from N=200, work down to N=2
- For each N, try removing each tree that touches the bounding box
- Keep the deletion that gives best (N-1) score
- This propagates good packing patterns to smaller N values

### 4. **[MEDIUM PRIORITY]** Long-Running SA on Expanded Ensemble
After expanding the ensemble, run the C++ optimizer (sa_v1_parallel) for HOURS, not minutes:
- 15000+ iterations per round
- 80+ rounds
- Multiple restarts

### 5. **[RESEARCH]** Study What Top Teams Do Differently
The gap to target (1.72 points) suggests top teams have fundamentally different configurations. Research:
- What N values do they optimize differently?
- Do they use tessellation for large N?
- Do they have special handling for small N (1-10)?

## What NOT to Try
- ❌ eazy optimizer - introduces subtle coordinate issues that Kaggle rejects
- ❌ Simple tessellation - produces worse results than baseline
- ❌ Short SA runs (< 1 hour) - baseline is already at local optimum
- ❌ Using non-baseline coordinates for N=3 - Kaggle rejects them

## Validation Notes
- Always validate with Shapely using strict threshold (area > 1e-15)
- For N values that were rejected by Kaggle (N=3, N=13), use baseline coordinates
- CV = LB for valid submissions (deterministic optimization)

## SUBMISSION STRATEGY
- Remaining submissions: 96
- **Submit after this experiment? YES - we have abundant submissions**
- The simple ensemble should be submitted immediately to get LB feedback
- After expanding ensemble, submit again to verify improvement

## Key Files
- Simple ensemble: `/home/code/experiments/006_safe_ensemble/submission_simple.csv` (70.615745)
- Current submission: `/home/submission/submission.csv` (same as simple ensemble)
- Baseline: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/santa-2025.csv` (70.676102)
- All snapshots: `/home/nonroot/snapshots/santa-2025/` (3340 CSVs across 107 directories)
