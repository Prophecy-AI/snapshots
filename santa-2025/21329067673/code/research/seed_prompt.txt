# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.615745 from strict ensemble (experiments/005_ensemble)
- Best LB score: 70.676059 (exp_002 - eazy_optimizer)
- Target: 68.891380 | Gap to target: 1.72 points (2.5%)
- **CRITICAL**: The strict ensemble (70.615745) was NEVER SUBMITTED! Submit it NOW!

## CRITICAL ISSUE: eazy optimizer produces invalid submissions
- exp_003 (eazy_long_run) was REJECTED by Kaggle: "Overlapping trees in group 013"
- Local Shapely validation passed, but Kaggle detected overlaps
- The eazy C++ optimizer introduces tiny coordinate changes that cause overlaps
- **DO NOT USE eazy optimizer outputs for submission!**

## Response to Evaluator
The evaluator correctly identified that:
1. Local optimization cannot close the 1.78-point gap (confirmed by 4 experiments)
2. The eazy optimizer was abandoned too early - but it produces INVALID submissions
3. We need fundamentally different approaches

**Key disagreement**: The evaluator suggests running sa_v1_parallel for hours. However:
- The eazy optimizer already showed that longer runs produce invalid submissions
- The strict ensemble (70.615745) is 0.06 points better than baseline with NO overlaps
- We should submit the ensemble FIRST, then try other approaches

## Immediate Action Required
1. **SUBMIT the strict ensemble** (70.615745) - it's validated and ready
2. After submission, implement deletion cascade (chistyakov kernel)
3. Try random restarts with different initial configurations

## Recommended Approaches (Priority Order)

### 1. [IMMEDIATE] Submit Strict Ensemble
- File: experiments/005_ensemble/submission_ensemble_strict.csv
- Score: 70.615745 (0.06 better than baseline)
- Validated: NO overlaps
- This is our best valid submission!

### 2. [HIGH PRIORITY] Deletion Cascade (chistyakov kernel)
The chistyakov kernel uses a clever approach:
- Start from N=200, work down to N=3
- For each N, try removing trees that touch the bounding box
- If removing a tree gives a better (N-1) configuration, use it
- This propagates good packing patterns to smaller N

Implementation:
```python
for n in range(200, 2, -1):
    trees = get_trees(n)
    touching_indices = get_bbox_touching_tree_indices(trees)
    for idx in touching_indices:
        candidate = trees[:idx] + trees[idx+1:]  # Remove tree
        if score(candidate) < best_score[n-1]:
            best_trees[n-1] = candidate
```

### 3. [HIGH PRIORITY] Random Restarts with Different Initial Configurations
The baseline is at a local optimum. To escape:
- Generate 10-100 random initial configurations for each N
- Run SA on each
- Keep the best result
- This explores different basins of attraction

### 4. [MEDIUM PRIORITY] Tessellation with Lattice Extraction
From analysis: Most common pattern is dx=0.25, dy=0.04 with Blue=63.4°, Pink=243.4°
- Extract lattice parameters from best solutions
- Generate tessellation configurations for large N (N>=50)
- Compare with baseline, keep improvements

### 5. [RESEARCH] No-Fit Polygon (NFP) Approach
- Precompute overlap-free placement regions
- Use NFP for O(1) collision checks
- Could enable more efficient search

## What NOT to Try
- ❌ eazy optimizer (produces invalid submissions)
- ❌ More local optimization on current baseline (stuck at local optimum)
- ❌ Simple tessellation (already tried, worse than baseline)
- ❌ External CSV ensemble (all sources worse than baseline)

## Validation Notes
- ALWAYS validate with Shapely before submission
- Use intersection.area > 1e-10 threshold for overlap detection
- Kaggle uses stricter validation than our local checks
- The eazy optimizer's coordinate changes cause subtle overlaps

## Score Breakdown (from analysis)
- N=1-10: 4.33 (6.1%) - worst efficiency (37-65%)
- N=11-50: 14.71 (20.8%) - medium efficiency
- N=51-200: 51.63 (73.1%) - best efficiency (~74%)

To reach target, we need to improve average efficiency from 69.51% to 71.31%.

## SUBMISSION STRATEGY
- Remaining submissions: 96
- **SUBMIT IMMEDIATELY**: strict ensemble (70.615745)
- Then continue experimenting with deletion cascade and random restarts
