# Santa 2025 - Christmas Tree Packing Optimization

## Problem Overview
Pack Christmas tree-shaped polygons (15 vertices) into the smallest square bounding box for N=1 to 200 trees. 
- **Score formula**: `sum(side_length^2 / N)` for all N from 1 to 200
- **Target score**: 68.894234 (lower is better)
- **Current best achieved**: 70.647306 (gap: 1.75 points, ~2.5%)
- **Total trees**: 20,100 (1+2+3+...+200)

## Tree Shape Specification
The tree is a 15-vertex polygon with:
- Trunk: width=0.15, height=0.2 (bottom at y=-0.2)
- Base tier: width=0.7 at y=0
- Middle tier: width=0.4 at y=0.25
- Top tier: width=0.25 at y=0.5
- Tip: at y=0.8

Vertices (TX, TY):
```python
TX = [0, 0.125, 0.0625, 0.2, 0.1, 0.35, 0.075, 0.075, -0.075, -0.075, -0.35, -0.1, -0.2, -0.0625, -0.125]
TY = [0.8, 0.5, 0.5, 0.25, 0.25, 0, 0, -0.2, -0.2, 0, 0, 0.25, 0.25, 0.5, 0.5]
```

## Key Insights from Research

### From Discussions (CRITICAL)
1. **Asymmetric vs Symmetric**: Discussion "Why the winning solutions will be Asymmetric" (38 votes) suggests asymmetric packings outperform symmetric ones for most N values
2. **Symmetric solutions**: Discussion "Symmetric solutions that are apparently optimal" (43 votes) shows some N values have provably optimal symmetric solutions
3. **Lattice/Tessellation approach**: For large N (N>=58), grid-based placement using 2 base trees translated in x/y directions achieves tighter bounds

### From Kernels
1. **bbox3 optimizer**: C++ simulated annealing with complex number vector coordination, fluid dynamics, hinge pivot, density gradient flow
2. **shake_public**: Post-processing optimizer for fine-tuning
3. **fix_direction**: Rotation optimization using ConvexHull + minimize_scalar to find optimal bounding box angle
4. **Fractional translation**: Fine-grained optimization with steps [0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001] in 8 directions

### From Academic Research
1. **No-fit polygon (NFP)**: Precompute feasible relative positions for O(1) overlap checks
2. **Jostle algorithm**: Local search heuristic for irregular shape packing
3. **Extended local search with nonlinear programming**: Combines local search with NLP for overlap minimization
4. **Genetic algorithms**: With unrestricted rotation angles
5. **Hybrid approaches**: Combining heuristics with metaheuristics perform best

## Critical Technical Requirements
1. **High precision arithmetic**: Use Decimal with 20+ decimal places to avoid overlap detection failures
2. **Overlap detection**: Use Shapely with STRtree for efficient collision detection
3. **Validation**: Always check for overlaps before submission - Kaggle rejects overlapping trees

## Recommended Approaches (Priority Order)

### 1. [HIGHEST PRIORITY] Tessellation/Lattice Approach for Large N (N >= 58)
The egortrushin kernel uses a fundamentally different approach:
- Start with 2 base trees in a specific configuration
- Translate them in x and y directions to create a grid pattern
- Use SA to optimize the base configuration and translation vectors
- Target specific N values: 72, 100, 110, 144, 156, 196, 200

```python
# For N >= 58, try crystalline packing
# nt = [rows, cols] such that rows * cols >= N
# Optimize: base tree positions, rotation angles, translation vectors
```

### 2. [HIGH PRIORITY] Long-Running Simulated Annealing
Top solutions run for HOURS, not minutes:
- `-n 15000+` iterations
- `-r 80+` rounds
- Multiple generations with perturbation to escape local optima
- Use OpenMP parallelization (26 threads available)

### 3. [HIGH PRIORITY] Backward Propagation
Start from N=200, work down to N=2:
```python
for n in range(200, 1, -1):
    for tree_to_remove in range(n):
        candidate = remove_tree(config[n], tree_to_remove)
        if score(candidate) < score(config[n-1]):
            config[n-1] = candidate
```

### 4. [MEDIUM PRIORITY] Focus on Small N Values (1-10)
These have lowest efficiency and highest score contribution:
- N=1: side=0.813, contributes 0.66 to score (already optimal at 45Â°)
- N=2: side=0.950, contributes 0.45 to score
- Try exhaustive search for optimal rotation angles

### 5. [MEDIUM PRIORITY] Ensemble from Multiple Sources
Combine best configurations from different optimization runs:
- For each N, take the configuration with smallest side length
- Validate for overlaps before combining

## What NOT to Try (Already Failed)
1. Short optimization runs (< 10 minutes) - local optimum too tight
2. Simple ensemble without validation - overlaps cause rejection
3. fix_direction without precision handling - causes precision loss
4. Backward propagation alone - doesn't escape local optima

## Implementation Notes

### ChristmasTree Class
```python
from decimal import Decimal, getcontext
from shapely import affinity
from shapely.geometry import Polygon

getcontext().prec = 30
scale_factor = Decimal("1e18")  # For high precision

class ChristmasTree:
    def __init__(self, center_x='0', center_y='0', angle='0'):
        self.center_x = Decimal(center_x)
        self.center_y = Decimal(center_y)
        self.angle = Decimal(angle)
        # Build polygon with rotation and translation
```

### Overlap Detection
```python
from shapely.strtree import STRtree

def has_overlap(trees):
    polygons = [t.polygon for t in trees]
    tree_index = STRtree(polygons)
    for i, poly in enumerate(polygons):
        indices = tree_index.query(poly)
        for idx in indices:
            if idx != i and poly.intersects(polygons[idx]) and not poly.touches(polygons[idx]):
                return True
    return False
```

### Score Calculation
```python
def calculate_score(dict_of_side_length):
    score = Decimal("0")
    for n, side in dict_of_side_length.items():
        score += side ** 2 / Decimal(str(n))
    return score
```

## Submission Format
```csv
id,x,y,deg
001_0,s0.0,s0.0,s45.0
002_0,s0.0,s0.0,s90.0
002_1,s0.202736,s-0.511271,s90.0
...
```
- Coordinates prefixed with 's' to preserve precision
- Use 20+ decimal places for coordinates

## Available Resources
- Pre-optimized submissions in `/home/nonroot/snapshots/santa-2025/`
- Best known score: 70.647306
- C++ optimizers: bbox3, tree_packer_v18, tree_packer_v21, shake_public
- Research kernels in `../research/kernels/`

## Validation Strategy
- CV = LB (perfect correlation for this optimization problem)
- Always validate for overlaps locally before submission
- Use high-precision Decimal arithmetic throughout
