# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.627589 from exp_002 (003_strict_ensemble)
- Best LB score: PENDING (previous submission failed due to overlaps)
- Target: 68.897509 | Gap to target: 1.730080 (2.45%)

## Response to Evaluator

**Technical verdict was UNRELIABLE** - The evaluator correctly identified that:
1. The executor used `intersection.area > 0` for overlap detection
2. The LB uses `intersects() and not touches()` which is STRICTER
3. The current submission had 34 groups with LB-style overlaps

**I have addressed this by:**
- Creating a truly valid ensemble using the CORRECT LB-style overlap check
- Verified 0 overlaps with `intersects() and not touches()`
- Score: 70.627589 (same as before, but now VALID)

**Evaluator's top priority**: Fix overlap validation and rebuild ensemble
- **DONE** - I rebuilt the ensemble with correct validation

**Key concerns raised**: 
1. bbox3 optimizer not being used - I tested it, but it doesn't improve the current configs (they're already locally optimal for bbox3)
2. Only chistyakov_best.csv is truly valid - INCORRECT, I found that best_snapshot.csv has 149 valid configs, ensemble_70_627.csv has 34 valid configs, etc.

## Data Understanding
- Reference notebooks: See `exploration/eda.ipynb` for tree geometry
- Key patterns: This is a 2D irregular polygon packing problem (NP-hard)
- Score = Σ(side_length² / n) for n=1 to 200 (lower is better)

## Preoptimized File Analysis (LB-style validation)
| File | Score | LB-style Overlaps |
|------|-------|-------------------|
| best_snapshot.csv | 70.627582 | 8 groups |
| better_ensemble.csv | 70.647306 | 9 groups |
| bucket_of_chump.csv | 70.676501 | 16 groups |
| chistyakov_best.csv | 70.926150 | 0 groups ✓ |
| ensemble_70_627.csv | 70.627582 | 121 groups |
| saspav_best.csv | 70.630478 | 7 groups |
| submission_70_926.csv | 70.926150 | 0 groups ✓ |

Current ensemble uses: best_snapshot.csv (149 configs), ensemble_70_627.csv (34 configs), better_ensemble.csv (9 configs), bucket_of_chump.csv (8 configs)

## Recommended Approaches (Priority Order)

### 1. SUBMIT CURRENT VALID ENSEMBLE (IMMEDIATE)
- Score: 70.627589 with 0 LB-style overlaps
- This should pass LB validation
- We need LB feedback to calibrate our CV-LB relationship
- **Reason**: We've never had a valid submission. Need to establish baseline.

### 2. Implement C++ SA Optimizer from jonathanchan kernel
The kernel at `research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/` has:
- Simulated annealing with temperature schedule (1.0 → 0.000005)
- Fractional translation (steps: 0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001)
- Multiple restarts with perturbation
- OpenMP parallelization
- Population-based optimization (keeps top 3 candidates)

**Key insight**: bbox3 didn't improve our configs, but this SA optimizer uses different move operators and finer step sizes.

### 3. Search for Better Preoptimized Submissions
- There are 1288 submission files in snapshots
- Only checked 200 so far
- Best valid one found: 70.743774 (worse than current)
- May find better ones with more thorough search

### 4. Backward Propagation
From smartmanoj kernel:
- Start from N=200, work down to N=2
- Remove trees that touch the bounding box boundary
- If removing a tree improves the (N-1) configuration, save it
- Propagates improvements from larger to smaller configurations

### 5. Rotation Optimization (fix_direction)
- Use scipy.optimize.minimize_scalar to find optimal rotation angle (0-90°)
- Rotates entire configuration to minimize bounding box side length
- Multiple passes can yield incremental improvements

## What NOT to Try
- bbox3 optimizer alone - already tested, doesn't improve current configs
- Area-based overlap detection - WRONG, must use `intersects() and not touches()`
- Ensemble from invalid configs - will fail LB validation

## Validation Strategy
**CRITICAL**: Use this EXACT overlap check to match LB:
```python
def has_lb_style_overlap(polygons):
    for i in range(len(polygons)):
        for j in range(i+1, len(polygons)):
            if polygons[i].intersects(polygons[j]) and not polygons[i].touches(polygons[j]):
                return True
    return False
```

## Implementation Notes

### Current Submission Location
- Valid submission at: `/home/submission/submission.csv`
- Score: 70.627589
- LB-style overlaps: 0

### Available Tools
- bbox3 optimizer: `/home/code/bbox3` (reads/writes submission.csv in /home/code/)
- C++ SA optimizer: Can be compiled from jonathanchan kernel
- Python optimization: Shapely for collision detection, numba for speed

### Gap Analysis
- Current: 70.627589
- Target: 68.897509
- Gap: 1.730080 (2.45%)

This gap is achievable with better optimization. The top public kernels show scores in the 68-69 range are possible.

## Next Steps
1. **SUBMIT exp_002** to get LB feedback and establish CV-LB relationship
2. If LB validates, implement C++ SA optimizer for further improvement
3. If LB rejects, investigate why and fix validation
