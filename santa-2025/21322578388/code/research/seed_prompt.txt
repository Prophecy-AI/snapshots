# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.627589 from exp_003 (003_strict_ensemble)
- Best LB score: FAILED - "Overlapping trees in group 008" (both exp_001 and exp_002)
- Target: 68.896973 | Gap to target: ~1.73 (2.45%)

## CRITICAL ISSUE IDENTIFIED

**Root Cause Analysis:**
Both submissions failed with "Overlapping trees in group 008". Investigation revealed:

1. **The LB uses scaled coordinates (1e15)**: The getting-started notebook shows `scale_factor = Decimal('1e15')`. This means a distance of 1e-15 in real coords = 1 in scaled coords.

2. **Our submissions have trees essentially touching**: 
   - best_snapshot.csv: 181 groups with min_dist < 1e-10, 8 groups with actual overlaps
   - chistyakov_best.csv: min_dist = 1e-16 (essentially 0 in scaled coords)
   - Even "valid" configs have trees at distance 1e-15 to 1e-16

3. **The LB collision detection is stricter than ours**: When trees are at distance 1e-16, after scaling by 1e15 they're at distance 0.1, which Shapely might consider as overlapping due to floating point precision.

## Response to Evaluator

**Technical verdict was UNRELIABLE** - AGREED. The evaluator correctly identified:
1. The overlap validation was WRONG
2. The LB uses `intersects() and not touches()`, not area-based checks

**However, the deeper issue is:**
- Even configs that pass `intersects() and not touches()` locally may fail on LB
- This is because the LB uses scaled coordinates (1e15) which amplifies tiny distances
- Trees at distance 1e-16 become distance 0.1 after scaling, which may be considered overlapping

**Evaluator's recommendation to use chistyakov_best.csv:**
- chistyakov_best.csv has better separation than other files
- BUT it still has min_dist = 1e-16 which might fail
- We should try submitting it to verify

## Preoptimized File Analysis

| File | Score | Min Distance | Actual Overlaps |
|------|-------|--------------|-----------------|
| best_snapshot.csv | 70.627582 | 0.00e+00 | 8 groups |
| better_ensemble.csv | 70.647306 | 0.00e+00 | 7 groups |
| bucket_of_chump.csv | 70.676501 | 0.00e+00 | 16 groups |
| chistyakov_best.csv | 70.926150 | 1.09e-16 | 0 groups |
| ensemble_70_627.csv | 70.627582 | 0.00e+00 | 121 groups |
| saspav_best.csv | 70.630478 | 0.00e+00 | 7 groups |
| sample_submission.csv | 173.652299 | 4.09e-05 | 0 groups |

**Key insight**: sample_submission.csv has much better separation (4e-5) but terrible score. chistyakov_best.csv is the best balance of score and separation.

## Recommended Approaches (Priority Order)

### 1. SUBMIT chistyakov_best.csv (IMMEDIATE)
- Score: 70.926150 (worse than our ensemble but might pass LB)
- Has 0 actual overlaps and better separation than other files
- We need LB feedback to understand if the issue is precision or something else
- **Current submission is chistyakov_best.csv**

### 2. If chistyakov passes, create hybrid submission
- Use chistyakov_best.csv as base
- For groups where best_snapshot is significantly better AND has good separation, use best_snapshot
- This could improve score while maintaining validity

### 3. If chistyakov fails, investigate further
- The LB might use different tree geometry or precision
- Check if there's a minimum separation requirement
- Look for submissions in snapshots with better separation

### 4. Implement tree separation optimizer
- For each group, slightly move trees apart to create minimum separation
- Use gradient descent or simulated annealing to minimize bounding box while maintaining separation
- Target minimum separation of 1e-10 or higher

### 5. Use bbox3 with separation constraint
- Modify bbox3 or create wrapper that enforces minimum separation
- This could optimize while ensuring validity

## What NOT to Try
- Scaling trees toward center (creates overlaps)
- Using best_snapshot.csv directly (has actual overlaps)
- Area-based overlap detection (doesn't match LB)

## Validation Strategy
**CRITICAL**: The LB uses:
1. Scaled coordinates: `scale_factor = Decimal('1e15')`
2. Collision detection: `intersects() and not touches()`
3. High precision Decimal arithmetic

To match LB validation locally:
```python
from decimal import Decimal, getcontext
getcontext().prec = 25
scale_factor = Decimal('1e15')

# Scale coordinates before collision check
scaled_poly = affinity.scale(poly, xfact=float(scale_factor), yfact=float(scale_factor), origin=(0,0))
```

## Current Submission
- File: `/home/submission/submission.csv` (chistyakov_best.csv)
- Score: 70.926150
- Target: 68.896973
- Gap: 2.029177 (2.94%)

## Gap Analysis
- Current best valid: 70.926150 (chistyakov_best.csv)
- Target: 68.896973
- Gap: 2.029177 (2.94%)

This gap is larger than before (was 1.73 with invalid submission), but we need a VALID submission first. Once we have LB feedback, we can iterate to improve.

## Next Steps
1. **Submit chistyakov_best.csv** to verify it passes LB validation
2. If it passes, create hybrid submission to improve score
3. If it fails, investigate the exact LB validation requirements
4. Implement tree separation optimizer if needed
