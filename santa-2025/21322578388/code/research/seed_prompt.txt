# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.633168 from valid_hybrid (exp_004 analysis)
- Best LB score: N/A (both previous submissions failed with "Overlapping trees in group 008")
- Target: 68.896973 | Gap to target: 1.736195

## CRITICAL DISCOVERY: LB Overlap Validation

**The LB uses `int(x * 1e15)` scaling for coordinates before overlap detection!**

This means:
- Tiny overlaps (1e-32 area) that are undetectable at normal precision become visible
- ALL preoptimized files except sample_submission.csv have overlaps when checked with scaled coordinates
- Previous submissions failed because they had configs with microscopic overlaps

**Preoptimized File Status (with scaled overlap check):**
| File | Score | Scaled Overlaps | Valid? |
|------|-------|-----------------|--------|
| sample_submission.csv | 173.65 | 0 | ✓ YES |
| chistyakov_best.csv | 70.926 | 1 (group 2) | ✗ NO |
| best_snapshot.csv | 70.628 | 30 | ✗ NO |
| ensemble_70_627.csv | 70.628 | 120 | ✗ NO |
| All others | ~70.6-70.9 | 30-120 | ✗ NO |

## Response to Evaluator

The evaluator correctly identified that the experiment output didn't match the intended result. The issue was deeper than expected:
- The hybrid approach was selecting configs that passed `intersects() and not touches()` at normal precision
- But the LB uses SCALED coordinates (1e15), which reveals microscopic overlaps
- I've now created a valid hybrid (70.633168) using the correct scaled overlap check

## Data Understanding

Reference notebooks:
- `exploration/evolver_loop4_analysis.ipynb` - Discovered scaled coordinate overlap issue
- `research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/` - bbox3 optimization strategy

Key patterns:
1. The LB scales coordinates by 1e15 before overlap detection
2. Trees that "touch" at normal precision may "overlap" at scaled precision
3. Only sample_submission.csv is truly valid, but has terrible score
4. Created valid hybrid by selecting only configs that pass scaled overlap check

## Recommended Approaches (Priority Order)

### 1. IMMEDIATE: Submit the Valid Hybrid (exp_005)
- Score: 70.633168
- Verified 0 overlaps with scaled coordinates
- This should pass LB validation and establish a baseline

### 2. Use bbox3 Optimizer
The bbox3 binary is available at `/home/code/bbox3`. From the kernel analysis:
```bash
./bbox3 -n 1000 -r 30  # Short run (2 min)
./bbox3 -n 2000 -r 60  # Medium run (10 min)
```
Key parameters:
- `-n`: Number of iterations
- `-r`: Number of restarts

Strategy:
1. Start with the valid hybrid as input
2. Run bbox3 to optimize
3. Verify output has 0 scaled overlaps
4. If overlaps exist, replace invalid configs with valid ones from sample_submission.csv

### 3. Fix Direction Optimization
From the kernel, the `fix_direction` function optimizes rotation angles:
- Uses convex hull of all tree vertices
- scipy.optimize.minimize_scalar to find optimal rotation (0-90°)
- Can reduce bounding box size by rotating entire configuration

### 4. Repair Overlaps Strategy
When bbox3 creates overlaps:
1. Check each config with scaled coordinates
2. If overlap detected, replace with valid config from sample_submission.csv
3. This ensures LB validity at cost of some score

## What NOT to Try

1. ❌ Creating hybrids without scaled overlap check - will fail LB
2. ❌ Using chistyakov_best.csv directly - has overlap in group 2
3. ❌ Using any preoptimized file directly - all have scaled overlaps
4. ❌ Checking overlaps with `intersection.area > 0` - wrong method

## Validation Notes

**CRITICAL: Always verify with scaled coordinates:**
```python
scale_factor = int(1e15)
def create_tree_polygon_scaled(x, y, deg):
    # ... rotate and translate ...
    scaled = (translated * scale_factor).astype(np.int64)
    return Polygon(scaled)

# Check overlap
if p1.intersects(p2) and not p1.touches(p2):
    # THIS IS AN OVERLAP
```

## Next Steps

1. **Submit exp_005 (valid hybrid)** to verify LB validation passes
2. **Run bbox3 optimization** on the valid hybrid
3. **Implement repair strategy** to fix any overlaps bbox3 creates
4. **Target score**: Need to reduce from 70.633 to 68.897 (gap of 1.74)

## Technical Notes

- bbox3 binary: `/home/code/bbox3`
- Valid baseline: `/home/code/experiments/005_valid_hybrid/submission.csv`
- Sample submission (fallback): `/home/code/preoptimized/sample_submission.csv`
