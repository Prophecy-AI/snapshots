# Santa 2025 - Christmas Tree Packing: Evolved Seed Prompt (Loop 3)

## Current Status
- Best CV score: 70.627589 from strict ensemble (003_strict_ensemble)
- Best LB score: N/A (previous submission failed due to overlaps)
- Target: 68.897509 | Gap to target: 1.73 points (2.5%)
- **CRITICAL FIX APPLIED**: Now using STRICT overlap detection (zero intersection area)

## CRITICAL FINDING: LB Overlap Detection

**The LB uses STRICT overlap detection:**
- Any intersection area > 0 is considered an overlap
- Shapely's `touches()` method is NOT sufficient
- Even areas of 1e-25 are rejected by the LB
- Must check: `poly_i.intersection(poly_j).area == 0` for all pairs

**Previous failure analysis:**
- ensemble_70_627.csv had 120 groups with tiny overlaps (1e-25 to 1e-13)
- Our local validation passed because we used `touches()` which allows tiny intersections
- LB rejected with "Overlapping trees in group 008"

**Solution:**
- Created strict ensemble using only configurations with ZERO intersection area
- chistyakov_best.csv has 0 overlaps and is truly valid (score: 70.926150)
- Strict ensemble achieves 70.627589 with 0 overlaps

## Response to Evaluator
- Technical verdict was **TRUSTWORTHY** - but we discovered a critical validation gap
- Evaluator's top priority: Submit to LB - AGREE, but first we fixed the overlap issue
- Key concerns raised:
  1. No LB submission yet - FIXED: Now have valid submission ready
  2. fix_direction not implemented - Still valid, should implement
  3. C++ optimizers not compiled - Still valid priority
- **My response**: 
  1. SUBMIT the strict ensemble (70.627589) to verify it passes LB validation
  2. Then focus on optimization to close the 1.73 point gap

## Data Understanding
- Reference notebooks: See `exploration/evolver_loop2_analysis.ipynb` for overlap analysis
- Key insight: LB uses stricter overlap detection than Shapely's touches()
- Valid sources: chistyakov_best.csv (0 overlaps), better_ensemble.csv (mostly valid)
- Current best: `/home/submission/submission.csv` (strict ensemble, 70.627589, 0 overlaps)

## Recommended Approaches (Priority Order)

### Priority 1: SUBMIT STRICT ENSEMBLE TO LB
- Submit the strict ensemble (70.627589) to verify it passes LB validation
- This is critical to confirm our overlap fix works
- Uses 1 of 99 remaining submissions

### Priority 2: Expand Source Pool for Strict Ensemble
- Current ensemble uses only 7 source files
- There are 3084+ submission files in `/home/nonroot/snapshots/santa-2025/`
- Create mega-ensemble from ALL sources, using STRICT overlap validation
- Expected improvement: 0.1-0.5 points

### Priority 3: Implement fix_direction Rotation Optimization
From saspav kernel:
```python
def optimize_rotation(polygons):
    # Get convex hull of all tree vertices
    all_points = np.vstack([np.array(p.exterior.coords) for p in polygons])
    hull = ConvexHull(all_points)
    hull_points = all_points[hull.vertices]
    
    # Find optimal rotation angle (0-90 degrees)
    def bbox_at_angle(angle):
        cos_a, sin_a = np.cos(angle), np.sin(angle)
        rotated = hull_points @ np.array([[cos_a, -sin_a], [sin_a, cos_a]]).T
        return max(rotated[:, 0].max() - rotated[:, 0].min(),
                   rotated[:, 1].max() - rotated[:, 1].min())
    
    res = minimize_scalar(bbox_at_angle, bounds=(0, np.pi/2), method='bounded')
    return res.x, res.fun
```
Apply to each N configuration and keep if improvement > 0.

### Priority 4: Run C++ Optimizer (bbox3)
- bbox3 binary is available at `/home/code/bbox3`
- Run on configurations that have room for improvement
- Focus on small N (1-50) for highest leverage

### Priority 5: Backward Propagation
- Start from N=200, work down to N=2
- Remove trees that touch the bounding box boundary
- If removing a tree improves the (N-1) configuration, save it

## What NOT to Try
- ❌ Using Shapely's `touches()` for overlap validation (too lenient)
- ❌ Accepting any intersection area > 0 (LB will reject)
- ❌ Python-based repair algorithms (counterproductive)
- ❌ Starting from scratch (we have good baseline)

## Validation Notes
- **STRICT overlap check**: `poly_i.intersection(poly_j).area == 0` for all pairs
- CV = LB exactly for this competition (pure optimization)
- Use original string precision from source files (don't transform values)
- Submission format: values prefixed with 's'

## Implementation Steps for Next Experiment

### Experiment 003: Submit Strict Ensemble
1. **Verify submission format** - Check `/home/submission/submission.csv`
2. **Submit to LB** - Verify score matches CV (70.627589)
3. **If successful**: Proceed to mega-ensemble and optimization
4. **If failed**: Debug overlap detection further

### Experiment 004: Mega-Ensemble from All Snapshots
1. **Load all 3084+ submissions** from `/home/nonroot/snapshots/santa-2025/`
2. **For each N, find best STRICTLY valid configuration** (zero intersection area)
3. **Calculate score** - Expected improvement: 0.1-0.5 points
4. **Submit if better** than current best

### Expected Outcome
- Strict ensemble: 70.627589 (should pass LB validation)
- Mega-ensemble: ~70.1-70.4 (0.2-0.5 point improvement)
- With optimization: ~69.5-70.0 (additional 0.5-1.0 point improvement)
- Target: 68.897509 (1.73 points away)

## Critical Files
- Current best: `/home/submission/submission.csv` (strict ensemble, 70.627589)
- Valid source: `/home/code/preoptimized/chistyakov_best.csv` (0 overlaps)
- All snapshots: `/home/nonroot/snapshots/santa-2025/`
- bbox3 binary: `/home/code/bbox3`

## Score Breakdown Target
To reach 68.897509 from 70.627589, we need to reduce score by 1.73 points.
- If spread evenly across 200 configs: 0.00865 per config
- If focused on small N (1-50): 0.0346 per config
- This is achievable with systematic optimization + mega-ensemble
