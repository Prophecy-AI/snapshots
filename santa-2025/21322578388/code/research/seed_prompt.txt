# Santa 2025 - Christmas Tree Packing: Evolved Seed Prompt (Loop 2)

## Current Status
- Best CV score: 73.938014 from exp_000 (001_baseline) - but this is INVALID due to repair algorithm
- Best LB score: N/A (no submissions yet)
- Target: 68.901319 | Gap to target: ~5 points (7.3%)
- **CRITICAL**: Found pre-optimized submissions in snapshots with score 70.627582 (valid, no overlaps)

## Response to Evaluator
- Technical verdict was **TRUSTWORTHY** - the repair algorithm works but is counterproductive
- Evaluator's top priority: **Implement fix_direction rotation optimization** - AGREE, but we have a better path
- Key concerns raised: 
  1. Repair algorithm pushes trees apart (increases score) - CORRECT, this is the wrong approach
  2. Python-based optimization can't compete with C++ - CORRECT
  3. fix_direction not implemented - We should use pre-optimized submissions instead
- **My response**: Instead of building from scratch, we should leverage the pre-optimized submissions found in snapshots (score 70.627582) and apply C++ optimization on top

## Key Strategic Insight
The baseline submission at `exploration/baseline_submission.csv` has 11 overlapping configurations. The repair algorithm made it valid but worse (73.94 vs 70.63). 

**BETTER APPROACH**: Use the ensemble submission from snapshots (70.627582) which is already valid and well-optimized. Then apply:
1. C++ simulated annealing (sa_v1_parallel from jonathanchan kernel)
2. Fractional translation (very fine moves: 0.001, 0.0005, etc.)
3. Rotation tightening (fix_direction)

## Data Understanding
- Reference notebooks: See `research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`
- Pre-optimized submissions available at `/home/code/preoptimized/`:
  - `ensemble_70_627.csv` - Score 70.627582, valid (no overlaps)
  - `saspav_best.csv` - Score 70.63, has 9 overlaps
  - `chistyakov_best.csv` - Score 70.93, valid
- Key patterns: Small N values (1-10) have highest leverage for score improvement

## Recommended Approaches (Priority Order)

### Priority 1: Use Pre-optimized Ensemble as Baseline
1. Copy `/home/code/preoptimized/ensemble_70_627.csv` as the new baseline
2. Verify no overlaps
3. Calculate score breakdown by N range
4. This immediately gives us score 70.627582 (gap: 1.73 points to target)

### Priority 2: Compile and Run C++ Optimizer
From `research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`:
1. Extract the sa_v1_parallel.cpp code
2. Compile with: `g++ -O3 -march=native -std=c++17 -fopenmp -o sa_v1_parallel sa_v1_parallel.cpp`
3. Run: `./sa_v1_parallel -i submission.csv -n 15000 -r 5`
4. Key features:
   - Simulated annealing with temperature schedule
   - Fractional translation (moves of 0.001, 0.0005, 0.0002, 0.0001, etc.)
   - Local search with 8-directional moves
   - Multi-restart with population of 3 best solutions

### Priority 3: Ensemble from Multiple Sources
The jonathanchan kernel shows how to combine best configs from 19+ sources:
1. Load all available pre-optimized submissions
2. For each N=1-200, pick the configuration with lowest score AND no overlaps
3. This can find better solutions than any single source

### Priority 4: Focus on Small N Values
Small N has highest leverage:
- N=1: 0.1 side reduction saves 0.108 points
- N=200: 0.1 side reduction saves only 0.008 points
- Focus optimization on N=1-50 first

## What NOT to Try
- ❌ Python-based repair algorithms (too slow, counterproductive)
- ❌ Simple local search without temperature (gets stuck in local optima)
- ❌ Starting from sample_submission.csv (score 173.65, too far from target)
- ❌ Pushing overlapping trees apart (increases bounding box)

## Validation Notes
- CV = LB exactly for this competition (pure optimization, no distribution shift)
- Always check for overlaps before submission using Shapely
- Use high precision (15+ decimal places) for coordinates
- Submission format: values prefixed with 's' (e.g., "s0.123456789012345")

## Implementation Steps for Next Experiment

1. **Copy pre-optimized baseline**:
   ```bash
   cp /home/code/preoptimized/ensemble_70_627.csv /home/code/experiments/002_cpp_optimizer/baseline.csv
   ```

2. **Extract and compile C++ optimizer** from jonathanchan kernel

3. **Run optimizer**:
   ```bash
   ./sa_v1_parallel -i baseline.csv -n 20000 -r 10
   ```

4. **Validate and save best result**

5. **Apply rotation tightening** (fix_direction) as post-processing

## Expected Outcome
- Starting from 70.627582
- C++ SA + fractional translation: expect 0.5-1.5 point improvement
- Target: 68.901319 (gap: 1.73 points)
- This is achievable with systematic optimization

## Critical Files
- Pre-optimized submissions: `/home/code/preoptimized/`
- C++ optimizer source: `research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`
- bbox3 optimizer: `research/kernels/jazivxt_why-not/` (contains bbox3.cpp)
