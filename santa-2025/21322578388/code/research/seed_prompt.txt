# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.926150 from chistyakov_best.csv (VALID - 0 overlaps)
- Best LB score: N/A (all 3 submissions failed with "Overlapping trees in group 008")
- Target: 68.896973 | Gap to target: 2.029177

## CRITICAL ISSUE - ALL SUBMISSIONS FAILED

All 3 submissions failed with "Overlapping trees in group 008". The root cause:
- The executor created hybrid submissions by parsing coordinates as floats and reformatting them
- This precision change caused the LB to detect overlaps that weren't present in the original files
- The LB uses `intersects() and not touches()` with `scale_factor = 1e15` for coordinates

## Response to Evaluator

**Technical verdict was UNRELIABLE** - The evaluator correctly identified that the experiment output didn't match the intended result. The notebook showed copying chistyakov_best.csv but the actual submission file was a hybrid with overlaps.

**Evaluator's top priority**: Submit chistyakov_best.csv directly. **AGREED** - This is the only path forward.

**Key concerns raised**:
1. Experiment output is INVALID - Addressed by copying chistyakov_best.csv directly
2. Disconnect between notebook and output - Will verify file hashes match
3. Score gap is large (2.03) - Will need optimization after getting valid baseline
4. No optimization attempted - Will use bbox3 after establishing valid baseline

## Data Understanding

Reference notebooks:
- `exploration/evolver_loop4_analysis.ipynb` - Analyzed overlap detection methods
- `exploration/evolver_loop4_check_snapshots.ipynb` - Checked all snapshot files for valid submissions

Key findings:
1. **LB overlap detection**: Uses `intersects() and not touches()` with Decimal precision and scale_factor=1e15
2. **Valid preoptimized files**: ONLY chistyakov_best.csv and submission_70_926.csv have 0 overlaps (both score 70.926)
3. **All other files have overlaps**: best_snapshot.csv (2), better_ensemble.csv (13), bucket_of_chump.csv (11), ensemble_70_627.csv (120), saspav_best.csv (9)
4. **Precision is critical**: Parsing and reformatting coordinates changes precision and can cause overlaps

## Recommended Approaches

### IMMEDIATE PRIORITY: Get a Valid Submission

1. **Copy chistyakov_best.csv DIRECTLY to submission** - No parsing, no reformatting
   ```python
   import shutil
   shutil.copy('/home/code/preoptimized/chistyakov_best.csv', '/home/submission/submission.csv')
   ```

2. **Verify the copy is byte-for-byte identical**
   ```python
   import hashlib
   def file_hash(filepath):
       with open(filepath, 'rb') as f:
           return hashlib.md5(f.read()).hexdigest()
   assert file_hash('/home/code/preoptimized/chistyakov_best.csv') == file_hash('/home/submission/submission.csv')
   ```

3. **Expected outcome**: Score of 70.926150, which will pass LB validation

### AFTER GETTING VALID BASELINE: Optimize

4. **Use bbox3 optimizer** to improve configurations
   - The bbox3 binary is available in research/kernels
   - It uses simulated annealing with complex number geometry
   - Run on chistyakov_best.csv to improve while maintaining validity

5. **Use backward propagation** technique
   - Start from N=200, work down to N=2
   - Remove trees that touch the bounding box boundary
   - Propagate improvements from larger to smaller configurations

6. **Use fix_direction** rotation optimization
   - Find optimal rotation angle for entire configuration
   - Uses convex hull and scipy.optimize.minimize_scalar

## What NOT to Try

- ❌ **Creating hybrid submissions** by parsing and reformatting coordinates - This changes precision and causes overlaps
- ❌ **Using best_snapshot.csv, better_ensemble.csv, etc.** - These have overlaps
- ❌ **Any approach that parses coordinates as floats** - Precision loss causes overlaps

## Validation Notes

- **ALWAYS verify submission file has 0 overlaps** before submitting
- **Use byte-for-byte comparison** when copying files
- **The LB uses Decimal precision with scale_factor=1e15** - Our local checks must match this exactly

## Key Insight

The problem is NOT the overlap detection algorithm - it's the PRECISION. When we parse coordinates as floats and reformat them, we lose precision. The LB uses Decimal precision with 25 digits, and any precision loss can cause trees that were just touching to now overlap.

The ONLY safe approach is to copy valid files DIRECTLY without any modification.

## IMPORTANT: Submission File Already Prepared

I have already copied chistyakov_best.csv directly to /home/submission/submission.csv and verified the files are byte-for-byte identical (MD5: c2813ec6c53c9c19f99df440022120d0).

The experiment folder is /home/code/experiments/005_chistyakov_direct with the same file.

**NEXT STEP**: Log this as experiment 005_chistyakov_direct with CV score 70.926150 and submit it to get LB feedback.
