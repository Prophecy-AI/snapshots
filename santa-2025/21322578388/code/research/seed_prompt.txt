# Santa 2025 - Christmas Tree Packing: Evolved Seed Prompt (Loop 3)

## Current Status
- Best CV score: 70.627589 from exp_001 (002_preoptimized_baseline)
- Best LB score: N/A (no submissions yet - NEED TO SUBMIT!)
- Target: 68.897509 | Gap to target: 1.73 points (2.5%)
- **CRITICAL**: We have 100 submissions available - use them for LB verification!

## Response to Evaluator
- Technical verdict was **TRUSTWORTHY** - the ensemble approach is sound
- Evaluator's top priority: **Submit to LB + Compile C++ optimizer** - FULLY AGREE
- Key concerns raised:
  1. No LB submission yet - MUST FIX IMMEDIATELY
  2. fix_direction not implemented - Valid, should implement
  3. C++ optimizers not compiled - Valid, but pre-compiled binaries exist!
  4. Small N values have highest leverage - AGREE, focus there
- **My response**: 
  1. SUBMIT IMMEDIATELY to verify LB score matches CV
  2. Use pre-compiled bbox3 binary (found at /home/code/bbox3)
  3. Create mega-ensemble from 3084 available submissions in snapshots
  4. Implement fix_direction for rotation optimization

## Key Strategic Insight
The current ensemble (70.627589) is already better than most pre-optimized submissions. The gap to target is 1.73 points. Key opportunities:

1. **Mega-ensemble**: There are 3084 submission files in snapshots. Creating an ensemble from ALL of them could find better configurations for each N.

2. **C++ Optimization**: bbox3 binary is available and working. However, it showed no improvement on current submission - we may be at a local optimum for this optimizer.

3. **fix_direction**: Rotation optimization can provide incremental improvements by finding optimal rotation angle for each configuration.

4. **Focus on small N**: Score contribution = side²/n, so small N values have highest leverage.

## Data Understanding
- Reference notebooks: See `research/kernels/saspav_santa-submission/` for fix_direction implementation
- Pre-compiled binaries: `/home/code/bbox3` (working)
- Current best: `/home/submission/submission.csv` (score 70.627589, valid)
- 3084 submission files available in `/home/nonroot/snapshots/santa-2025/`

## Recommended Approaches (Priority Order)

### Priority 1: SUBMIT TO LB IMMEDIATELY
- Submit exp_001 (002_preoptimized_baseline) to verify LB score
- This is a pure optimization problem - CV should equal LB exactly
- Uses 1 of 100 submissions, gives us calibration data

### Priority 2: Create Mega-Ensemble from ALL Snapshots
1. Load all 3084 submission files from snapshots
2. For each N=1-200, find the configuration with:
   - Lowest bounding box side length
   - No overlaps (valid)
3. This could find better configurations than our current ensemble
4. Expected improvement: 0.1-0.5 points

### Priority 3: Implement fix_direction Rotation Optimization
From saspav kernel:
```python
def optimize_rotation(trees):
    # Get convex hull of all tree vertices
    all_points = [list(tree.polygon.exterior.coords) for tree in trees]
    hull_points = ConvexHull(np.array(all_points)).vertices
    
    # Find optimal rotation angle (0-90 degrees)
    res = minimize_scalar(
        lambda a: calculate_bbox_side_at_angle(a, hull_points),
        bounds=(0.001, 89.999), method='bounded'
    )
    return res.x, res.fun
```
Apply to each N configuration and keep if improvement > epsilon.

### Priority 4: Run bbox3 on Configurations with Room for Improvement
- bbox3 showed no improvement on current submission
- Try running on individual N configurations that have larger gaps
- Focus on N=1-50 (highest leverage)

### Priority 5: Fractional Translation
From jonathanchan kernel:
- Very fine moves: 0.001, 0.0005, 0.0002, 0.0001
- Apply to boundary trees (those defining the bounding box)
- Can squeeze out small improvements

## What NOT to Try
- ❌ Python-based repair algorithms (counterproductive)
- ❌ Starting from scratch (we have good baseline)
- ❌ Random search (too slow, not targeted)
- ❌ Pushing overlapping trees apart (increases bounding box)

## Validation Notes
- CV = LB exactly for this competition (pure optimization)
- Always check for overlaps before submission using Shapely
- Use high precision (15+ decimal places) for coordinates
- Submission format: values prefixed with 's'

## Implementation Steps for Next Experiment

### Experiment 003: Mega-Ensemble + fix_direction
1. **Load all 3084 submissions** from snapshots
2. **Create mega-ensemble**: For each N, pick best valid configuration
3. **Apply fix_direction** to each configuration
4. **Validate no overlaps**
5. **Calculate final score**
6. **Submit if better than current best**

### Expected Outcome
- Starting from 70.627589
- Mega-ensemble: expect 0.1-0.3 point improvement
- fix_direction: expect 0.05-0.2 point improvement
- Combined: expect 0.2-0.5 point improvement
- New score: ~70.1-70.4 (still 1.2-1.5 points from target)

### Remaining Gap Strategy
If mega-ensemble + fix_direction doesn't reach target:
1. **C++ SA with longer runs**: Run sa_v1_parallel for hours
2. **Backward propagation**: Use N=200 to improve smaller N
3. **Manual optimization**: Focus on specific N values with large gaps
4. **Research winning solutions**: Check if there are better techniques

## Critical Files
- Current best: `/home/submission/submission.csv` (70.627589)
- bbox3 binary: `/home/code/bbox3`
- All snapshots: `/home/nonroot/snapshots/santa-2025/`
- fix_direction code: `research/kernels/saspav_santa-submission/`

## Score Breakdown Target
To reach 68.897509 from 70.627589, we need to reduce score by 1.73 points.
- If spread evenly across 200 configs: 0.00865 per config
- If focused on small N (1-50): 0.0346 per config
- This is achievable with systematic optimization
