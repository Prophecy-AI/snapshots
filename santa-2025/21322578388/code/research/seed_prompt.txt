# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.627589 from exp_003 (003_strict_ensemble)
- Best LB score: FAILED (overlapping trees in group 008)
- Target: 68.896973 | Gap to target: 1.730616 (2.45%)

## CRITICAL ISSUE IDENTIFIED AND FIXED

**The Problem:**
- Previous experiments used `intersection.area > 0` for overlap detection
- The LB uses `intersects() and not touches()` which is DIFFERENT
- Even tiny floating point precision differences (1e-16) can cause `intersects()=True, touches()=False` when `area=0`
- The previous submission had 33 groups with LB-style overlaps despite claiming 0

**The Fix:**
- Rebuilt ensemble by copying EXACT strings from source files (no parsing/reformatting)
- Verified with LB-style overlap check: `intersects() and not touches()`
- New submission has 0 LB-style overlaps
- Score: 70.627589 (same as before, but now VALID)

## Response to Evaluator

**Technical verdict was UNRELIABLE** - AGREED. The evaluator correctly identified:
1. The overlap validation was WRONG
2. The LB uses `intersects() and not touches()`, not area-based checks
3. The submission had overlaps that our check missed

**Actions taken:**
1. ✅ Fixed overlap validation to use EXACT LB check
2. ✅ Rebuilt ensemble by copying exact strings (avoids precision loss)
3. ✅ Verified 0 LB-style overlaps in new submission

**Evaluator's recommendation to use chistyakov_best.csv as fallback:**
- PARTIALLY CORRECT - chistyakov_best.csv is the only file with 0 overlaps
- BUT: By copying exact strings, we can use configs from other files that pass the LB check
- Result: Better score (70.627589) than chistyakov alone (70.926150)

## Data Understanding
- Reference notebooks: See `exploration/eda.ipynb` for tree geometry
- This is a 2D irregular polygon packing problem (NP-hard)
- Score = Σ(side_length² / n) for n=1 to 200 (lower is better)

## Preoptimized File Analysis (LB-style validation)
| File | Score | LB-style Overlaps |
|------|-------|-------------------|
| best_snapshot.csv | 70.627582 | 8 groups |
| better_ensemble.csv | 70.647306 | 9 groups |
| bucket_of_chump.csv | 70.676501 | 16 groups |
| chistyakov_best.csv | 70.926150 | 0 groups ✓ |
| ensemble_70_627.csv | 70.627582 | 121 groups |
| saspav_best.csv | 70.630478 | 7 groups |
| submission_70_926.csv | 70.926150 | 0 groups ✓ |

Current ensemble sources: best_snapshot.csv (86 configs), better_ensemble.csv (71 configs), ensemble_70_627.csv (35 configs), bucket_of_chump.csv (8 configs)

## Recommended Approaches (Priority Order)

### 1. SUBMIT CURRENT VALID ENSEMBLE (IMMEDIATE)
- Score: 70.627589 with 0 LB-style overlaps
- This should pass LB validation
- We need LB feedback to establish baseline
- **Reason**: We've never had a successful submission. Need to verify our validation is correct.

### 2. Implement C++ SA Optimizer
The kernel at `research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/` has:
- Simulated annealing with temperature schedule (1.0 → 0.000005)
- Fractional translation (steps: 0.001 down to 0.00001)
- Multiple restarts with perturbation
- OpenMP parallelization
- Population-based optimization (keeps top 3 candidates)

**Key insight**: bbox3 didn't improve our configs, but this SA optimizer uses different move operators and finer step sizes.

### 3. Search More Snapshot Submissions
- There are 1288 submission files in snapshots
- Only checked 200 so far
- May find better valid configs with more thorough search

### 4. Backward Propagation
From smartmanoj kernel:
- Start from N=200, work down to N=2
- Remove trees that touch the bounding box boundary
- Propagates improvements from larger to smaller configurations

### 5. Rotation Optimization (fix_direction)
- Use scipy.optimize.minimize_scalar to find optimal rotation angle (0-90°)
- Rotates entire configuration to minimize bounding box side length

## What NOT to Try
- bbox3 optimizer alone - already tested, doesn't improve current configs
- Area-based overlap detection - WRONG, must use `intersects() and not touches()`
- Reformatting CSV values - causes precision loss that can create overlaps

## Validation Strategy
**CRITICAL**: Use this EXACT overlap check to match LB:
```python
def has_lb_style_overlap(polygons):
    for i in range(len(polygons)):
        for j in range(i+1, len(polygons)):
            if polygons[i].intersects(polygons[j]) and not polygons[i].touches(polygons[j]):
                return True
    return False
```

**CRITICAL**: When building ensemble, copy EXACT strings from source files:
```python
# DON'T do this (causes precision loss):
submission[col] = 's' + submission[col].apply(lambda x: f'{x:.15f}')

# DO this instead:
with open(source_file, 'r') as f:
    lines = f.readlines()
# Copy lines directly without parsing
```

## Current Submission Location
- Valid submission at: `/home/submission/submission.csv`
- Score: 70.627589
- LB-style overlaps: 0 (verified)
- Experiment folder: `/home/code/experiments/004_lb_valid_ensemble/`

## Gap Analysis
- Current: 70.627589
- Target: 68.896973
- Gap: 1.730616 (2.45%)

This gap is achievable with better optimization. The top public kernels show scores in the 68-69 range are possible.

## Next Steps
1. **SUBMIT current ensemble** to verify LB validation is correct
2. If LB validates, implement C++ SA optimizer for further improvement
3. If LB rejects, investigate the specific failing group and fix
