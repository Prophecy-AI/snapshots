# Santa 2025 - Christmas Tree Packing Challenge Seed Prompt

## Problem Overview
This is a 2D irregular polygon packing optimization problem. The goal is to pack Christmas tree toys (15-vertex polygons) into the smallest square bounding box for configurations of 1-200 trees.

**Score Formula:** `score = Σ(s_n² / n)` for n=1 to 200, where s_n is the side length of the bounding square for the n-tree configuration. **Lower is better.**

**Target Score to Beat:** 68.922808

## Tree Geometry
- 15-vertex polygon representing a Christmas tree
- Trunk: 0.15 wide, 0.2 tall (bottom at y=-0.2)
- Base tier: 0.7 wide at y=0
- Middle tier: 0.4 wide at y=0.25
- Top tier: 0.25 wide at y=0.5
- Tip: at y=0.8
- Reference point: center of trunk top (0, 0)
- Trees can be rotated by any angle (0-360 degrees)

## Key Approaches from Public Kernels

### 1. bbox3 C++ Optimizer (HIGHEST PRIORITY)
**Source:** `../research/kernels/jazivxt_why-not/why-not.ipynb`, `../research/kernels/saspav_santa-submission/santa-submission.ipynb`

The bbox3 binary is a C++ optimizer with:
- Complex Number Vector Coordination
- Fluid Dynamics simulation
- Hinge Pivot moves
- Density Gradient Flow
- Global Boundary Tension
- OpenMP parallelization

**Usage:** `./bbox3 -n <iterations> -r <radius>`
- Typical parameters: n=1000-2000, r=30-90 for short runs; n=5000-10000, r=256 for longer runs

### 2. tree_packer C++ Optimizer
**Source:** `../research/kernels/smartmanoj_santa-claude/santa-claude.ipynb`

Features:
- Simulated Annealing (SA) with temperature scheduling
- Swap move operator (exchange positions of two trees)
- Multi-angle restarts
- Squeeze operation (scale towards centroid)
- Compaction (move trees towards center)
- Local search with 8-directional moves and rotation adjustments

**Usage:** `./tree_packer_v21.exe -n <iterations> -r <radius>`

### 3. Backward Propagation (bp.cpp)
**Source:** `../research/kernels/smartmanoj_santa-claude/santa-claude.ipynb`

Key insight: For n-tree configuration, try removing boundary-touching trees to potentially improve (n-1)-tree configuration.
- Goes from N=200 down to N=2
- Only considers trees that touch the bounding box boundary
- If removing a tree improves the smaller configuration, save it

**Usage:** `./bp.exe input.csv output.csv`

### 4. fix_direction (Rotation Optimization)
**Source:** `../research/kernels/saspav_santa-submission/santa-submission.ipynb`

Post-processing step that optimizes the global rotation of each configuration:
- Uses scipy.optimize.minimize_scalar to find optimal rotation angle
- Rotates entire configuration to minimize bounding box
- Can reduce score by tightening the bounding box alignment

### 5. Greedy Initialization
**Source:** `../research/kernels/inversion_santa-2025-getting-started/santa-2025-getting-started.ipynb`

For building initial configurations:
- Start with n-1 tree configuration
- Add new tree at random angle, far from center
- Move towards center until collision
- Back up until no collision
- Use weighted angle distribution (abs(sin(2*angle))) to favor corners

## Pre-optimized Baselines
Several kernels download pre-optimized CSVs from external sources:
- `https://raw.githubusercontent.com/SmartManoj/Santa-Scoreboard/main/submission.csv`
- Various Kaggle datasets with optimized solutions

**CRITICAL:** Start from the best available pre-optimized baseline, not from scratch!

## Recommended Experiment Strategy

### Experiment 1: Baseline Reproduction
1. Download the best available pre-optimized submission CSV
2. Score it locally to verify
3. Submit to establish baseline

### Experiment 2: bbox3 Optimization
1. Compile bbox3.cpp with OpenMP: `g++ -O3 -fopenmp -march=native -std=c++17 -o bbox3 bbox3.cpp`
2. Run with moderate parameters: `./bbox3 -n 2000 -r 60`
3. Apply fix_direction post-processing
4. Validate no overlaps, repair if needed
5. Submit

### Experiment 3: tree_packer + Backward Propagation
1. Compile tree_packer_v21.cpp
2. Run optimization: `./tree_packer_v21.exe -n 5000 -r 128`
3. Run backward propagation: `./bp.exe submission.csv submission.csv`
4. Apply fix_direction
5. Submit

### Experiment 4: Multi-phase Optimization
1. Phase A: Many short bbox3 runs with different (n, r) parameters
2. Phase B: Medium runs on top candidates
3. Phase C: Long runs on best few
4. Always keep best submission, revert on regressions

### Experiment 5: Ensemble/Merge Best Configurations
For each n from 1 to 200:
- Compare configurations from multiple optimizers
- Keep the one with smallest bounding box side length
- Merge into final submission

## Validation & Overlap Repair

**CRITICAL:** Submissions with overlapping trees will be rejected!

Overlap detection:
- Use Shapely library with STRtree for efficient spatial queries
- Check polygon intersection (not just touching)
- For each pair of trees, verify no overlap

Overlap repair:
- If configuration n has overlap, replace with configuration from donor (baseline) file
- Use `replace_group()` function to swap specific n-configurations

## Code Snippets

### Scoring Function
```python
def get_score(trees, n):
    xys = np.concatenate([np.asarray(t.polygon.exterior.xy).T for t in trees])
    min_x, min_y = xys.min(axis=0)
    max_x, max_y = xys.max(axis=0)
    side_length = max(max_x - min_x, max_y - min_y)
    return side_length**2 / n
```

### Total Score
```python
def get_total_score(dict_of_side_length):
    score = 0
    for k, v in dict_of_side_length.items():
        score += v ** 2 / Decimal(k)
    return score
```

## Key Insights from Research

1. **Asymmetric solutions often outperform symmetric ones** for larger N values
2. **Boundary-touching trees** are the key to reducing bounding box size
3. **Rotation optimization** (fix_direction) can provide small but consistent improvements
4. **Local search on pre-optimized solutions** has diminishing returns - need constructive approaches
5. **Backward propagation** can improve smaller N configurations by leveraging larger N solutions

## Time Budget Considerations
- bbox3 with n=2000, r=60: ~2 minutes per run
- tree_packer with n=5000, r=128: ~5-10 minutes
- Full 3-hour optimization: Use phased approach with increasing timeouts

## Files and Paths
- Sample submission: `/home/data/sample_submission.csv`
- Kernels: `../research/kernels/`
- Key kernel with bbox3 source: `../research/kernels/jazivxt_why-not/why-not.ipynb`
- Key kernel with tree_packer source: `../research/kernels/smartmanoj_santa-claude/santa-claude.ipynb`
