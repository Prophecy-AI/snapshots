# Santa 2025 - Christmas Tree Packing Challenge - Loop 3 Strategy

## Current Status
- Best CV score: 70.647327 from exp_000 (001_baseline)
- Best LB score: 70.6473 (CONFIRMED - matches CV exactly!)
- Target: 68.919154 | Gap to target: 1.728 points (2.4%)
- Submissions used: 2/100 (90 remaining)

## CRITICAL: Last Submission FAILED
**002_ensemble failed with "Overlapping trees in group 042"**

Root cause: The santa-2025.csv file contains corrupted data with invalid rotation angles (e.g., deg=16623.66 for tree 042_12). The ensemble approach picked this corrupted configuration without validation.

**LESSON LEARNED:** Any ensemble approach MUST validate configurations before combining them:
1. Check rotation angles are in valid range (0-360 or -180 to 180)
2. Verify no overlapping trees using Shapely
3. Verify bounding box calculation is correct

## CV-LB Calibration
- CV = 70.647327, LB = 70.647327 → Perfect match!
- This means our local scoring is accurate and we can trust CV

## Response to Evaluator
The evaluator correctly identified:
1. **Extended bbox3 runs are needed** - The yongsukprasertsuk kernel shows a 3-HOUR phased optimization approach
2. **Rotation tightening (fix_direction)** hasn't been applied yet
3. **Asymmetric solutions** may outperform symmetric ones (per discussion insights)
4. **The target of 68.919 is achievable** - teams have achieved scores in the 67-68 range

I AGREE with all these points. The ensemble experiment failed due to data validation issues, but the evaluator's strategic direction is correct.

## Key Insights

### 1. The Problem with Passive Approaches
- Downloading and combining pre-optimized solutions yields MINIMAL improvement (0.000021 points)
- All public solutions are at similar local optima
- We need ACTIVE OPTIMIZATION, not passive ensembling

### 2. The 3-Phase Optimization Strategy (from yongsukprasertsuk kernel)
This is the META-STRATEGY that top solutions use:
- **Phase A (1-2 hours):** Short runs (2-5 min each) with varied parameters
  - n_values = [1000, 1500, 2000, 3000, 5000]
  - r_values = [30, 60, 90, 120]
  - Track which (n, r) combinations show any improvement
- **Phase B (30-60 min):** Medium runs (10 min) on top 3-5 candidates
- **Phase C (30-60 min):** Long runs (20 min) on best 2 candidates
- Apply fix_direction (rotation tightening) after each phase

### 3. Rotation Tightening (fix_direction)
The yongsukprasertsuk kernel includes a rotation optimization step that:
- Finds the optimal rotation angle for the entire packing
- Can squeeze out small improvements (0.001-0.01 points)
- Uses scipy.optimize.minimize_scalar

### 4. Data Validation is CRITICAL
Before any submission:
- Verify all rotation angles are valid (0-360 range)
- Check for overlapping trees using Shapely
- Verify bounding box calculation matches expected score

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Fix the Ensemble with Proper Validation
The ensemble approach is still valid, but needs:
1. Filter out corrupted data (invalid rotation angles)
2. Use ONLY submission.csv as the primary source (it's the cleanest)
3. Validate each configuration before including in ensemble
4. Check for overlaps before saving submission

### 2. **[HIGH PRIORITY]** Run Extended bbox3 Optimization
Implement the 3-phase approach from yongsukprasertsuk:
1. Start with the baseline submission (70.647327)
2. Run bbox3 with varied parameters for 1-2 hours
3. Apply fix_direction after each improvement
4. Track which N values improve

### 3. **[MEDIUM PRIORITY]** Focus on Specific N Ranges
Score breakdown suggests:
- N=21-200 contributes 62.59 points (88.6% of total)
- Improvements in large N values have more impact
- Focus optimization on N=50-200 where small % improvements yield larger absolute gains

### 4. **[LOWER PRIORITY]** Explore Asymmetric Solutions
The discussion "Why the winning solutions will be Asymmetric" suggests:
- Symmetric packings may not be optimal for all N values
- Asymmetric exploration could yield improvements
- This is a fundamentally different approach

## What NOT to Try
- ❌ Ensemble without validation (causes overlapping trees)
- ❌ Using santa-2025.csv directly (contains corrupted data)
- ❌ Micro-optimizations when we're 1.7 points from target
- ❌ Running bbox3 for only 100 iterations (proven ineffective)

## Technical Notes
- bbox3 binary is compiled and working at /home/code/exploration/datasets/bbox3
- Scoring is calibrated (CV = LB)
- 26 threads available for parallel optimization
- Shapely is available for overlap detection

## Validation Notes
- Use the same scoring function as baseline (sum of s²/n for N=1 to 200)
- **CRITICAL:** Verify no overlaps before submission using Shapely
- **CRITICAL:** Validate rotation angles are in valid range
- Submit to LB to verify improvement

## SUBMISSION STRATEGY
- Remaining submissions: 90
- Submit after this experiment? **YES** - we have abundant submissions and need LB feedback
- But ONLY submit if validation passes (no overlaps, valid rotations)

## Code References
- bbox3 binary: `/home/code/exploration/datasets/bbox3`
- Best baseline: `/home/code/exploration/datasets/submission.csv` (score 70.647)
- yongsukprasertsuk kernel: `/home/code/research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/`
