# Santa 2025 - Christmas Tree Packing Challenge - Loop 4 Strategy

## Current Status
- Best CV score: 70.647327 from exp_000 (001_baseline)
- Best LB score: 70.6473 (CONFIRMED - matches CV exactly!)
- Target: 68.919154 | Gap to target: 1.728 points (2.4%)
- Submissions used: 2/100 (90 remaining)

## CV-LB Calibration
- CV = 70.647327, LB = 70.647327 → Perfect match!
- Local scoring is 100% accurate - we can trust CV completely

## Response to Evaluator

**I FULLY AGREE with the evaluator's assessment.** The evaluator has now recommended the 3-phase bbox3 optimization approach THREE TIMES, and it has not been implemented. This is a critical failure in execution.

**Key points from evaluator:**
1. ✓ Ensemble approaches are PROVEN ineffective (0.000021 improvement)
2. ✓ All public solutions are at the SAME local optimum
3. ✓ The only path forward is ACTIVE OPTIMIZATION with extended bbox3 runs
4. ✓ The yongsukprasertsuk kernel shows the META-STRATEGY that top solutions use

**The evaluator is correct.** We have wasted 3 experiments on ensemble approaches when the evaluator clearly stated that extended bbox3 optimization was the top priority. This must change NOW.

## MANDATORY: 3-Phase bbox3 Optimization

**THIS IS THE ONLY EXPERIMENT TO RUN. NO ALTERNATIVES.**

The yongsukprasertsuk kernel shows the exact approach:

### Phase A: Coarse Search (1-2 hours)
- Run bbox3 with varied parameters
- n_values = [1000, 1200, 1500, 1800, 2000]
- r_values = [30, 60, 90]
- Timeout = 2 minutes each (120 seconds)
- Track which (n, r) combinations show ANY improvement
- Select top 6 candidates

### Phase B: Medium Runs (30-60 min)
- Run bbox3 for 10 minutes each on top 3 candidates
- Apply fix_direction (rotation tightening) with passes=2
- Validate no overlaps

### Phase C: Long Runs (30-60 min)
- Run bbox3 for 20 minutes each on best 2 candidates
- Apply fix_direction with passes=3
- Final validation

### Implementation Details

**bbox3 binary location:** `/home/code/bbox3`
**Baseline submission:** `/home/code/exploration/datasets/submission.csv`

**bbox3 usage:**
```bash
./bbox3 -n <iterations> -r <rotation_step>
```
The binary reads from `submission.csv` and writes back to `submission.csv`.

**Key functions from yongsukprasertsuk kernel:**
1. `fix_direction()` - Rotation tightening using scipy.optimize.minimize_scalar
2. `repair_overlaps_in_place()` - Fixes any overlapping trees by reverting to baseline
3. `score_and_validate_submission()` - Validates no overlaps and calculates score

**CRITICAL:** The bbox3 optimizer works on the ENTIRE submission (all N=1-200). It uses simulated annealing to find better packings. The key insight is that LONGER RUNS with VARIED PARAMETERS can escape local optima.

## What NOT to Try

- ❌ NO MORE ENSEMBLE EXPERIMENTS - proven ineffective
- ❌ NO MORE downloading pre-optimized solutions - they're all at the same local optimum
- ❌ NO short bbox3 runs (100-500 iterations) - already proven ineffective
- ❌ NO micro-optimizations - we need 1.73 points, not 0.0001

## Technical Resources

**bbox3 source code:** `/home/code/bbox3.cpp`
**yongsukprasertsuk kernel:** `/home/code/research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/`

**Scoring function:**
```python
score = sum(side_length[n]**2 / n for n in range(1, 201))
```

## Validation Notes
- CV scheme: Calculate sum of (s_n^2 / n) for N=1 to 200
- Verify no overlaps using Shapely before submission
- Submit to LB to verify improvement

## SUBMISSION STRATEGY
- Remaining submissions: 90
- Submit after this experiment? **YES** - we have abundant submissions
- Even if score doesn't improve, submit to get LB feedback on the approach

## Expected Outcome

The yongsukprasertsuk kernel achieves meaningful improvements through extended optimization. The key is:
1. **TIME** - 2-3 hours of optimization, not 2 minutes
2. **PARAMETER VARIATION** - Different (n, r) combinations explore different solution spaces
3. **ROTATION TIGHTENING** - fix_direction squeezes out additional improvements

**The target of 68.919 IS achievable.** Teams have achieved scores in the 67-68 range. We must invest the compute time.
