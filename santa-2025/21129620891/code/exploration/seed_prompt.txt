# Christmas Tree Packing Optimization - Seed Prompt

## Problem Overview
This is a 2D irregular polygon packing optimization problem. The goal is to pack Christmas tree-shaped polygons (15-vertex non-convex shapes) into the smallest possible square bounding box for each n-tree configuration (n=1 to 200). 

**Metric:** Score = Σ(s²/n) for n=1 to 200, where s is the side length of the bounding square. Lower is better.
**Target Score:** Beat 68.922808

## Tree Geometry
- 15-vertex polygon with trunk
- Key dimensions: trunk_w=0.15, trunk_h=0.2, base_w=0.7, mid_w=0.4, top_w=0.25, tip_y=0.8
- TX/TY coordinates define the base shape
- Trees can be rotated (0-360 degrees) and positioned (x, y)
- Collision detection uses Shapely polygons with high precision

## Top Approaches from Public Kernels

### 1. bbox3 C++ Optimizer (Primary Approach)
**Source:** `../research/kernels/jazivxt_why-not/why-not.ipynb`

The bbox3 optimizer is the most successful approach, using:
- Complex number vector coordination for efficient geometry
- Fluid dynamics-inspired movement
- Hinge pivot optimization
- Density gradient flow
- Global boundary tension
- OpenMP parallelization for speed

**Key parameters:**
- `-n`: Number of iterations (try 1000-10000)
- `-r`: Restart/radius parameter (try 30-256)

**Usage pattern:**
```bash
g++ -O3 -march=native -std=c++17 -fopenmp -o bbox3 bbox3.cpp
./bbox3 -n 5000 -r 60
```

### 2. tree_packer C++ Optimizer
**Source:** `../research/kernels/smartmanoj_santa-claude/santa-claude.ipynb`

Alternative optimizer with different techniques:
- Swap moves between trees
- Multi-angle restarts
- Higher temperature simulated annealing
- Squeeze operation (scale towards center)
- Compaction (move trees toward center)
- Local search with 8-directional moves

### 3. fix_direction Post-Processing
**Source:** `../research/kernels/saspav_santa-submission/santa-submission.ipynb`

Critical post-processing step that optimizes the rotation of the entire configuration:
- Uses scipy.optimize.minimize_scalar
- Computes convex hull of all tree points
- Finds optimal rotation angle (0-90 degrees) to minimize bounding box
- Can improve score significantly

### 4. Backward Propagation
**Source:** `../research/kernels/smartmanoj_santa-claude/santa-claude.ipynb`

Improves smaller configurations by extracting from larger ones:
- Start from n=200, work down to n=2
- For each n, try removing boundary-touching trees
- If resulting (n-1) config is better than current best, save it
- Exploits the fact that good large configs often contain good smaller configs

## Multi-Phase Optimization Strategy
**Source:** `../research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/`

Recommended workflow:
1. **Phase A (Short runs):** 2-min runs with many n/r combinations to find promising settings
2. **Phase B (Medium runs):** 10-min runs on top candidates
3. **Phase C (Long runs):** 20-min runs on best few settings
4. **Validation:** Check for overlaps, repair by replacing with donor solution

## Key Optimization Techniques from Research

### Constructive Heuristics
- Bottom-left (BL) placement rule
- Weighted angle generation (prefer diagonal orientations for square packing)
- Greedy placement with collision detection

### Local Search Moves
- **Jostle:** Small random perturbations
- **Swap:** Exchange positions of two trees
- **Rotate:** Adjust individual tree angles
- **Translate:** Move trees toward center or away from boundaries

### Meta-heuristics
- Simulated Annealing with adaptive temperature
- Genetic Algorithms for sequence optimization
- Particle Swarm Optimization for placement order

### Geometric Techniques
- No-fit polygon (NFP) for collision-free regions
- Convex hull for bounding box optimization
- STRtree for efficient spatial queries

## Validation & Overlap Repair

Critical: Submissions with overlapping trees are rejected!

**Overlap detection:**
```python
from shapely.strtree import STRtree
# Use STRtree for efficient collision detection
# Check: poly.intersects(other) and not poly.touches(other)
```

**Repair strategy:**
- If overlaps detected for configuration n, replace with known-good solution
- Keep a "donor" submission with valid configurations

## Recommended Experiments (Priority Order)

1. **Implement bbox3 optimizer** - Compile and run with various n/r parameters
   - Start with n=5000, r=60
   - Try grid search: n in [1000, 2000, 5000, 10000], r in [30, 60, 90, 120]

2. **Apply fix_direction post-processing** - Always run after optimization
   - Multiple passes can help (passes=1 to 3)

3. **Backward propagation** - Extract better small configs from large ones

4. **Ensemble approach** - Keep best configuration for each n across multiple runs

5. **Local search refinement** - Fine-tune positions with small step sizes

## Submission Format
```
id,x,y,deg
001_0,s0.0,s0.0,s90.0
002_0,s0.0,s0.0,s90.0
002_1,s0.202736,s-0.511271,s90.0
...
```
- Values prefixed with 's' to preserve precision
- Coordinates constrained to -100 ≤ x, y ≤ 100

## Code References
- Getting started: `../research/kernels/inversion_santa-2025-getting-started/`
- bbox3 source: `../research/kernels/jazivxt_why-not/why-not.ipynb`
- tree_packer: `../research/kernels/smartmanoj_santa-claude/santa-claude.ipynb`
- Multi-phase runner: `../research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/`
