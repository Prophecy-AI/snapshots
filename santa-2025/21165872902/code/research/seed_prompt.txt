# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- **Best CV score:** 70.647306 from exp_002 (003_better_ensemble)
- **Best LB score:** 70.658891 (from exp_001)
- **Target:** 68.919154
- **Gap to target:** 1.728 points (2.51%)

## CV-LB Relationship Analysis
- CV-LB gap is EXACTLY 0 (verified with 2 submissions)
- Local scoring is perfectly accurate
- We can trust local optimization results completely

## Response to Evaluator

The evaluator correctly identified several key issues:

1. **Wrong starting point** - ADDRESSED. We found an even better baseline (70.647306) in snapshot 21165874980 that improves on the 70.658891 file.

2. **Optimizers stuck at local optimum** - CONFIRMED. bbox3 (64 rounds), tree_packer_v18 (50k iterations), and tree_packer_v21 all failed to improve the pre-optimized solution. The solution is at a very tight local optimum.

3. **Perturbation + fractional translation not implemented** - This is the KEY insight. The jonathanchan kernel uses:
   - `perturb()` function to escape local optima with random noise
   - `fractional_translation()` with steps as small as 0.00001
   - Multiple generations with restarts

4. **Time budget not fully utilized** - The evaluator is right that top solutions run for hours. However, even 10+ minute runs with bbox3 and tree_packer showed ZERO improvement, suggesting the problem is not time but the optimization approach itself.

## Key Insight: The Gap is Too Large for Micro-Optimization

**Current: 70.647306 | Target: 68.919154 | Gap: 1.728 points (2.51%)**

This gap is MASSIVE for a packing optimization problem. The pre-optimized solutions are already at ~99.5% of their local optimum. To close a 2.5% gap, we need:

1. **Fundamentally different packing strategies** (not just better optimization)
2. **Tessellation/lattice approaches** for large N values
3. **Fresh construction** from scratch with different algorithms

## What Has Been Tried (and failed)

1. ❌ bbox3 optimizer (64 rounds, 5000 iterations) - 0 improvement
2. ❌ tree_packer_v18 (50k iterations, 32 restarts) - 0 improvement  
3. ❌ tree_packer_v21 (50k iterations, 32 restarts) - 0 improvement, creates overlaps
4. ❌ Ensemble from multiple pre-optimized files - santa-2025.csv dominates
5. ❌ Small N optimization (N=2) - current solution already optimal
6. ❌ Genetic algorithm approaches - converge to baseline
7. ❌ Grid/lattice construction - produces 20-300% worse results

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY] Submit the Better Baseline**
We found a better submission (70.647306) that hasn't been submitted yet. Submit this first to get LB feedback and establish a new best.

### 2. **[HIGH PRIORITY] Implement Tessellation Approach for Large N**
The egortrushin kernel uses a fundamentally different approach:
- Start with 2 base trees in a specific configuration
- Translate them in x and y directions to create a grid pattern
- Use SA to optimize the base configuration and translation vectors
- This is specifically designed for N >= 58 where regular patterns work well

Key code pattern:
```python
def translate(current_trees, lengthx, lengthy, nt):
    trees_ = []
    for tree in current_trees:
        for x in range(nt[0]):
            for y in range(nt[1]):
                trees_.append(ChristmasTree(
                    center_x=tree.center_x + Decimal(x * lengthx),
                    center_y=tree.center_y + Decimal(y * lengthy),
                    angle=tree.angle,
                ))
    return trees_
```

### 3. **[HIGH PRIORITY] Analyze Which N Values Have Most Room for Improvement**
Compare our best solution against theoretical bounds:
- For each N, calculate: current_score / theoretical_minimum
- Focus optimization effort on N values with worst efficiency
- The target (68.919154) requires ~71.3% packing efficiency vs our current ~69.5%

### 4. **[MEDIUM PRIORITY] Try Random Restarts with Fresh Configurations**
Instead of optimizing from pre-optimized solutions:
- Generate 10-20 completely random initial configurations
- Run optimization on each independently
- This explores different basins of attraction

### 5. **[MEDIUM PRIORITY] Implement Perturbation + Restart Strategy**
From jonathanchan kernel:
```cpp
Cfg perturb(Cfg c, double strength, int seed) {
    // Add random noise to positions and angles
    c.x[i] += (rf() - 0.5) * strength;
    c.y[i] += (rf() - 0.5) * strength;
    c.a[i] = fmod(c.a[i] + rf() * 20 - 10 + 360, 360.0);
}
```

## What NOT to Try

1. ❌ More iterations of bbox3/tree_packer on pre-optimized solutions (already tried, 0 improvement)
2. ❌ Simple ensemble (one source dominates all N values)
3. ❌ Micro-optimization when 2.5% away from target
4. ❌ Short optimization runs (need hours, not minutes)

## SUBMISSION STRATEGY
- **Remaining submissions:** 89
- **Submit after this experiment?** YES - we have abundant submissions
- Submit the 70.647306 baseline first, then continue experimenting

## Validation Notes
- CV = LB exactly (verified with 2 submissions)
- Local scoring is perfectly accurate
- No overlap detection issues

## Files to Use
- Best baseline: `/home/nonroot/snapshots/santa-2025/21165874980/code/submission_candidates/candidate_001.csv` (score: 70.647306)
- Current submission: `/home/submission/submission.csv` (already copied)
