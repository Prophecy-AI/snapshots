# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.676102 from ensemble.csv (exp_001)
- Best LB score: PENDING (first submission failed due to precision loss)
- Target: 68.919154 | Gap to target: 1.757 points (2.5% improvement needed)
- Submissions remaining: 99/100

## CRITICAL: First Submission Failed!
The first submission failed with "Overlapping trees in group 040" due to precision loss when rewriting CSV files. The fix is to copy the original ensemble.csv directly using `cp` or `shutil.copy()` instead of rewriting with pandas.

**IMMEDIATE ACTION REQUIRED:**
1. Copy the original ensemble.csv directly to /home/submission/submission.csv
2. Submit to establish baseline LB score
3. Then proceed with optimization experiments

## Response to Evaluator
The evaluator correctly identified several key issues:

1. **Simplified optimizer**: The bbox3.cpp we used is a simplified version with basic perturbation moves. The top kernels use more sophisticated optimizers like sa_v1_parallel.cpp with:
   - Population-based optimization (keeping top 3 candidates)
   - Perturbation to escape local optima
   - Temperature-based acceptance probability
   - Different iteration counts for different N ranges

2. **Short optimization runs**: We used -n 5000 -r 32, but top kernels use -n 15000+ with longer runs. The gap of 1.76 points requires aggressive optimization.

3. **Single starting configuration**: All pre-optimized files may be in similar local optima basins. We need multi-start with perturbation.

**I agree with all evaluator recommendations.** The next experiment should use sa_v1_parallel.cpp with extended parameters.

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Submit Fixed Baseline
- Copy ensemble.csv directly (preserving precision)
- Submit to establish LB score
- This is critical for calibrating CV-LB relationship

### 2. **[HIGH PRIORITY]** Run sa_v1_parallel.cpp with Extended Parameters
```bash
# Compile
g++ -O3 -march=native -std=c++17 -fopenmp -o sa_v1_parallel sa_v1_parallel.cpp

# Run with extended parameters (30+ minutes)
./sa_v1_parallel -i ensemble.csv -o optimized.csv -n 20000 -r 10
```

The optimizer includes:
- `opt_v3()`: Population-based optimization keeping top 3 candidates
- `perturb()`: Adds noise to escape local optima
- `fractional_translation()`: Micro-adjustments at the end
- Different iteration counts for different N ranges

### 3. **[MEDIUM PRIORITY]** Multi-Start with Different Seeds
Run optimization from multiple random starting configurations:
```python
for seed in range(10):
    config = perturb(best_config, strength=0.2, seed=seed)
    optimized = run_optimizer(config)
    if score(optimized) < best_score:
        best = optimized
```

### 4. **[MEDIUM PRIORITY]** Backward Propagation
Use bp.cpp from santa-claude to generate improved small-N configurations from larger ones:
- Remove trees from N+1 config to create N config
- This can find better local optima for small N values

### 5. **[LOWER PRIORITY]** Constructive Approaches
If optimization continues to fail, try building solutions from scratch:
- Greedy corner-occupying algorithm
- Beam search with backtracking
- No-Fit Polygon (NFP) technique

## Score Breakdown by N Range
- N=1-10: 4.33 (6.1%) - Already well-optimized
- N=11-50: 14.71 (20.8%) - Medium opportunity
- N=51-100: 17.64 (25.0%) - Highest opportunity
- N=101-150: 17.14 (24.3%) - Medium opportunity
- N=151-200: 16.85 (23.8%) - Medium opportunity

Focus optimization effort on N=51-100 which contributes 25% of total score.

## What NOT to Try
- Short optimization runs (< 5 minutes)
- Simple bbox3 with basic parameters
- Rewriting CSV files with pandas (causes precision loss)
- Greedy algorithms alone (already at local optimum)

## Key Code Locations
- sa_v1_parallel.cpp: `/home/nonroot/snapshots/santa-2025/21116303805/code/experiments/004_sa_v1_parallel/sa_v1_parallel.cpp`
- ensemble.csv: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/ensemble.csv`
- bp.cpp: `/home/nonroot/snapshots/santa-2025/20992536951/code/bp.cpp`

## Validation Checklist
1. Copy original CSV directly (don't rewrite with pandas)
2. Verify no overlapping trees before submission
3. Check all 200 configurations present (20100 rows)
4. Verify coordinates within [-100, 100]
5. Values prefixed with 's' in submission

## SUBMISSION STRATEGY
- Remaining submissions: 99
- **Submit after EVERY experiment** - we have abundant submissions
- LB feedback is critical for understanding what works
- Don't waste submissions on duplicate scores
