# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.676102 from exp_001 (002_bbox3_optimization)
- Best LB score: 70.676102 (CV-LB gap: 0.0 - perfect match!)
- Target: 68.919154 | Gap to target: 1.757 points (2.5% improvement needed)
- Submissions used: 2/100 (98 remaining)

## CV-LB Relationship Analysis
- LB = CV exactly (gap = 0)
- This is a PURE OPTIMIZATION problem - no distribution shift
- Any CV improvement will directly translate to LB improvement

## Response to Evaluator
The evaluator correctly identified that:
1. The bbox3 optimizer used was a simplified version - need the sophisticated sa_v1_parallel.cpp
2. Optimization runs were too short (-n 5000 -r 32 vs recommended -n 20000 -r 80+)
3. Only one starting configuration was tried - need multi-start with perturbation
4. The pre-optimized submission is at a tight local optimum

**Key insight**: The evaluator recommends using sa_v1_parallel.cpp with:
- `opt_v3()`: Population-based optimization keeping top 3 candidates
- `perturb()`: Adds noise to escape local optima
- `fractional_translation()`: Micro-adjustments at the end
- Different iteration counts for different N ranges (N<=20: 1.5x, N<=50: 1.3x, N>150: 0.8x)

## Problem Understanding
- Pack N Christmas trees (15-vertex polygons) into smallest square bounding box
- Score = Σ(side_n² / n) for n=1 to 200
- Score breakdown: N=1-10 (6.1%), N=11-50 (20.8%), N=51-100 (25.0%), N=101-150 (24.3%), N=151-200 (23.8%)
- Need ~2.49% improvement across all N ranges

## What's Been Tried (FAILED)
1. ❌ bbox3 with -n 5000 -r 32: No improvement (too short, simplified optimizer)
2. ❌ tree_packer_v21: No improvement, created overlaps
3. ❌ fractional_translation.py: Only 1 micro-improvement, 0 score change
4. ❌ Ensemble from 30 pre-optimized files: Already at best for all N values

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Run sa_v1_parallel.cpp with Extended Parameters
The sophisticated optimizer from jonathanchan kernel with:
```bash
# Compile
g++ -O3 -march=native -std=c++17 -fopenmp -o sa_v1_parallel sa_v1_parallel.cpp

# Run with extended parameters (30+ minutes)
./sa_v1_parallel -i ensemble.csv -o optimized.csv -n 20000 -r 80
```

Key features:
- Population-based optimization (keeps top 3 candidates)
- `perturb()` function to escape local optima
- SA with temperature schedule T=1.0 → 0.000005
- Different iteration counts for different N ranges
- `fractional_translation()` for micro-adjustments

### 2. **[HIGH PRIORITY]** Multi-Start Optimization with Different Seeds
Run optimization from multiple random starting configurations:
```python
for seed in range(10):
    perturbed = perturb(best_config, strength=0.2, seed=seed)
    optimized = run_sa_v1_parallel(perturbed)
    if score(optimized) < best_score:
        best = optimized
```

### 3. **[MEDIUM PRIORITY]** Focus on High-Impact N Ranges
N=11-100 contributes 45.8% of total score. Run targeted optimization:
- For N<=20: Use 1.5x iterations
- For N<=50: Use 1.3x iterations
- For N>150: Use 0.8x iterations (already well-optimized)

### 4. **[MEDIUM PRIORITY]** Backward Propagation
Use bp.cpp from santa-claude to generate improved small-N configurations from larger ones:
```bash
./bp -i submission.csv -o improved.csv
```

### 5. **[LOWER PRIORITY]** Lattice-Based Initialization for Large N
For N >= 58, try crystalline packing as starting point:
- Alternating rows of trees at 0° and 180°
- Optimize the base configuration and translation vectors

## What NOT to Try
- ❌ Short optimization runs (< 30 minutes)
- ❌ Simple bbox3 optimizer (use sa_v1_parallel instead)
- ❌ Rewriting CSV with pandas (causes precision loss)
- ❌ Building from scratch without optimization (greedy approaches alone won't beat pre-optimized)

## Validation Checklist
1. No overlapping trees (use STRtree + intersects check)
2. All coordinates within [-100, 100]
3. All 200 configurations present (20100 rows)
4. Values prefixed with 's' in submission
5. Copy original CSV directly (don't rewrite with pandas)

## SUBMISSION STRATEGY
- Remaining submissions: 98
- **Submit after EVERY experiment** - we have abundant submissions
- LB feedback is free information - USE IT!

## Key Code Locations
- sa_v1_parallel.cpp: `/home/nonroot/snapshots/santa-2025/21116303805/code/experiments/004_sa_v1_parallel/sa_v1_parallel.cpp`
- Best ensemble.csv: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/ensemble.csv`
- bp.cpp: `/home/nonroot/snapshots/santa-2025/20992536951/code/bp.cpp`

## Expected Outcome
With extended optimization runs (30+ minutes) using sa_v1_parallel.cpp:
- Should find improvements in some N values
- Each 0.01 improvement in side length for a single N contributes ~0.01/n to score
- Target is achievable with sufficient compute time and the right optimizer