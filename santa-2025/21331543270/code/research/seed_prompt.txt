# Santa 2025 - Christmas Tree Packing Challenge - Loop 3 Strategy

## Current Status
- Best CV score: 70.615786 from exp_001 (fixed ensemble)
- Best LB score: 70.676102 (baseline - ensemble submission FAILED due to overlaps)
- Target: 68.888293 | Gap to target: 1.727 points (2.51%)
- Submissions remaining: 93/100

## CRITICAL: Overlap Bug Fixed
The ensemble submission failed with "Overlapping trees in group 002". Root cause:
- Our overlap detection tolerance (1e-12) was too loose
- Kaggle's validation is stricter (detects overlaps as small as 1e-15)
- 4 N values had tiny overlaps: N=2, 29, 103, 138
- **FIXED**: Now using tolerance=1e-15 for all overlap checks
- Fixed submission saved to `/home/submission/submission.csv` (score: 70.615786)

## Response to Evaluator

The evaluator correctly identified:
1. **Overlap detection was too loose** - Fixed with tolerance=1e-15
2. **Fractional translation not implemented** - This is the next priority
3. **Small N values underoptimized** - N=1-20 contribute disproportionately

## EXPERIMENT 2: Submit Fixed Ensemble + Implement Fractional Translation

### STEP 1: Submit the Fixed Ensemble (IMMEDIATE)
The fixed submission is ready at `/home/submission/submission.csv` with score 70.615786.
- This should pass Kaggle validation (all overlaps fixed)
- Submit to get LB feedback and confirm CV-LB calibration

### STEP 2: Implement Python Fractional Translation
Based on the jonathanchan kernel, implement fractional translation:

```python
def fractional_translation(trees, n, max_iter=200):
    """Micro-adjust tree positions to shrink bounding box."""
    step_sizes = [0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001]
    directions = [(0,1), (0,-1), (1,0), (-1,0), (1,1), (1,-1), (-1,1), (-1,-1)]
    
    best_side = get_bounding_box_side(trees)
    improved = True
    
    for iteration in range(max_iter):
        if not improved:
            break
        improved = False
        
        for i in range(len(trees)):
            for step in step_sizes:
                for dx, dy in directions:
                    # Try moving tree i
                    old_x, old_y = trees[i].center_x, trees[i].center_y
                    trees[i] = move_tree(trees[i], dx*step, dy*step)
                    
                    # Check if valid (no overlap) and better
                    if not has_overlap_strict(trees) and get_bounding_box_side(trees) < best_side - 1e-12:
                        best_side = get_bounding_box_side(trees)
                        improved = True
                    else:
                        # Revert
                        trees[i] = move_tree(trees[i], -dx*step, -dy*step)
    
    return trees
```

### STEP 3: Apply to All N Values
1. Start with the fixed ensemble (70.615786)
2. Apply fractional translation to each N
3. Focus on small N first (N=1-20) where improvements have biggest impact
4. Expected improvement: 0.01-0.05 points

### STEP 4: Implement Rotation Optimization (fix_direction)
For each N, try rotating the entire configuration:
```python
def optimize_rotation(trees, n):
    """Find optimal global rotation angle."""
    best_angle = 0
    best_side = get_bounding_box_side(trees)
    
    for angle in np.arange(0, 90, 0.5):  # 0.5 degree steps
        rotated = rotate_all_trees(trees, angle)
        side = get_bounding_box_side(rotated)
        if side < best_side:
            best_side = side
            best_angle = angle
    
    return rotate_all_trees(trees, best_angle)
```

## Key Files
- `/home/code/utils.py` - Utility functions (UPDATE overlap tolerance to 1e-15)
- `/home/code/experiments/001_ensemble/submission_fixed.csv` - Fixed ensemble
- `/home/submission/submission.csv` - Ready for submission

## What NOT to Try
- ❌ Using the "better" baseline (70.627569) - it has overlaps!
- ❌ Overlap tolerance > 1e-15 - Kaggle is stricter
- ❌ Running C++ binaries (blocked after baseline)
- ❌ "More iterations" on same optimizer

## Validation Notes
- ALWAYS use tolerance=1e-15 for overlap detection
- Verify ALL 200 N values pass overlap check before submission
- CV-LB gap should be ~0 (perfect calibration observed on baseline)

## SUBMISSION STRATEGY
- **SUBMIT IMMEDIATELY** - We have 93 submissions remaining
- The fixed ensemble (70.615786) should pass validation
- LB feedback confirms our overlap fix works
- Then continue with fractional translation experiments
