# Santa 2025 - Christmas Tree Packing Challenge - Loop 6 Strategy

## Current Status
- Best CV score: 70.615788 from exp_004 (safe_ensemble)
- Best LB score: 70.676102 (baseline - only submission that passed Kaggle)
- Target: 68.888293 | Gap to target: 1.727 points (2.51%)
- Submissions remaining: 93/100

## CRITICAL ISSUE: Overlap Detection Mismatch

**ALL ensemble submissions have FAILED Kaggle validation:**
- exp_001: "Overlapping trees in group 002"
- exp_002: "Overlapping trees in group 003"  
- exp_004: "Overlapping trees in group 060"

**Root Cause Identified:** Shapely's `intersection.area` returns 0 even when polygons have interior overlap due to numerical precision. The `relate()` function is more accurate - check if `relate[0] == '2'` (2D interior intersection).

**Fixed Submission Created:** experiments/005_fixed_submission/submission.csv
- Uses relate() method to detect overlaps
- Replaced N=60 with baseline configuration
- Score: 70.615788 (same as before, only N=60 was problematic)

## Response to Evaluator

The evaluator correctly identified:
1. **Safe ensemble NOT submitted** - CRITICAL. We need to submit the fixed submission.
2. **fix_direction NOT implemented** - The bbox3 runner kernel shows this as a standard post-processing step.
3. **bbox3 with default parameters only** - Should try multi-phase approach.

**However**, the evaluator's suggestions about fix_direction and multi-phase bbox3 are unlikely to close the 1.727 point gap. These are micro-optimizations (0.01-0.05 points) when we need 1.7+ points.

## Strategic Assessment

**The fundamental problem:** Both baseline and ensemble are at LOCAL OPTIMA that C++ optimizers cannot escape.

**Evidence:**
- bbox3 on baseline: NO improvement (10 rounds, 50000 iterations)
- bbox3 on ensemble: NO improvement (10 rounds, 50000 iterations)
- sa_v1_parallel on ensemble: NO improvement (timed out)

**The gap is too large for micro-optimization.** We need fundamentally different approaches.

## Recommended Approaches (Priority Order)

### 1. **IMMEDIATE: Submit Fixed Submission** (HIGH PRIORITY)
- File: /home/code/experiments/005_fixed_submission/submission.csv
- Score: 70.615788
- This should pass Kaggle validation (uses relate() method)
- Submit to verify it passes and establish new baseline

### 2. **Implement fix_direction + Multi-Phase bbox3** (MEDIUM PRIORITY)
From the bbox3 runner kernel:
```python
# fix_direction: Optimize rotation angle for entire configuration
from scipy.optimize import minimize_scalar
from scipy.spatial import ConvexHull

def optimize_rotation(trees, angle_max=89.999, epsilon=1e-7):
    all_points = []
    for tree in trees:
        all_points.extend(list(tree.polygon.exterior.coords))
    points_np = np.array(all_points)
    hull_points = points_np[ConvexHull(points_np).vertices]
    
    res = minimize_scalar(
        lambda a: calculate_bbox_side_at_angle(a, hull_points),
        bounds=(0.001, angle_max),
        method="bounded",
    )
    return res.x, res.fun

# Multi-phase bbox3:
# Phase A: Short runs (2 min) with n=[1000,1200,1500,1800,2000], r=[30,60,90]
# Phase B: Medium runs (10 min) on top candidates
# Phase C: Long runs (20 min) on best few
```

**Expected improvement:** 0.01-0.05 points (NOT enough to reach target)

### 3. **Research Fundamentally Different Approaches** (HIGH PRIORITY)

The gap (1.727 points) requires breakthrough techniques, not micro-optimization:

a) **Tessellation Patterns for Large N:**
   - Chris Deotte's discussion suggests tessellations for N>58
   - Crystalline/lattice packing instead of chaotic SA
   - WebSearch: "tessellation patterns for 2D polygon packing optimization"

b) **Asymmetric Solutions:**
   - Discussion "Why the winning solutions will be Asymmetric" (39 votes)
   - Symmetric solutions may be suboptimal for certain N values
   - WebSearch: "asymmetric solutions 2D bin packing optimization"

c) **Different Packing Strategies for Small N:**
   - Small N (1-20) contribute disproportionately to score
   - N=1 alone contributes 0.66 points
   - Can we find better configurations for N=1-20?

d) **Genetic Algorithm with Custom Operators:**
   - Evolve population of solutions
   - Custom crossover: swap partial solutions between candidates
   - Custom mutation: rotate/translate clusters

### 4. **Analyze Top Leaderboard Solutions** (MEDIUM PRIORITY)
- The top teams have scores below 69
- What techniques are they using that we're not?
- Look for patterns in their per-N scores

## What NOT to Try
- ❌ Running bbox3/SA with "more iterations" - already proven ineffective
- ❌ Different parameters on same optimizer - local optimum trap
- ❌ Ensemble of optimized solutions - all converge to same optimum

## Validation Notes
- Use relate() method for overlap detection, NOT intersection.area
- Tolerance check: relate[0] == '2' means 2D interior intersection
- Always verify submission passes local validation before Kaggle submission

## SUBMISSION STRATEGY
- Remaining submissions: 93
- **SUBMIT IMMEDIATELY:** experiments/005_fixed_submission/submission.csv
- This verifies our overlap detection fix works
- If it passes: We have a new baseline at 70.615788
- If it fails: We need even stricter overlap detection

## Next Experiment: 006_tessellation_research
1. Research tessellation patterns for large N
2. Implement tessellation-based packing for N>58
3. Test on small subset first (N=60, 100, 150, 200)
4. If promising, scale to all N values
