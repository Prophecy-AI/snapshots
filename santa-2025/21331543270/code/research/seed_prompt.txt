# Santa 2025 - Christmas Tree Packing Challenge - Loop 5 Strategy

## Current Status
- Best CV score: 70.615788 from safe_ensemble (NOT YET SUBMITTED)
- Best LB score: 70.676102 (baseline - only submission that passed Kaggle)
- Target: 68.888293 | Gap to target: 1.727 points (2.51%)
- Submissions remaining: 93/100

## ⚠️ CRITICAL: TWO ENSEMBLE SUBMISSIONS FAILED KAGGLE VALIDATION
- exp_001 (70.615744): Failed with "Overlapping trees in group 002"
- exp_002 (70.615786): Failed with "Overlapping trees in group 003"
- Only exp_000 (baseline 70.676102) passed Kaggle validation

## Response to Evaluator

The evaluator correctly identified several critical issues:

1. **C++ Optimizer Run on Wrong Submission (CRITICAL)** - AGREED
   - exp_003 ran bbox3 and sa_v1_parallel on the BASELINE (70.676102)
   - The baseline is at a local optimum - of course no improvement!
   - Should have run on the safe_ensemble (70.615788) which has different configurations
   - **ACTION**: Next experiment MUST run C++ optimizers on safe_ensemble

2. **Safe Ensemble Not Submitted** - AGREED
   - The safe_ensemble (70.615788) was created but never submitted
   - We don't know if our "ultra-strict" overlap detection is strict enough
   - **ACTION**: Submit safe_ensemble FIRST to verify it passes Kaggle

3. **fix_direction Not Implemented** - AGREED
   - The bbox3 runner kernel shows rotation optimization can provide 0.01-0.05 point improvements
   - This is a cheap post-processing step we're leaving on the table
   - **ACTION**: Implement fix_direction from bbox3 runner kernel

## Gap Analysis (CRITICAL!)
- Current best: 70.615788
- Target: 68.888293
- Gap: 1.727 points
- Improvement so far: 0.060 points (from baseline)
- **Need 28.6x more improvement than we've achieved!**

## Score Breakdown by N Range
- N=1-10: 4.33 points (NO improvement from ensemble - hardest to improve)
- N=11-50: 14.70 points (0.0095 improvement)
- N=51-100: 17.61 points (0.0349 improvement - most improved)
- N=101-150: 17.13 points (0.0094 improvement)
- N=151-200: 16.84 points (0.0066 improvement)

## Recommended Experiments (Priority Order)

### EXPERIMENT 004: Submit Safe Ensemble + Run C++ on Ensemble
**HIGHEST PRIORITY - DO THIS FIRST**

1. **Submit the safe_ensemble (70.615788)** to verify it passes Kaggle
   - Copy `/home/code/experiments/003_safe_ensemble/submission.csv` to `/home/submission/submission.csv`
   - Submit to get LB feedback
   - This is critical to verify our overlap detection is strict enough

2. **If it passes**: Run C++ optimizers on safe_ensemble (NOT baseline!)
   ```bash
   cd /home/code/experiments/004_optimize_ensemble
   cp /home/code/experiments/003_safe_ensemble/submission.csv submission_best.csv
   /home/nonroot/snapshots/santa-2025/21329069570/code/code/bbox3 -i submission_best.csv -n 50000 -r 10
   ```

3. **Implement fix_direction** from bbox3 runner kernel:
   - For each N group, optimize the rotation angle to minimize bounding box
   - Use scipy.optimize.minimize_scalar
   - Apply after bbox3 optimization

4. **Implement repair_overlaps_in_place**:
   - After any optimization, check each N for overlaps
   - Replace invalid N values with baseline donor
   - This ensures Kaggle validation passes

### EXPERIMENT 005: Tessellation for Large N (if 004 doesn't close gap)
**MEDIUM PRIORITY**

For N > 50, tessellation patterns may provide better packing:
- Use 2 base trees translated in x and y directions
- Create grid patterns (e.g., 4x9=36, 5x10=50, etc.)
- Reference: egortrushin_santa25-simulated-annealing-with-translations kernel

### EXPERIMENT 006: Small N Optimization (if gap still large)
**LOWER PRIORITY**

Small N values (1-10) contribute 4.33 points but have NO improvement from ensemble.
- These are the hardest to improve
- May need fundamentally different approach
- Consider branch-and-bound for N=1-10 to find optimal solutions

## ⛔ BLOCKED APPROACHES (DO NOT USE)
- Running bbox3/sa_v1_parallel on BASELINE again - already proven to be at local optimum
- Ensemble approaches without strict overlap validation - two submissions already failed
- "More iterations" on the same optimizer with same starting point

## Key Files to Reference
- `/home/code/research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/` - Has fix_direction, repair_overlaps_in_place
- `/home/code/experiments/003_safe_ensemble/submission.csv` - Best valid submission (70.615788)
- `/home/code/experiments/000_baseline/submission.csv` - Baseline donor for repairs

## SUBMISSION STRATEGY
- **SUBMIT AFTER EVERY EXPERIMENT** - We have 93 submissions remaining
- LB feedback is critical - our local validation has been wrong twice
- Even if score doesn't improve, we learn what works

## Validation Notes
- Use ultra-strict overlap detection (any intersection area > 0 rejected)
- Always verify submission passes local validation before submitting
- If Kaggle rejects, replace invalid N values with baseline donor
