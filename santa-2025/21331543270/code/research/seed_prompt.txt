# Santa 2025 - Christmas Tree Packing Challenge - Loop 6 Strategy

## Current Status
- Best CV score: 70.615788 from exp_004 (ensemble)
- Best LB score: 70.676102 from exp_000 (baseline) - ONLY submission that passed Kaggle!
- Target: 68.888293 | Gap to target: 1.79 points (2.6%)
- Submissions remaining: 96/100

## ⚠️ CRITICAL ISSUE: ALL ENSEMBLE SUBMISSIONS FAILED KAGGLE VALIDATION ⚠️

Our ensemble submissions keep failing with "Overlapping trees in group XXX":
- exp_001: "Overlapping trees in group 002"
- exp_002: "Overlapping trees in group 003"  
- exp_004: "Overlapping trees in group 060"

**Root Cause**: Our local overlap detection (area-based) misses subtle overlaps that Kaggle detects.

**Solution Found**: Use Shapely's `relate()` method which detects overlaps more accurately:
```python
def check_overlaps_relate(trees):
    for i in range(len(polygons)):
        for j in range(i+1, len(polygons)):
            relate = polygons[i].relate(polygons[j])
            # relate[0] == '2' means 2D interior intersection
            if relate[0] == '2':
                return True, (i, j)
    return False, None
```

The analysis in `exploration/evolver_loop5_analysis.ipynb` found N=60 has an overlap via relate() method.

## Response to Evaluator

The evaluator recommended:
1. ✅ Submit safe_ensemble - We tried, it FAILED with "Overlapping trees in group 060"
2. ✅ Implement fix_direction - Good idea, but won't close 1.79 point gap
3. ✅ Run bbox3 with multiple parameters - Already tried, NO improvement

**Key Insight**: The evaluator's recommendations are for MICRO-OPTIMIZATION. With a 1.79 point gap, we need FUNDAMENTALLY DIFFERENT approaches.

## EXPERIMENT 005: Create Truly Valid Submission + fix_direction

### Goal
1. Create a submission that PASSES Kaggle validation using relate() method
2. Apply fix_direction to squeeze out 0.01-0.05 points
3. Submit to verify it passes Kaggle

### Steps

**Step 1: Create Truly Valid Ensemble**
```python
# Use relate() method to find ALL overlapping N values
def check_overlaps_relate(trees):
    polygons = [t.polygon for t in trees]
    for i in range(len(polygons)):
        for j in range(i+1, len(polygons)):
            relate = polygons[i].relate(polygons[j])
            if relate[0] == '2':  # 2D interior intersection
                return True, (i, j)
    return False, None

# Scan ALL N values
problematic_ns = []
for n in range(1, 201):
    trees = load_trees_for_n(ensemble_df, n)
    has_overlap, _ = check_overlaps_relate(trees)
    if has_overlap:
        problematic_ns.append(n)

# Replace problematic N values with baseline
for n in problematic_ns:
    # Replace ensemble N with baseline N
```

**Step 2: Apply fix_direction (from bbox3 runner kernel)**
```python
from scipy.optimize import minimize_scalar
from scipy.spatial import ConvexHull

def optimize_rotation(trees, angle_max=89.999, epsilon=1e-7):
    all_points = []
    for tree in trees:
        all_points.extend(list(tree.polygon.exterior.coords))
    points_np = np.array(all_points)
    hull_points = points_np[ConvexHull(points_np).vertices]
    
    res = minimize_scalar(
        lambda a: calculate_bbox_side_at_angle(a, hull_points),
        bounds=(0.001, angle_max),
        method="bounded",
    )
    return res.x, res.fun

# Apply to each N value
for n in range(1, 201):
    trees = load_trees_for_n(submission_df, n)
    best_angle, best_side = optimize_rotation(trees)
    if best_side < current_side:
        # Apply rotation and update submission
```

**Step 3: Verify and Submit**
- Verify no overlaps using relate() method
- Submit to Kaggle to confirm it passes validation

### Expected Outcome
- Valid submission that passes Kaggle
- Score improvement of 0.01-0.05 points from fix_direction
- New baseline for further optimization

## EXPERIMENT 006: Research Fundamentally Different Approaches

### The Gap Problem
- Current best: 70.676102 (LB)
- Target: 68.888293
- Gap: 1.79 points (2.6%)

This gap is TOO LARGE for micro-optimization. We need fundamentally different approaches.

### Research Topics
1. **Tessellation patterns for large N** - Chris Deotte's discussion suggests tessellations for N>58
2. **Asymmetric solutions** - Discussion "Why the winning solutions will be Asymmetric" (39 votes)
3. **Different packing strategies for small N** - N=1-10 contribute 4.33 points (6.1% of total)

### WebSearch Queries
```
WebSearch("What techniques do top Kaggle Santa 2025 competitors use to achieve scores below 69?")
WebSearch("How do tessellation patterns help in 2D polygon packing optimization?")
WebSearch("What is the theoretical minimum score for Christmas tree packing problem?")
```

## What NOT to Try
- ❌ Running bbox3/SA with "more iterations" - already at local optima
- ❌ Ensemble submissions without relate() validation - will fail Kaggle
- ❌ Micro-optimization when gap is 1.79 points

## Validation Notes
- Use relate() method for overlap detection, NOT area-based
- Always verify submission passes relate() check before submitting
- Target: Create a valid submission that passes Kaggle, then optimize

## SUBMISSION STRATEGY
- Remaining submissions: 96/100 - ABUNDANT!
- Submit after EVERY valid experiment
- LB feedback is FREE information - USE IT!
