# Santa 2025 - Christmas Tree Packing Challenge - Loop 8 Strategy

## Current Status
- Best CV score: 70.676102 from exp_000 (baseline)
- Best LB score: 70.676102 (ONLY submission that passed Kaggle validation!)
- Target: 68.888293 | Gap to target: 1.79 points (2.6%)
- Submissions used: 5/100 (93 remaining - ABUNDANT!)

## ⚠️ CRITICAL PROBLEM IDENTIFIED

**The ensemble approach is BROKEN:**
- 4 consecutive ensemble submissions FAILED Kaggle validation (exp_001, exp_002, exp_004, exp_005)
- All failed with "Overlapping trees in group XXX" errors
- Local overlap detection CANNOT match Kaggle's validation (uses Decimal with scale_factor=1e18)
- The baseline (70.676102) is the ONLY submission that passed Kaggle

**WRONG STRATEGY (what we've been doing):**
- Trying to DETECT overlaps perfectly → IMPOSSIBLE due to floating-point precision differences

**CORRECT STRATEGY (what we should do):**
- REPAIR overlaps by replacing questionable N values with baseline configurations
- The baseline is KNOWN to pass Kaggle, so any N from baseline is guaranteed valid

## Response to Evaluator

The evaluator correctly identified that:
1. We've been spinning on overlap detection for 4 experiments with no valid improvement
2. The `repair_overlaps_in_place()` function from bbox3 runner kernel is the correct approach
3. `fix_direction` rotation optimization hasn't been tried on baseline
4. Multi-phase bbox3 with different (n, r) parameters hasn't been tried

**I AGREE with all these points.** The strategy must change from "detect overlaps" to "repair overlaps conservatively".

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY] Apply fix_direction to baseline**
This is a QUICK WIN that could improve baseline by 0.01-0.05 points with ZERO risk of overlap issues.

**Implementation from bbox3 runner kernel:**
```python
from scipy.optimize import minimize_scalar
from scipy.spatial import ConvexHull
import numpy as np

def calculate_bbox_side_at_angle(angle_deg, points):
    angle_rad = np.radians(angle_deg)
    c, s = np.cos(angle_rad), np.sin(angle_rad)
    rot_matrix_T = np.array([[c, s], [-s, c]])
    rotated_points = points.dot(rot_matrix_T)
    min_xy = np.min(rotated_points, axis=0)
    max_xy = np.max(rotated_points, axis=0)
    return max(max_xy[0] - min_xy[0], max_xy[1] - min_xy[1])

def optimize_rotation(trees, angle_max=89.999, epsilon=1e-7):
    all_points = []
    for tree in trees:
        all_points.extend(list(tree.polygon.exterior.coords))
    points_np = np.array(all_points)
    
    hull_points = points_np[ConvexHull(points_np).vertices]
    initial_side = calculate_bbox_side_at_angle(0, hull_points)
    
    res = minimize_scalar(
        lambda a: calculate_bbox_side_at_angle(a, hull_points),
        bounds=(0.001, angle_max),
        method="bounded",
    )
    return res.x, res.fun, initial_side
```

**Expected outcome:** 0.01-0.05 point improvement, guaranteed valid (no overlap changes)

### 2. **[HIGH PRIORITY] Implement repair_overlaps_in_place strategy**
For any ensemble/optimization that produces overlaps, replace those N values with baseline.

### 3. **[MEDIUM PRIORITY] Run multi-phase bbox3 with repair**
Phase A: n=[1000,1200,1500,1800,2000], r=[30,60,90], timeout=2min
After each run, apply repair_overlaps_in_place to guarantee validity.

## ⛔ BLOCKED APPROACHES (DO NOT USE)

- ❌ Ensemble submissions without repair strategy - FAILED 4 TIMES
- ❌ Local overlap detection to validate submissions - DOESN'T MATCH KAGGLE
- ❌ Any approach that produces overlaps and tries to "fix" detection - WRONG STRATEGY

## Experiment Plan for exp_007

**Goal:** Apply fix_direction to baseline and submit to get LB feedback

**Steps:**
1. Load baseline submission (70.676102)
2. Implement fix_direction from bbox3 runner kernel
3. Apply to all N values (1-200)
4. Calculate new score
5. Submit to Kaggle (we have 93 submissions - use them!)

**Expected outcome:**
- Score improvement: 0.01-0.05 points
- Validity: GUARANTEED (no overlap changes, just rotation)
- LB feedback: Confirms fix_direction works

## SUBMISSION STRATEGY
- Remaining submissions: 93
- Submit after this experiment? **YES** - we need LB feedback on fix_direction
- Even small improvements are progress toward the target