# Santa 2025 - Christmas Tree Packing Challenge - Loop 6 Strategy

## Current Status
- Best CV score: 70.615788 from 005_fixed_submission (EXISTS BUT NOT LOGGED!)
- Best LB score: 70.676102 from exp_000 (baseline) - ONLY submission that passed Kaggle!
- Target: 68.888293 | Gap to target: 1.79 points (2.6%)
- Submissions remaining: 96/100

## ⚠️ CRITICAL: 005_fixed_submission EXISTS BUT NOT LOGGED ⚠️

The executor created `/home/code/experiments/005_fixed_submission/` with:
- submission.csv (score: 70.615788)
- metrics.json (is_valid: true, problematic_ns_fixed: [60])
- Verified NO overlaps using relate() method in `exploration/evolver_loop5_analysis.ipynb`

**FIRST ACTION: Log this experiment and submit it!**

## Response to Evaluator

The evaluator correctly identified:
1. ✅ Safe ensemble needs to be submitted - We tried exp_004, it FAILED with "Overlapping trees in group 060"
2. ✅ fix_direction not implemented - Good idea, but won't close 1.79 point gap alone
3. ✅ bbox3 with multiple parameters - Already tried, NO improvement

**Key Insight**: The evaluator's recommendations are for MICRO-OPTIMIZATION. With a 1.79 point gap, we need FUNDAMENTALLY DIFFERENT approaches. However, we should first verify our fixed submission passes Kaggle.

## EXPERIMENT 005: Log and Submit Fixed Submission

### Goal
Log the existing 005_fixed_submission and submit it to verify it passes Kaggle validation.

### Steps
1. **Log experiment** with LogExperiment:
   - name: "005_fixed_submission"
   - model_type: "optimization"
   - cv_score: 70.615788
   - submission_path: "/home/code/experiments/005_fixed_submission/submission.csv"
   - experiment_folder: "/home/code/experiments/005_fixed_submission"
   - notes: "Fixed ensemble using relate() method for overlap detection. Replaced N=60 with baseline configuration. Verified no overlaps using relate() method. This should pass Kaggle validation where exp_004 failed."

2. **Copy submission** to /home/submission/submission.csv (verify it's there)

3. **Submit to Kaggle** to verify it passes validation

### Expected Outcome
- If passes: New best LB score of ~70.615788 (0.06 points better than baseline)
- If fails: Need to investigate Kaggle's exact overlap detection method further

## EXPERIMENT 006: Implement fix_direction Optimization

### Goal
Apply fix_direction (rotation optimization) to squeeze out 0.01-0.05 points.

### Implementation (from bbox3 runner kernel - 370 votes)
```python
from scipy.optimize import minimize_scalar
from scipy.spatial import ConvexHull
import numpy as np

def calculate_bbox_side_at_angle(angle_deg, points):
    """Calculate bounding box side at a given rotation angle."""
    angle_rad = np.radians(angle_deg)
    c, s = np.cos(angle_rad), np.sin(angle_rad)
    rot_matrix_T = np.array([[c, s], [-s, c]])
    rotated_points = points.dot(rot_matrix_T)
    min_xy = np.min(rotated_points, axis=0)
    max_xy = np.max(rotated_points, axis=0)
    return max(max_xy[0] - min_xy[0], max_xy[1] - min_xy[1])

def optimize_rotation(trees, angle_max=89.999, epsilon=1e-7):
    """Find optimal rotation angle to minimize bounding box."""
    all_points = []
    for tree in trees:
        all_points.extend(list(tree.polygon.exterior.coords))
    points_np = np.array(all_points)
    hull_points = points_np[ConvexHull(points_np).vertices]
    
    initial_side = calculate_bbox_side_at_angle(0, hull_points)
    
    res = minimize_scalar(
        lambda a: calculate_bbox_side_at_angle(a, hull_points),
        bounds=(0.001, angle_max),
        method="bounded",
    )
    
    if initial_side - res.fun > epsilon:
        return res.x, res.fun
    return 0.0, initial_side

def apply_rotation(trees, angle_deg):
    """Apply rotation to all trees around their collective center."""
    if abs(angle_deg) < 1e-12:
        return trees
    
    # Find center of all trees
    bounds = [t.polygon.bounds for t in trees]
    min_x = min(b[0] for b in bounds)
    min_y = min(b[1] for b in bounds)
    max_x = max(b[2] for b in bounds)
    max_y = max(b[3] for b in bounds)
    center = np.array([(min_x + max_x) / 2.0, (min_y + max_y) / 2.0])
    
    # Rotate each tree
    angle_rad = np.radians(angle_deg)
    c, s = np.cos(angle_rad), np.sin(angle_rad)
    rot_matrix = np.array([[c, -s], [s, c]])
    
    rotated_trees = []
    for tree in trees:
        # Rotate center position
        pos = np.array([float(tree.center_x), float(tree.center_y)])
        new_pos = (pos - center).dot(rot_matrix.T) + center
        
        # Create new tree with rotated position and angle
        new_tree = ChristmasTree(
            center_x=str(new_pos[0]),
            center_y=str(new_pos[1]),
            angle=str(float(tree.angle) + angle_deg)
        )
        rotated_trees.append(new_tree)
    
    return rotated_trees

# Apply to each N value
for n in range(1, 201):
    trees = load_trees_for_n(submission_df, n)
    best_angle, best_side = optimize_rotation(trees)
    if best_angle > 0:
        rotated_trees = apply_rotation(trees, best_angle)
        # Update submission_df with rotated trees
        # Verify no overlaps after rotation
```

### Expected Outcome
- Score improvement of 0.01-0.05 points
- Valid submission that passes Kaggle

## STRATEGIC ANALYSIS: THE GAP PROBLEM

### Current Situation
- Gap to target: 1.79 points (2.6%)
- C++ optimizers (bbox3, SA) found NO improvement
- Both baseline and ensemble are at local optima

### Why Micro-Optimization Won't Work Alone
- fix_direction: ~0.01-0.05 points
- Fractional translation: ~0.001-0.01 points
- Total possible: ~0.06 points
- Gap remaining: 1.73 points

### What We Need: Fundamentally Different Approaches

1. **Tessellation Patterns for Large N**
   - Chris Deotte's discussion suggests tessellations for N>58
   - Crystalline/lattice packing instead of chaotic SA

2. **Asymmetric Solutions**
   - Discussion "Why the winning solutions will be Asymmetric" (39 votes)
   - Symmetric solutions may not be optimal for all N

3. **Different Packing Strategies for Small N**
   - N=1-10 contribute 4.33 points (6.1% of total)
   - Small N has lowest packing efficiency
   - Potential for significant improvement

## What NOT to Try
- ❌ Running bbox3/SA with "more iterations" - already at local optima
- ❌ Ensemble submissions without relate() validation - will fail Kaggle
- ❌ Micro-optimization alone when gap is 1.79 points

## SUBMISSION STRATEGY
- Remaining submissions: 96/100 - ABUNDANT!
- Submit after EVERY valid experiment
- LB feedback is FREE information - USE IT!

## Priority Order
1. **IMMEDIATE**: Log 005_fixed_submission and SUBMIT to Kaggle
2. **HIGH**: Implement fix_direction optimization
3. **MEDIUM**: Research tessellation patterns for large N
4. **MEDIUM**: Research asymmetric solutions
