# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.676102 from exp_000 (001_baseline)
- Best LB score: N/A (not yet submitted)
- Target: 68.919154 | Gap to target: 1.756948 (2.55%)

## Public Kernel Status (CRITICAL!)
- Have we implemented the best kernel yet? **NO**
- Top kernels identified:
  1. jonathanchan/santa25-ensemble-sa-fractional-translation (174 votes) - Uses fractional translation + population-based SA
  2. egortrushin/santa25-simulated-annealing-with-translations (126 votes) - SA with translations
  3. chistyakov/santa-2025-simple-optimization-new-slow-version (128 votes) - Slow but thorough optimization
- Kernels we've implemented: None (just loaded pre-optimized CSV)
- Kernels still to implement: ALL of the above
- **CRITICAL**: We need to implement the jonathanchan kernel's approach!

## Response to Evaluator
The evaluator correctly identified that:
1. N=1 is already at optimal 45-degree angle (confirmed by exhaustive search)
2. Small N values (1-10) have highest score contribution but N=1 cannot be improved
3. Standard optimizers found NO improvements on the pre-optimized CSV
4. Need fundamentally different approaches: lattice packing, fractional translation, longer runs

I agree with the evaluator's assessment. The key insight from the jonathanchan kernel is:
- **Fractional translation** with micro-steps (0.001 down to 0.00001)
- **Population-based optimization** keeping top 3 candidates
- **Perturbation** to escape local optima
- **Multiple generations** of optimization

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Implement sa_v1_parallel.cpp with Fractional Translation
The jonathanchan kernel's C++ optimizer is the key to sub-68 scores:
```bash
# Compile
g++ -O3 -march=native -std=c++17 -fopenmp -o sa_v1_parallel sa_v1_parallel.cpp

# Run with high iterations
./sa_v1_parallel -i submission.csv -o submission.csv -n 20000 -r 80
```

Key features to implement:
- `fractional_translation()` function with steps: 0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001
- `opt_v3()` with population-based approach (keep top 3)
- `perturb()` function to escape local optima
- Multiple generations with no_improvement_count tracking

### 2. **[HIGH PRIORITY]** Ensemble from Multiple Sources
The jonathanchan kernel ensembles from 19+ sources:
- bucket-of-chump
- santa-2025-csv
- telegram submissions
- Various kernel outputs

For each N, keep the best configuration from all sources.

### 3. **[MEDIUM PRIORITY]** Lattice-Based Packing for Large N
For N >= 58 (especially 72, 100, 144, 196, 200):
- Start with two base trees in optimal configuration
- Translate in x and y to create grid pattern
- Parameters: nx * ny >= N
- This generates crystalline packings

### 4. **[MEDIUM PRIORITY]** Much Longer Optimization Runs
Top solutions run for HOURS:
- `-n 20000+` iterations
- `-r 80+` rounds
- Multiple generations
- Let it run overnight if needed

## What NOT to Try
- Simple SA on pre-optimized CSV (already tried, no improvements)
- Backward propagation (already tried, no improvements)
- Improving N=1 (already optimal at 45 degrees)
- Short optimization runs (need hours, not minutes)

## Validation Notes
- This is an optimization problem, not ML - CV = LB by definition
- No overlaps allowed - use Shapely STRtree for fast overlap detection
- Preserve precision with 's' prefix in submission format
- Total rows: 20100 (1+2+3+...+200)

## SUBMISSION STRATEGY
- Remaining submissions: 95
- Submit after this experiment? **YES** - we have abundant submissions and need LB feedback
- Submit the baseline first to establish LB score, then iterate

## Key Technical Details

### Tree Geometry
```python
TX = [0, 0.125, 0.0625, 0.2, 0.1, 0.35, 0.075, 0.075, -0.075, -0.075, -0.35, -0.1, -0.2, -0.0625, -0.125]
TY = [0.8, 0.5, 0.5, 0.25, 0.25, 0, 0, -0.2, -0.2, 0, 0, 0.25, 0.25, 0.5, 0.5]
```

### Scoring Function
```python
score = sum(side_n**2 / n for n in range(1, 201))
```

### Pre-optimized Files
- Best: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/santa-2025-csv/santa-2025.csv` (70.676102)
- bbox3 binary: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/bbox3`

### C++ Optimizer Source
The sa_v1_parallel.cpp from jonathanchan kernel is in:
`/home/code/research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`

## Next Experiment Plan
1. Extract and compile sa_v1_parallel.cpp from jonathanchan kernel
2. Run with high iterations: `-n 20000 -r 80`
3. Apply fractional translation post-processing
4. Validate no overlaps
5. Submit to get LB feedback
