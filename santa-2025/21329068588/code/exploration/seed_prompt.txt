# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.627582 (from validated snapshot)
- Best LB score: N/A (first submission failed with overlap error)
- Target: 68.894234 | Gap to target: 1.733 points (2.5%)

## CRITICAL ISSUE DISCOVERED
**The baseline submission failed because Kaggle's overlap detection is STRICTER than local Shapely checks.**

Key findings:
1. The submission at `/home/nonroot/snapshots/santa-2025/21328309254/code/submission.csv` (score 70.647327) has overlaps that Kaggle detects but our local check misses
2. The "ensemble_best.csv" scoring 27.4 has MASSIVE overlaps (0.18 area per pair!) - it's completely invalid
3. Found a Kaggle-validated submission at `/home/nonroot/snapshots/santa-2025/21198893057/code/submission.csv` with confirmed LB score 70.627582

## Response to Evaluator
The evaluator correctly identified that:
1. No actual optimization code has been written yet - AGREED, we need to implement optimizers
2. The ensemble approach from top kernels hasn't been explored - AGREED, but we discovered that naive ensembles create overlaps
3. 105 snapshots are available but only one is being used - AGREED, but we found most have overlap issues

**Key insight from this loop:** We cannot trust local overlap checks. We must either:
- Use submissions that have been validated by Kaggle (from session_state.json in snapshots)
- Implement the exact same overlap detection as Kaggle (using high-precision Decimal arithmetic with scale_factor=1e15)

## Validated Submissions Found (from snapshot session_state.json)
These submissions have been confirmed valid by Kaggle:
1. `/home/nonroot/snapshots/santa-2025/21198893057/code/submission.csv` - LB: 70.627582
2. Various other submissions with LB scores around 70.63-70.65

## Recommended Approaches (Priority Order)

### 1. [HIGHEST PRIORITY] Submit the Validated Baseline
Use the Kaggle-validated submission at `/home/nonroot/snapshots/santa-2025/21198893057/code/submission.csv` (score 70.627582).
This is already copied to `/home/submission/submission.csv`.

### 2. [HIGH PRIORITY] Implement Proper Overlap Detection
Before running any optimization, implement the exact overlap detection from the Getting Started kernel:
- Use `Decimal` with `getcontext().prec = 25`
- Use `scale_factor = Decimal('1e15')` for polygon coordinates
- Check `intersects() and not touches()` for overlap detection

### 3. [HIGH PRIORITY] Run bbox3 Optimizer on Validated Baseline
The bbox3.cpp optimizer from kernels can improve scores. Run it on the validated baseline:
```bash
./bbox3 -i submission.csv -o optimized.csv -n 5000 -r 50
```
But VALIDATE the output before submitting!

### 4. [MEDIUM PRIORITY] Implement Simulated Annealing with Validation
The SA approach from kernels works, but must validate after each improvement:
- Fractional translation steps: [0.001, 0.0005, 0.0002, 0.0001]
- 8 directions per step
- Validate no overlaps after each move

### 5. [MEDIUM PRIORITY] Focus on Small N Values (2-20)
These have the highest score contribution and lowest efficiency:
- N=2: 0.338 (efficiency ~49%)
- N=3: 0.263 (efficiency ~47%)
- N=4: 0.199 (efficiency ~50%)
- N=5: 0.207 (efficiency ~48%)

## What NOT to Try
- Naive ensembles that combine solutions without validation (creates overlaps)
- Trusting local Shapely overlap checks (Kaggle is stricter)
- Using the "ensemble_best.csv" or similar files with score < 50 (they have massive overlaps)
- Low-precision coordinates (use 20+ decimal places)

## Technical Notes

### Kaggle's Overlap Detection (from Getting Started kernel)
```python
from decimal import Decimal, getcontext
from shapely import affinity
from shapely.geometry import Polygon

getcontext().prec = 25
scale_factor = Decimal('1e15')

# Polygon coordinates must be scaled by scale_factor
# Overlap check: intersects() and not touches()
```

### Scoring Formula
score = Σ(s_n²/n) for n=1 to 200
- N=1 contributes ~0.66 (already optimal at 45 degrees)
- Small N values (1-20) contribute most to total score

## Submission Strategy
- Remaining submissions: 98
- **SUBMIT IMMEDIATELY** with the validated baseline (70.627582)
- This establishes a valid LB score and confirms our validation approach
- Then iterate with optimization

## Validation Checklist
Before ANY submission:
1. Use high-precision Decimal arithmetic for overlap checks
2. Verify all 200 groups have no overlaps
3. Verify coordinate precision (20+ decimal places)
4. Compare score to known valid submissions
