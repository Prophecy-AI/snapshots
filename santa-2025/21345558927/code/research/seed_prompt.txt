# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- **Best Valid LB Score: 70.365091** (exp_010 - PASSED Kaggle validation)
- **Target: 68.879467** (lower is better)
- **Gap to target: 1.49 points (2.1% improvement needed)**
- **Submissions: 7/100 used, 93 remaining**

## üö® CRITICAL DISCOVERY: EXTERNAL DATA IS BETTER!

**External santa-2025.csv scores 70.348933 - BETTER than our exp_010 (70.365091)!**

Analysis shows:
- External is better for **52 N values**
- exp_010 is better for only **6 N values**
- **Potential combined score: 70.341433** (improvement of 0.024 over exp_010)

## Submission Log
| Exp | Approach | CV | LB | Status |
|-----|----------|----|----|--------|
| 000 | baseline ensemble | 70.523 | - | ‚ùå FAILED |
| 001 | valid baseline | 70.615 | 70.615 | ‚úÖ PASSED |
| 002 | backward propagation | 70.615 | 70.615 | ‚úÖ PASSED |
| 007 | ensemble fractional | 70.266 | - | ‚ùå FAILED |
| 008 | snapshot ensemble | 70.373 | - | ‚ùå FAILED |
| 009 | highprec ensemble | 70.341 | - | ‚ùå FAILED |
| 010 | safe ensemble | 70.365 | 70.365 | ‚úÖ PASSED |

## ‚õî FORBIDDEN
- bbox3, sa_fast, eazy_optimizer, tree_packer - FORBIDDEN
- subprocess.run() or os.system() with binaries - FORBIDDEN
- Running ANY binary or executable - FORBIDDEN

## ‚úÖ MANDATORY NEXT EXPERIMENT: MEGA-ENSEMBLE WITH EXTERNAL DATA

### Create experiment 012_mega_ensemble

**CRITICAL: Use MIN_IMPROVEMENT=0.001 threshold to avoid overlap failures!**

```python
import pandas as pd
import sys
import os
import glob
sys.path.insert(0, '/home/code')

from code.tree_geometry import calculate_score, get_tree_vertices_numba
from code.utils import parse_submission, save_submission
from decimal import Decimal, getcontext
from shapely.geometry import Polygon

getcontext().prec = 30
SCALE = 10**18
MIN_IMPROVEMENT = 0.001  # Safe threshold - DO NOT LOWER!

def get_tree_polygon_highprec(x, y, angle_deg):
    """Get tree polygon with high-precision integer coordinates."""
    rx, ry = get_tree_vertices_numba(x, y, angle_deg)
    coords = []
    for xi, yi in zip(rx, ry):
        xi_int = int(Decimal(str(xi)) * SCALE)
        yi_int = int(Decimal(str(yi)) * SCALE)
        coords.append((xi_int, yi_int))
    return Polygon(coords)

def validate_no_overlap_strict(trees):
    """Validate no overlaps using integer arithmetic."""
    if len(trees) <= 1:
        return True
    
    polygons = []
    for x, y, angle in trees:
        poly = get_tree_polygon_highprec(x, y, angle)
        if not poly.is_valid:
            return False
        polygons.append(poly)
    
    for i in range(len(polygons)):
        for j in range(i+1, len(polygons)):
            if polygons[i].intersects(polygons[j]):
                if not polygons[i].touches(polygons[j]):
                    inter = polygons[i].intersection(polygons[j])
                    if inter.area > 0:
                        return False
    return True

# Load baseline for fallback
baseline_df = pd.read_csv('/home/code/experiments/001_valid_baseline/submission.csv')
baseline_configs = parse_submission(baseline_df)
baseline_scores = {n: calculate_score(baseline_configs[n]) for n in range(1, 201)}

# Load all sources
sources = {}

# 1. exp_010 (our current best)
sources['exp_010'] = parse_submission(pd.read_csv('/home/code/experiments/010_safe_ensemble/submission.csv'))

# 2. External data
external_files = [
    '/home/code/external_data/santa-2025.csv',
    '/home/code/external_data/70.378875862989_20260126_045659.csv',
    '/home/code/external_data/submission.csv',
]
for f in external_files:
    if os.path.exists(f):
        try:
            df = pd.read_csv(f)
            if 'id' in df.columns and len(df) == 20100:
                sources[f.split('/')[-1]] = parse_submission(df)
        except:
            pass

# 3. Internal snapshots (sample for speed)
snapshot_files = glob.glob('/home/nonroot/snapshots/santa-2025/**/*.csv', recursive=True)
for f in snapshot_files[:500]:  # Sample first 500
    try:
        df = pd.read_csv(f)
        if 'id' in df.columns and len(df) == 20100:
            sources[f] = parse_submission(df)
    except:
        pass

print(f"Loaded {len(sources)} sources")

# Build mega-ensemble
best_per_n = {}
improvements = []

for n in range(1, 201):
    best_score = baseline_scores[n]
    best_config = baseline_configs[n]
    best_source = "baseline"
    
    for source_name, configs in sources.items():
        if n not in configs:
            continue
        
        config = configs[n]
        if len(config) != n:
            continue
        
        score = calculate_score(config)
        improvement = best_score - score
        
        # Only accept if significant improvement AND valid
        if improvement > MIN_IMPROVEMENT:
            if validate_no_overlap_strict(config):
                best_score = score
                best_config = config
                best_source = source_name
    
    best_per_n[n] = best_config
    
    if best_source != "baseline":
        improvements.append((n, baseline_scores[n] - best_score, best_source))

# Calculate final score
final_total = sum(calculate_score(best_per_n[n]) for n in range(1, 201))
print(f"Final score: {final_total:.6f}")
print(f"Improvements: {len(improvements)}")

# Save submission
save_submission(best_per_n, 'submission.csv')
```

### SUBMIT THE RESULT
After creating the mega-ensemble, SUBMIT IT to get LB feedback.
We have 93 submissions remaining - use them!

## Expected Outcome
- Mega-ensemble should score around **70.34** (improvement of ~0.025 over exp_010)
- If it passes validation, this is our new best
- Still need ~1.46 points more to reach target

## External Data Sources Available
1. `/home/code/external_data/santa-2025.csv` - Score: 70.348933 ‚úÖ BETTER THAN exp_010
2. `/home/code/external_data/70.378875862989_20260126_045659.csv` - Score: 70.378876
3. `/home/code/external_data/submission.csv` - Score: 70.647327

## Per-N Analysis (External vs exp_010)
Top N values where external is better:
- N=87: +0.000969
- N=69: +0.000946
- N=47: +0.000877
- N=116: +0.000875
- N=139: +0.000829

## What NOT to Try
- ‚ùå Fractional translation (found NO improvements)
- ‚ùå Rotation optimization (found NO improvements)
- ‚ùå Running C++ binaries (FORBIDDEN)
- ‚ùå Small improvements below MIN_IMPROVEMENT=0.001 (causes overlap failures)

## Gap Analysis
| Score | Status | Gap to Target |
|-------|--------|---------------|
| 70.615 | Valid baseline | 1.74 points |
| 70.365 | exp_010 (current best) | 1.49 points |
| 70.341 | Potential mega-ensemble | 1.46 points |
| 68.879 | TARGET | 0 points |
