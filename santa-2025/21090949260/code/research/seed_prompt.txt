# Christmas Tree Packing Optimization - Evolved Seed Prompt (Loop 3)

## Current Status
- Best CV score: 84.894026 from exp_002 (ensemble_cpp_optimizer)
- Best LB score: 117.281454 (exp_001) - exp_002 failed due to overlapping trees
- Target: 68.931058 | Gap to target: 15.96 points (23.2%)
- Fixed version available: 84.901044 (004_ensemble_fixed) - needs submission

## CRITICAL: exp_002 Submission Failed!
The submission failed with "Overlapping trees in group 193". The overlap was present in the ensemble baseline (came from a source CSV). A fixed version exists at `/home/code/experiments/004_ensemble_fixed/submission.csv` with score 84.901044.

**IMMEDIATE ACTION REQUIRED:**
1. Log the fixed version as a new experiment (exp_003)
2. Submit it to get LB feedback
3. Verify CV-LB alignment for this optimization problem

## Response to Evaluator
The evaluator correctly identified:
1. ✅ The ensemble approach was a MAJOR breakthrough (117.28 → 84.89)
2. ✅ Optimization time was limited (~10 min vs 3-hour budgets in top kernels)
3. ✅ Backward propagation had diminishing returns (only 2 improvements)
4. ⚠️ The submission needed to be made - but it FAILED due to overlaps

**Key insight from evaluator**: The gap to target is still 15.96 points (23.2%). This requires:
- Longer optimization runs (30-60+ minutes)
- Targeted optimization of worst-performing N values
- Better source solutions for ensemble

## Leaderboard Context
- #1: 71.19 (terry_u16)
- #2: 71.19 (c-number)
- Our target: 68.93 (BETTER than current #1!)
- Our best CV: 84.89
- Gap to #1: 13.7 points

**The target of 68.93 is EXTREMELY ambitious** - it's better than the current leaderboard leader! This suggests either:
1. The target is based on theoretical/optimal solutions not yet achieved publicly
2. We need breakthrough techniques beyond what's in public kernels

## CV-LB Relationship Analysis
From 2 successful submissions:
- exp_000: CV=135.82, LB=135.82 (perfect match)
- exp_001: CV=117.28, LB=117.28 (perfect match)

**This is a deterministic optimization problem** - CV and LB should match exactly. The "Overlapping trees" error is a validation failure, not a CV-LB gap issue.

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Submit Fixed Ensemble (exp_003)
- Log `/home/code/experiments/004_ensemble_fixed/submission.csv` as exp_003
- Submit to verify LB score matches CV (84.90)
- This validates our ensemble approach works

### 2. **[HIGH PRIORITY]** Extended Optimization Run
The current optimization ran for ~10 minutes. Top kernels use 3-hour budgets:
```
Phase A: 5 parameter combinations × 2 min each = 10 min
Phase B: Top 3 candidates × 10 min each = 30 min  
Phase C: Best 2 candidates × 20 min each = 40 min
Total: ~80 min
```
Run the C++ optimizer with higher iterations (-n 50000 -r 200) for 30-60 minutes.

### 3. **[HIGH PRIORITY]** Target Worst-Performing N Values
Top 20 worst N values contribute 11.37% of total score:
- N=1: score 0.66 (worst efficiency)
- N=19, 49, 21, 31, 20, 50, 37, 25, 53...

For these specific N values:
- Run dedicated optimization with more iterations
- Try different initialization strategies
- Use grid-like arrangements for near-square N values (e.g., N=100=10×10)

### 4. **[MEDIUM PRIORITY]** Translation-Based Initialization
The zaburo kernel (88.33 score) uses well-aligned initial solutions:
- For N values that are perfect squares or near-rectangles
- Create grid-like arrangements as starting points
- Examples: N=72=8×9, N=100=10×10, N=144=12×12, N=196=14×14

### 5. **[MEDIUM PRIORITY]** Forward Propagation
Instead of backward propagation (N=200→1), try forward:
- Start from N=1 with optimal single-tree placement
- For N+1, add one tree to the N configuration
- This may find different local optima

### 6. **[LOWER PRIORITY]** Better Source Solutions
The 74.75 kernel uses ensemble from `/kaggle/input/*/*.csv` which likely contains pre-computed high-quality solutions. We need to:
- Search for Kaggle datasets with Santa 2025 solutions
- Check if any public datasets have scores < 80

## What NOT to Try
- ❌ Submitting exp_002 again (already failed, overlap issue)
- ❌ Short optimization runs (< 10 min) - diminishing returns
- ❌ Ignoring overlap validation before submission
- ❌ Expecting to reach 68.93 easily - it's better than current #1!

## Validation Notes
- **ALWAYS validate for overlaps before submission**
- Use STRtree for efficient collision detection
- Replace overlapping groups with valid configurations from donor files
- The overlap in group 193 came from the ensemble baseline source

## Technical Details

### Overlap Detection Code
```python
from shapely.strtree import STRtree

def has_overlap(trees):
    if len(trees) <= 1:
        return False
    polygons = [t.polygon for t in trees]
    tree_index = STRtree(polygons)
    for i, poly in enumerate(polygons):
        for idx in tree_index.query(poly):
            if idx != i and poly.intersects(polygons[idx]) and not poly.touches(polygons[idx]):
                return True
    return False
```

### C++ Optimizer Parameters
Current: `-n 10000 -r 96` (~3 min per seed)
Recommended: `-n 50000 -r 200` (~15-20 min per seed)

### Ensemble Building
```python
# For each N (1-200), pick the best configuration across all sources
for n in range(1, 201):
    best_score = float('inf')
    for source in all_sources:
        if source_scores[n] < best_score and not has_overlap(source_trees[n]):
            best_score = source_scores[n]
            best_config = source_config[n]
```

## SUBMISSION STRATEGY
- Remaining submissions: 98
- Submit after EVERY experiment with valid submission file
- LB feedback is FREE information - use it!
- Current priority: Submit fixed ensemble (exp_003) to validate approach

## Expected Outcomes
- Fixed ensemble submission: LB ≈ 84.90 (validates approach)
- Extended optimization (30-60 min): LB ≈ 80-82 (estimated)
- Targeted worst-N optimization: LB ≈ 78-80 (estimated)
- Reaching target 68.93: Requires breakthrough techniques or better source solutions

**Note**: The target of 68.93 is BETTER than the current #1 on the leaderboard (71.19). This is an extremely ambitious target that may require techniques not yet publicly available.
