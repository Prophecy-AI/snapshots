# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.647327 from baseline (exp_000)
- Best LB score: 70.647327 (verified)
- Target: 68.894234 | Gap to target: 1.75 points (2.5%)

## CRITICAL ISSUE: Submission Validation
- **exp_001 FAILED**: "Overlapping trees in group 040"
- best_snapshot.csv has near-overlaps (distance < 1e-6) that Kaggle's validator detects
- Our Shapely-based overlap check passes but Kaggle's stricter validator fails
- **ONLY baseline submission.csv is known to be valid**

## Response to Evaluator
The evaluator correctly identified that:
1. No actual optimization has been run - only combining existing solutions
2. The bbox3 optimizer is available but unused
3. The 1.73 point gap requires fundamentally different approaches

I agree with all points. The ensemble approach failed due to overlap issues, and we need to:
1. Use the baseline as the safe starting point
2. Run actual optimization (bbox3) to improve scores
3. Ensure all outputs pass Kaggle's strict overlap validation

## Key Insights from Research

### From bbox3 Runner Kernel (369 votes)
The kernel shows a 3-hour optimization strategy:
- **Phase A**: Short runs (2 min) with n=1000-2000, r=30-90 to find promising settings
- **Phase B**: Medium runs (10 min) on top candidates
- **Phase C**: Long runs (20 min) on best few
- **Critical**: Uses `repair_overlaps_in_place` to replace overlapping configs with baseline

### From Discussion Insights
- "Why the winning solutions will be Asymmetric" (38 votes) - asymmetric layouts outperform symmetric for large N
- "Symmetric solutions that are apparently optimal" (43 votes) - symmetric may be optimal for small N only
- Small N values (1-10) contribute 6.1% of score - high leverage targets

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Run bbox3 Optimizer with Overlap Repair
The bbox3 binary is available at `/home/code/preoptimized/bbox3`. Run it with:
```bash
chmod +x /home/code/preoptimized/bbox3
cp /home/code/preoptimized/submission.csv submission.csv
./bbox3 -n 2000 -r 60
```

**CRITICAL**: After running bbox3, must:
1. Apply rotation tightening (fix_direction)
2. Validate for overlaps using Kaggle-compatible check
3. Replace any overlapping configs with baseline configs
4. Only submit if ALL N values pass validation

### 2. **[HIGH PRIORITY]** Implement Overlap Repair Function
Create a function that:
- Checks each N configuration for overlaps
- If overlaps detected, replace with baseline configuration
- This ensures valid submissions while keeping improvements

### 3. **[MEDIUM PRIORITY]** Focus on Small N Values
N=1-10 contribute 6.1% of score. Try:
- Exhaustive angle search for N=2-10
- N=1 already optimal at 45Â°
- Small improvements here have outsized impact

### 4. **[LOWER PRIORITY]** Systematic Snapshot Scan
Scan all 100 snapshots in `/home/nonroot/snapshots/santa-2025/` for better per-N configurations.
But MUST validate each for overlaps before using.

## What NOT to Try
- Using best_snapshot.csv directly (has overlap issues)
- Ensembling without overlap validation
- Any submission without Kaggle-compatible overlap check

## Validation Requirements
1. **Overlap Check**: Must use stricter check than Shapely (near-overlaps with dist < 1e-6 fail)
2. **Fallback Strategy**: Replace any failing N with baseline config
3. **Score Verification**: Recalculate score after any replacements

## Submission Strategy
- Remaining submissions: 99
- Submit after EVERY valid experiment
- LB feedback is free - use it to calibrate

## Technical Details

### Overlap Repair Pattern (from bbox3 kernel)
```python
def repair_overlaps_in_place(submission_path, donor_path):
    """Replace overlapping configs with donor (baseline) configs"""
    # For each N, check overlaps
    # If overlaps found, copy config from donor
    # Return validation status and score
```

### Scoring Function
```python
@njit
def score_group(xs, ys, degs, tx, ty):
    # Calculate bounding box side length
    # Return side^2 / N
```

### Tree Vertices
```python
TX = [0,0.125,0.0625,0.2,0.1,0.35,0.075,0.075,-0.075,-0.075,-0.35,-0.1,-0.2,-0.0625,-0.125]
TY = [0.8,0.5,0.5,0.25,0.25,0,0,-0.2,-0.2,0,0,0.25,0.25,0.5,0.5]
```
