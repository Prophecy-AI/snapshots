# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- **Best CV score**: 70.647327 from exp_000 (001_baseline)
- **Best LB score**: N/A (no submissions yet)
- **Target**: 68.894234 | **Gap to target**: 1.75 points (2.5%)
- **Submissions**: 0/100 used, 100 remaining

## Response to Evaluator

The evaluator correctly identified several critical points:

1. **bbox3 binary won't work** - I verified this: the pre-compiled bbox3 binary requires GLIBC_2.34 which is not available in our environment. We need to compile from source.

2. **N=1 is already at 45째** - Verified! The baseline has N=1 at angle 44.999999999999744째 which is essentially 45째. This is optimal for a single tree.

3. **No optimization attempted yet** - Correct. The baseline verification was necessary, but now we need to actually optimize.

4. **Need LB submission** - Agreed. With 100 submissions available, we should submit the baseline to establish LB score.

## Key Findings from Research

### Available Optimization Tools (Source Code)
1. **bbox3.cpp** - Found in `research/kernels/jazivxt_why-not/why-not.ipynb`
   - Complex Number Vector Coordination, Fluid Dynamics, Hinge Pivot
   - Density Gradient Flow, Global Boundary Tension
   - aggressive_repair for overlap resolution
   - Parameters: `-n (iterations) -r (rounds)`

2. **sa_v1_parallel.cpp** - Found in `research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`
   - SA with fractional translation (0.001 to 0.00001 step sizes)
   - perturb function to escape local optima
   - ls_v3 local search after SA
   - Parameters: `-i input.csv -o output.csv -n 15000 -r 5`

### Critical Insight: Ensemble Already Optimal
The baseline submission.csv already dominates ALL N values across multiple sources. The ensemble of all available CSVs scores exactly the same (70.647327). This means:
- Standard optimization approaches have hit a local optimum
- We need fundamentally different approaches to improve

### Score Distribution
- N=1-10: 4.33 points (6.1% of total) - HIGH LEVERAGE
- N=11-20: 3.73 points
- N=21-50: 10.98 points
- N=51-100: 17.63 points
- N=101-150: 17.14 points
- N=151-200: 16.84 points

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY] Submit Baseline to LB**
- Verify local score matches LB
- Establish baseline for comparison
- Uses 1 of 100 submissions - worth it for calibration

### 2. **[HIGH PRIORITY] Compile and Run SA Optimizer**
Extract sa_v1_parallel.cpp from the kernel and compile:
```bash
g++ -O3 -march=native -std=c++17 -fopenmp -o sa_v1_parallel sa_v1_parallel.cpp
./sa_v1_parallel -i submission.csv -o submission_optimized.csv -n 20000 -r 10
```
This is the primary optimization tool used by top competitors.

### 3. **[HIGH PRIORITY] Focus on Small N Values (1-20)**
These contribute 8+ points (11% of total). For each N:
- Try exhaustive angle search with fine granularity (0.1째 steps)
- Try multiple random restarts
- Apply fractional translation refinement

### 4. **[MEDIUM PRIORITY] Compile bbox3 from Source**
Extract bbox3.cpp and compile:
```bash
g++ -O3 -march=native -std=c++17 -fopenmp -o bbox3 bbox3.cpp
./bbox3 -n 2000 -r 60
```

### 5. **[MEDIUM PRIORITY] Rotation Tightening (fix_direction)**
The bbox3 runner kernel shows a `fix_direction` function that optimizes the global rotation of each configuration to minimize bounding box. This is a cheap post-processing step.

### 6. **[LOWER PRIORITY] Lattice/Grid Approaches for Large N**
For N >= 58, try constructing solutions from scratch using:
- 2 base trees in specific configuration
- Translate in x and y directions to create grid pattern
- This approach is NOT being tried in current solutions

## What NOT to Try
- Running pre-compiled bbox3 binary (GLIBC mismatch)
- Simple micro-optimization of pre-optimized submission (already at local optimum)
- More ensemble sources (current best dominates all N)
- Running same optimizers with slightly different parameters

## Validation Checklist
1. No overlapping trees (use overlap detection)
2. All coordinates within [-100, 100]
3. All 200 configurations present (20100 rows total)
4. Values prefixed with 's' in submission

## Technical Details

### Tree Geometry
- 15-vertex polygon
- TX = [0,0.125,0.0625,0.2,0.1,0.35,0.075,0.075,-0.075,-0.075,-0.35,-0.1,-0.2,-0.0625,-0.125]
- TY = [0.8,0.5,0.5,0.25,0.25,0,0,-0.2,-0.2,0,0,0.25,0.25,0.5,0.5]

### Scoring Function
```python
@njit
def score_group(xs, ys, degs, tx, ty):
    n = xs.size
    V = tx.size
    mnx = mny = 1e300
    mxx = mxy = -1e300
    for i in range(n):
        r = degs[i] * math.pi / 180.0
        c = math.cos(r)
        s = math.sin(r)
        for j in range(V):
            X = c * tx[j] - s * ty[j] + xs[i]
            Y = s * tx[j] + c * ty[j] + ys[i]
            mnx = min(mnx, X)
            mxx = max(mxx, X)
            mny = min(mny, Y)
            mxy = max(mxy, Y)
    side = max(mxx - mnx, mxy - mny)
    return side * side / n
```

## SUBMISSION STRATEGY
- Remaining submissions: 100
- **Submit baseline NOW** to establish LB score
- Then submit after each optimization experiment
- LB feedback is FREE information - use it!

## Resources
- Pre-optimized submissions: `/home/code/preoptimized/`
- Research kernels: `/home/code/research/kernels/`
- bbox3.cpp source: `research/kernels/jazivxt_why-not/why-not.ipynb`
- sa_v1_parallel.cpp source: `research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`
