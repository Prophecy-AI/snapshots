# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.676102 from exp_000 (baseline)
- Best LB score: 70.676102 (exp_000 - baseline)
- Target: 68.919154 | Gap to target: 1.757 points (2.5%)
- **LAST SUBMISSION FAILED**: exp_001 (CV 70.659944) rejected with "Overlapping trees in group 069"

## CRITICAL ISSUE: Submission Validation
The exp_001 submission was rejected because it contained overlapping trees in group 069.
- The submission came from a snapshot (Eazy optimizer) that apparently has invalid configurations
- Our local overlap detection didn't catch this (uses different precision/method than Kaggle)
- **MUST validate ALL submissions with stricter overlap detection before submitting**

## Response to Evaluator
The evaluator correctly identified that:
1. **Local optimum trap is REAL** - bbox3 ran 80 rounds with ZERO improvement
2. **Standard optimizers cannot escape** - tree_packer_v21 also found no improvements
3. **Need fundamentally different approach** - symmetric solutions and lattice-based packing

I agree with the evaluator's assessment. The current approach of running more optimization rounds is definitively dead. We need to pivot to:
1. **Symmetric solutions** (42 upvotes on discussion - top competitors use this)
2. **Lattice-based packing** for large N values
3. **Perturbed restarts** with significant noise to escape local optima

## What's Working
1. **Baseline is valid** - candidate_000.csv (70.676102) has no overlaps and scores correctly on LB
2. **Infrastructure is solid** - scoring, overlap detection, CSV handling all work
3. **Multiple optimizers compiled** - bbox3, tree_packer_v21 ready to use

## What's NOT Working
1. **Standard optimization** - 80 rounds of bbox3 found ZERO improvements
2. **Ensemble from existing CSVs** - all sources at similar local optima
3. **fix_direction** - already applied to baseline, no further improvement
4. **Snapshot solutions** - may have overlaps that our local detection misses

## Key Findings from Analysis
1. **Local optimum is VERY tight** - bbox3 log shows score stayed at exactly 70.676102 for all 80 rounds
2. **Symmetric solutions are key** - Discussion with 42 upvotes says forcing symmetric layouts outperforms unrestricted search
3. **Small N values have highest impact** - N=1 contributes 0.661 to score (highest single contribution)
4. **Kaggle uses stricter overlap detection** - our local check may not catch all overlaps

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY] Fix Overlap Detection**
Before ANY submission, validate with stricter overlap detection:
- Use scale_factor = 1e15 (like official getting-started notebook)
- Check intersection area > 0 (not just > 1e-10)
- Test on candidate_001.csv to verify it catches the group 069 overlap

### 2. **[HIGH PRIORITY] Implement Symmetric Packing**
Based on discussion with 42 upvotes:
- For each N, try forcing mirror symmetry across x-axis, y-axis, or both
- For perfect squares (4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196), try grid-based symmetric layouts
- Symmetric constraints reduce search space while maintaining optimality

### 3. **[HIGH PRIORITY] Lattice-Based Approach for Large N**
For N = 72, 100, 110, 144, 156, 196, 200:
- Try crystalline/grid packings
- Start with two base trees and translate them in x and y directions
- Parameters: nx × ny grid where nx*ny >= N

### 4. **[MEDIUM PRIORITY] Perturbed Restarts**
To escape local optima:
- Add significant noise (0.1-0.5 units) to current solution
- Re-optimize from perturbed state with bbox3
- Keep best result

### 5. **[MEDIUM PRIORITY] Targeted Small N Optimization**
Since small N values contribute disproportionately:
- N=1: Verify 45° is truly optimal (exhaustive angle search 0-90°)
- N=2-10: Try all reasonable symmetric configurations
- Focus optimization time on these specific configurations

## What NOT to Try
- ❌ More rounds of bbox3/tree_packer_v21 on current solution (proven to not work)
- ❌ Ensemble from existing CSVs (all at same local optimum)
- ❌ Submitting without strict overlap validation
- ❌ Using snapshots without verifying no overlaps

## Validation Requirements
Before ANY submission:
1. Check ALL 200 groups for overlaps using strict detection (scale_factor=1e15)
2. Verify score matches expected value
3. Ensure submission file has correct format (id,x,y,deg with 's' prefix)

## SUBMISSION STRATEGY
- Remaining submissions: 98
- Submit after EVERY valid experiment (we have abundant submissions)
- But ONLY submit if overlap validation passes

## Technical Notes

### Overlap Detection (Strict Version)
```python
from decimal import Decimal, getcontext
getcontext().prec = 25
scale_factor = Decimal('1e15')

# Build tree polygon with high precision
# Check intersection.area > 0 (not > 1e-10)
```

### Symmetric Packing Approach
```python
# For N trees, try:
# 1. Place N/2 trees, mirror across x-axis
# 2. Place N/2 trees, mirror across y-axis
# 3. Place N/4 trees, mirror across both axes
# 4. For perfect squares, use grid layout
```

### Lattice-Based Approach
```python
# For large N (e.g., N=100):
# 1. Find nx, ny where nx*ny >= N (e.g., 10x10)
# 2. Place two base trees at optimal relative position
# 3. Translate to create grid
# 4. Remove excess trees to get exactly N
# 5. Optimize positions within grid constraints
```

## Gap Analysis
- Current best: 70.676102
- Target: 68.919154
- Gap: 1.757 points (2.5%)

This gap IS closeable, but requires fundamentally different approaches. The symmetric solutions discussion suggests top competitors achieve better scores by constraining the search space intelligently, not by running more optimization rounds.
