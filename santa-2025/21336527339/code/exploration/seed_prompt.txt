# Christmas Tree Packing Optimization - Loop 2 Strategy

## Current Status
- **Best CV score**: 70.647327 from exp_000 (baseline)
- **Best LB score**: 70.647327 (confirmed from snapshot 21328309254)
- **Target**: 68.888293 | **Gap to target**: 1.759 points (2.49% improvement needed)

## CRITICAL FIX APPLIED
The original baseline from snapshot 21116303805 had overlapping trees in group 126 and was rejected by Kaggle.
We have replaced it with the VALID submission from snapshot 21328309254 which scored 70.647327 on LB.

**Valid baseline location**: `/home/code/experiments/000_baseline/submission_valid.csv`
**This is now in**: `/home/submission/submission.csv`

## Response to Evaluator
The evaluator correctly identified that:
1. ✅ We needed to submit to LB to verify - DONE (but failed due to overlaps)
2. ✅ The baseline is now fixed with a valid submission
3. The evaluator suggested compiling bbox3 from source - this is a valid approach
4. The evaluator suggested rotation tightening (fix_direction) - worth trying

## Score Breakdown (from valid baseline)
- n=1-10: 4.329 (6.1% of total)
- n=11-20: 3.726 (5.3% of total)
- n=21-50: 10.984 (15.5% of total)
- n=51-100: 17.628 (25.0% of total)
- n=101-150: 17.137 (24.3% of total)
- n=151-200: 16.843 (23.8% of total)

**Key insight**: Large N (51-200) contributes 73% of the score. Small N has higher per-tree impact but lower total contribution.

## Available Optimization Tools
Pre-compiled binaries available in snapshots:
- `/home/nonroot/snapshots/santa-2025/21328309254/code/bbox3` - Main optimizer
- `/home/nonroot/snapshots/santa-2025/21328309254/code/sa_fast_v2` - Simulated annealing
- `/home/nonroot/snapshots/santa-2025/21123768399/code/bbox3_advanced` - Advanced version
- `/home/nonroot/snapshots/santa-2025/21123768399/code/tree_packer` - Another optimizer

Source code available:
- `/home/nonroot/snapshots/santa-2025/21328309254/code/bbox3.cpp`
- `/home/nonroot/snapshots/santa-2025/21328309254/code/sa_fast_v2.cpp`

## Recommended Approach for exp_001

### Option A: Run bbox3 Optimization (QUICK WIN)
1. Copy bbox3 binary and the valid submission to working directory
2. Run bbox3 with parameters: `./bbox3 -i submission.csv -o optimized.csv -n 10000 -r 0.1`
3. Validate output has no overlaps
4. Submit to LB

### Option B: Apply Rotation Tightening (fix_direction)
1. Load the valid submission
2. For each n-configuration, apply rotation optimization:
   - Extract all polygon vertices
   - Compute ConvexHull
   - Use scipy.optimize.minimize_scalar to find optimal rotation angle (0-90°)
   - Objective: minimize max(width, height)
3. Save optimized submission
4. Validate and submit

### Option C: Ensemble Best Solutions from Multiple Snapshots
1. Load valid submissions from multiple snapshots
2. For each n, pick the configuration with smallest bounding box
3. Validate the ensemble has no overlaps
4. Submit

## IMPORTANT: Overlap Validation
Before ANY submission, validate using high-precision arithmetic:
```python
from decimal import Decimal, getcontext
getcontext().prec = 30

# Use integer scaling for exact arithmetic
SCALE = 10**15

def validate_no_overlap(trees):
    # Scale coordinates to integers
    # Check pairwise intersections
    # Return True only if NO overlaps
```

## What NOT to Try
- Using snapshot 21116303805 submission (has overlaps)
- Submitting without validation
- Running optimization without checking output for overlaps

## Submission Strategy
- Remaining submissions: 93
- **SUBMIT after this experiment** - we have abundant submissions
- Even if score doesn't improve, LB feedback is valuable

## Next Steps After exp_001
1. If bbox3 improves score → run longer with different parameters
2. If rotation tightening helps → apply to all configurations
3. If ensemble works → try more sophisticated selection criteria
4. If none work → implement novel algorithms (NFP, genetic algorithm)

## Files to Reference
- Valid baseline: `/home/code/experiments/000_baseline/submission_valid.csv`
- Tree geometry: See `research/kernels/inversion_santa-2025-getting-started/`
- Optimization code: See `research/kernels/saspav_santa-submission/`
