# Christmas Tree Packing Optimization - Loop 2 Strategy

## Current Status
- Best CV score: 70.647321 from exp_001 (bbox3 + sa_fast_v2)
- Best LB score: NONE - both submissions FAILED with overlaps!
- Target: 68.888293 | Gap to target: ~1.76 points (2.5% improvement needed)

## ⚠️ CRITICAL ISSUE: SUBMISSIONS FAILING WITH OVERLAPS ⚠️

**BOTH submissions have been rejected by Kaggle:**
- exp_000: "Overlapping trees in group 126"
- exp_001: "Overlapping trees in group 027"

**ROOT CAUSE IDENTIFIED:**
The sa_fast_v2 optimizer outputs coordinates with 20+ decimal places, while the valid baseline (snapshot 21328309254) uses ~15 decimal places. The extra precision causes floating-point issues on Kaggle's stricter validation.

**IMMEDIATE FIX REQUIRED:**
1. Use the ORIGINAL valid baseline from `/home/nonroot/snapshots/santa-2025/21328309254/submission/submission.csv` DIRECTLY
2. DO NOT run any optimizer that changes coordinate precision
3. Submit this valid baseline FIRST to establish a working LB score

## Response to Evaluator

The evaluator correctly identified several key issues:

1. **Rotation tightening (fix_direction) NOT APPLIED** - AGREE. This is a cheap O(n) operation that should be tried. The saspav kernel has the implementation.

2. **Per-N analysis missing** - AGREE. We need to identify which N values have the most room for improvement.

3. **Valid baseline hasn't been submitted to LB** - CRITICAL. We've been submitting modified files that have overlaps. We need to submit the ORIGINAL valid baseline first.

4. **shake_public optimizer not tried** - NOTED. But we don't have this binary available in snapshots.

**My synthesis:** The FIRST priority is to get a VALID submission on the LB. We cannot optimize what we cannot submit. Use the original baseline from snapshot 21328309254 directly.

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Submit the VALID baseline directly
```bash
# Copy the ORIGINAL valid baseline (DO NOT MODIFY)
cp /home/nonroot/snapshots/santa-2025/21328309254/submission/submission.csv /home/submission/submission.csv
```
This should score ~70.647327 on LB. We NEED this working submission before any optimization.

### 2. **[HIGH PRIORITY]** Implement rotation tightening (fix_direction)
Extract from saspav kernel and apply to all 200 configurations:
- Use ConvexHull to get boundary points
- Use scipy.optimize.minimize_scalar to find optimal rotation angle (0-90°)
- Rotate all trees by that angle to minimize max(width, height)
- **CRITICAL:** Round output to ~15 decimal places to match valid baseline format

### 3. **[MEDIUM PRIORITY]** Per-N analysis
Identify which N values have the most room for improvement:
- Compare current side lengths to theoretical minimums
- Focus optimization on N values with largest gaps
- Small N (1-20) have higher per-tree contribution due to s²/n weighting

## ⛔ BLOCKED APPROACHES (DO NOT USE)
- Running bbox3, sa_fast_v2, or any optimizer that changes coordinate precision
- Submitting files with 20+ decimal places
- Any approach that doesn't validate overlaps with Kaggle-compatible precision

## Validation Requirements

**BEFORE any submission, validate with this code:**
```python
from decimal import Decimal, getcontext
getcontext().prec = 30
SCALE = 10**18

def validate_no_overlap_strict(trees):
    from shapely import Polygon
    polygons = []
    for tree in trees:
        # Use integer scaling for exact arithmetic
        coords = [(int(Decimal(str(x)) * SCALE), 
                   int(Decimal(str(y)) * SCALE)) 
                  for x, y in tree.vertices]
        polygons.append(Polygon(coords))
    for i in range(len(polygons)):
        for j in range(i+1, len(polygons)):
            if polygons[i].intersects(polygons[j]) and not polygons[i].touches(polygons[j]):
                return False, f"Trees {i} and {j} overlap"
    return True, "OK"
```

## Experiment Plan for exp_002

**Name:** 002_valid_baseline_submission
**Goal:** Get a VALID LB score by submitting the original baseline

**Steps:**
1. Copy `/home/nonroot/snapshots/santa-2025/21328309254/submission/submission.csv` to `/home/submission/submission.csv`
2. Validate it locally with strict overlap checking
3. Log experiment with CV score 70.647327
4. Submit to LB

**Expected outcome:** LB score of ~70.647327 (matching local CV)

## After Valid Baseline is Established

Once we have a working LB submission, proceed with:

1. **Implement fix_direction** - Apply rotation tightening to all 200 configurations
2. **Validate carefully** - Ensure no overlaps with strict precision
3. **Submit improved solution** - Should see small improvement from rotation tightening

## Key Insights from Research

From saspav kernel:
- `optimize_rotation()` - finds optimal rotation angle using ConvexHull + minimize_scalar
- `apply_rotation()` - applies rotation to all trees in a configuration
- `fix_direction()` - main function that processes all 200 configurations

The fix_direction technique can reduce bounding box size without changing relative positions of trees. This is a "free" improvement that should be applied to any solution.

## Submission Strategy
- Remaining submissions: 93
- Submit after this experiment? **YES** - We MUST get a valid LB score
- Use the ORIGINAL valid baseline, not any modified version
