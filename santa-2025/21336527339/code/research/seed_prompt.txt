# Christmas Tree Packing - Evolved Strategy (Loop 4)

## Current Status
- Best CV score: 70.647327 from exp_002 (valid baseline)
- Best LB score: 70.647327 (exp_002 - CONFIRMED working!)
- Target: 68.888293 | Gap to target: 1.759 points (2.5%)

## CRITICAL INSIGHT: CV = LB PERFECTLY
exp_002 confirmed CV=70.647327, LB=70.647326897636. We can trust local validation completely!

## Response to Evaluator
The evaluator correctly identified that:
1. Single-solution optimization is STUCK - bbox3, sa_fast_v2, and fix_direction all showed ~0 improvement
2. The baseline is at a strong local optimum that cannot be escaped by parameter tuning
3. The path forward is ENSEMBLE - combining best solutions from multiple sources

I fully agree. My analysis confirms:
- Ensemble from 86 snapshots yields score 70.615744 (improvement of 0.032 from baseline)
- 11 different snapshots contribute to the best ensemble
- This is the jonathanchan kernel approach - it works!

## ENSEMBLE APPROACH DISCOVERY (CRITICAL!)
From exploration/evolver_loop4_analysis.ipynb:
- Analyzed 86 snapshots with valid submissions
- Found that combining best solution for each N yields 70.615744
- Key contributing snapshots:
  - 21191209482: 77 N values
  - 21322576827: 54 N values  
  - 21331543270: 23 N values
  - 21165872902: 18 N values
- Improvement: 0.032 points from baseline
- Ensemble map saved to: /home/code/exploration/final_ensemble_map.json

## ⛔ BLOCKED APPROACHES (DO NOT USE)
- bbox3, sa_fast_v2, eazy_optimizer - FORBIDDEN (already tried, no improvement)
- fix_direction (rotation tightening) - FORBIDDEN (baseline already optimally rotated)
- "More iterations" on existing optimizer - FORBIDDEN
- Any approach that gave < 0.01 improvement

## ✅ REQUIRED: IMPLEMENT ENSEMBLE APPROACH

### Experiment 004: Ensemble from Multiple Snapshots

**OBJECTIVE:** Create submission by taking best solution for each N from multiple snapshots

**IMPLEMENTATION:**
1. Load the ensemble map from `/home/code/exploration/final_ensemble_map.json`
2. For each N from 1 to 200:
   - Load the solution from the specified snapshot
   - Validate no overlaps (CRITICAL - use integer scaling!)
   - Add to final submission
3. Validate entire submission has no overlaps
4. Calculate final score (should be ~70.615744)

**CODE TEMPLATE:**
```python
import json
import pandas as pd
import os

# Load ensemble map
with open('/home/code/exploration/final_ensemble_map.json', 'r') as f:
    ensemble_map = json.load(f)

snapshot_dir = '/home/nonroot/snapshots/santa-2025/'

# Build ensemble submission
all_rows = []
for n in range(1, 201):
    snap = ensemble_map[str(n)]['snapshot']
    path = os.path.join(snapshot_dir, snap, 'submission', 'submission.csv')
    df = pd.read_csv(path)
    df['N'] = df['id'].astype(str).str.split('_').str[0].astype(int)
    n_rows = df[df['N'] == n]
    all_rows.append(n_rows)

final_df = pd.concat(all_rows, ignore_index=True)
final_df = final_df[['id', 'x', 'y', 'deg']]  # Keep only required columns
final_df.to_csv('/home/submission/submission.csv', index=False)
```

**VALIDATION (MANDATORY):**
```python
from decimal import Decimal, getcontext
from shapely.geometry import Polygon
from shapely.strtree import STRtree

getcontext().prec = 30
SCALE = 10**18

def validate_no_overlap(xs, ys, degs, tolerance=1e-12):
    # ... (use integer scaling for precision)
    pass

# Validate ALL N values before submission
for n in range(1, 201):
    # ... validate each N
```

### After Ensemble: Fractional Translation Refinement

The jonathanchan kernel shows that after ensemble, you can apply **fractional translation**:
- Very small steps (0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001) in 8 directions
- For each tree, try moving in each direction by each step size
- Keep the move if it reduces bounding box without creating overlaps
- This can squeeze out additional small improvements

## Score Breakdown by N Range (from loop 3 analysis)
- n=1-10: 4.33 (6.1%) - Small N, high per-tree contribution
- n=11-20: 3.73 (5.3%)
- n=21-50: 10.98 (15.5%)
- n=51-100: 17.63 (25.0%) - Largest contribution
- n=101-150: 17.14 (24.3%)
- n=151-200: 16.84 (23.8%)

## Expected Improvement Path
1. **Ensemble (exp_004)**: 70.615744 → 0.032 improvement
2. **Fractional translation**: Additional 0.01-0.05 improvement possible
3. **More snapshot sources**: If we can find more diverse solutions, ensemble could improve further
4. **Novel algorithms for specific N**: Branch-and-bound for small N could find optimal solutions

## Validation Notes
- CV = LB perfectly (confirmed by exp_002)
- Use integer scaling (10^18) for overlap validation
- Kaggle uses stricter precision than default Shapely floating-point
- Always validate entire submission before submitting

## SUBMISSION STRATEGY
- Remaining submissions: 92 (ABUNDANT!)
- Submit after EVERY experiment to get LB feedback
- Even if score is worse, LB feedback is valuable information
