# Christmas Tree Packing Optimization - Loop 5 Strategy

## Current Status
- Best CV score: 70.615744 from exp_004 (valid ensemble)
- Best LB score: 70.647327 (exp_002/exp_003 - baseline)
- Target: 68.887744 | Gap to target: 1.73 points (2.5%)
- Submissions remaining: 91 (ABUNDANT - submit after every experiment!)

## CV-LB Relationship
- **PERFECT MATCH**: CV = LB exactly (confirmed by exp_002 and exp_003)
- We can trust local validation completely

## What Happened in Loop 4
1. Analyzed 88 snapshots for ensemble potential
2. Found best single snapshot (21145966992) scores 70.572798 but has 57 N values with OVERLAPS
3. Built valid ensemble (excluding overlapping solutions): 70.615744
4. Improvement from baseline: 0.032 points (NOT ENOUGH)

**Key Insight**: Most snapshots have overlapping solutions. The valid ensemble only uses 3 snapshots:
- 21336527339: 194 N values
- 21331543270: 4 N values  
- 21145966992: 2 N values

## Response to Evaluator
The evaluator was RIGHT that ensemble is the path forward, but the available snapshots are LIMITED.
We need to GENERATE new diverse solutions, not just combine existing ones.

## ⛔ BLOCKED APPROACHES (DO NOT USE)
- Running bbox3, sa_fast_v2 on the current baseline (already at local optimum)
- fix_direction (already applied to baseline)
- Simple ensemble from existing snapshots (already done, only 0.032 improvement)

## ✅ REQUIRED: EXPERIMENT 004 - SUBMIT THE VALID ENSEMBLE
The valid ensemble (70.615744) is ready at:
- `/home/code/experiments/004_ensemble_valid/submission.csv`
- `/home/submission/submission.csv`

**FIRST**: Submit exp_004 to get LB feedback on the ensemble approach.

## ✅ NEXT EXPERIMENT (005): GENERATE NEW SOLUTIONS WITH DIFFERENT SEEDS

The jonathanchan kernel shows that top scores come from combining MANY diverse solutions.
We need to generate NEW solutions, not just use existing snapshots.

**Implementation Plan:**
1. Run bbox3 with 10 different random seeds
2. For each seed, save the output
3. Ensemble the best per-N from all 10 runs + existing valid snapshots
4. This should give us more diversity and better per-N solutions

```bash
# Generate solutions with different seeds
for seed in 1 2 3 4 5 6 7 8 9 10; do
    ./bbox3 -n 5000 -r 4 -s $seed -i baseline.csv -o solution_seed_$seed.csv
done
```

Then ensemble:
```python
# For each N from 1 to 200:
#   Load solutions from all 10 seeds + existing valid snapshots
#   Compute score for each source's N configuration
#   Check for overlaps
#   Keep the best valid one
```

## Alternative Approach: Fractional Translation
If seed-based generation doesn't work, try fractional translation:
```python
steps = [0.001, 0.0005, 0.0002, 0.0001]
directions = [(1,0), (-1,0), (0,1), (0,-1), (1,1), (1,-1), (-1,1), (-1,-1)]
for step in steps:
    for dx, dy in directions:
        # Try moving each tree by (dx*step, dy*step)
        # Keep if score improves and no overlaps
```

## Validation Notes
- MUST check for overlaps before submission (Kaggle is strict)
- Use integer scaling (1e18) for precise overlap detection
- CV = LB perfectly, so local validation is reliable

## Key Files
- Valid baseline: `/home/nonroot/snapshots/santa-2025/21328309254/submission/submission.csv`
- Best ensemble snapshot: `/home/nonroot/snapshots/santa-2025/21336527339/submission/submission.csv`
- Valid ensemble (exp_004): `/home/code/experiments/004_ensemble_valid/submission.csv`
- jonathanchan kernel: `/home/code/research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`

## Expected Outcome
- Seed-based generation should give us 10+ diverse solutions
- Ensemble of these should improve by 0.1-0.3 points
- Target: get below 70.5 in this loop

## Submission Strategy
- **SUBMIT exp_004 FIRST** to verify ensemble approach works on LB
- Then submit exp_005 (seed-based ensemble) after generation
- We have 91 submissions - USE THEM for feedback!