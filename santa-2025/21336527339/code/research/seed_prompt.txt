# Christmas Tree Packing Optimization - Loop 6 Strategy

## Current Status
- Best CV score: 70.615744 from exp_004 (ensemble)
- Best LB score: 70.647327 from exp_002/exp_003 (valid baseline)
- Target: 68.887226 | Gap to target: 1.76 points (2.5%)
- Submissions used: 5/100 (95 remaining)

## CRITICAL ISSUE: OVERLAP VALIDATION MISMATCH

**exp_004 (CV=70.615744) FAILED on Kaggle with "Overlapping trees in group 002"**

Analysis shows:
- N=2 solution has intersection area of 7e-13 (tiny but non-zero)
- Our local validation threshold (1e-10) is too lenient
- Kaggle uses stricter floating-point validation

**SOLUTION: Use stricter overlap validation**
```python
# STRICT overlap check - use 1e-15 threshold
def check_overlaps_strict(xs, ys, degs):
    polys = [get_tree_polygon(xs[i], ys[i], degs[i]) for i in range(len(xs))]
    for i in range(len(polys)):
        for j in range(i+1, len(polys)):
            if polys[i].intersects(polys[j]) and not polys[i].touches(polys[j]):
                inter = polys[i].intersection(polys[j])
                if inter.area > 1e-15:  # STRICT threshold
                    return True, f"Trees {i} and {j} overlap (area={inter.area})"
    return False, "OK"
```

## Response to Evaluator

The evaluator correctly identified:
1. ✅ Ensemble approach is correct (0.032 improvement validates this)
2. ✅ Limited by source diversity (only 3 snapshots contributed)
3. ✅ Need fractional translation post-processing
4. ✅ Need more diverse solution sources

**Key insight I'm adding:** The overlap validation mismatch is the IMMEDIATE blocker. We can't submit improved ensembles until we fix the validation.

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY] Fix Overlap Validation + Resubmit Ensemble**

Create experiment: `experiments/005_strict_ensemble/`

Steps:
1. Use STRICT overlap threshold (1e-15 instead of 1e-10)
2. Re-scan all 500+ CSV files from snapshots
3. For each N, find best solution that passes STRICT validation
4. If no valid improvement exists, use baseline solution for that N
5. Validate entire submission before saving

Expected outcome: Valid ensemble with score ~70.62-70.64

### 2. **[HIGH PRIORITY] Implement Fractional Translation**

After creating valid ensemble, apply fractional translation:
```python
frac_steps = [0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001]
directions = [(0,1), (0,-1), (1,0), (-1,0), (1,1), (1,-1), (-1,1), (-1,-1)]

for n in range(1, 201):
    for tree_idx in range(n):
        for step in frac_steps:
            for dx, dy in directions:
                # Try moving tree by (dx*step, dy*step)
                # Keep if: no overlap AND score improves
```

Expected improvement: 0.01-0.1 points

### 3. **[MEDIUM PRIORITY] Generate New Diverse Solutions**

The jonathanchan kernel uses 19+ sources. We only have ~3 contributing sources.

Options:
a) Run bbox3/sa_fast with DIFFERENT random seeds to generate diverse solutions
b) Implement genetic algorithm to evolve new solutions
c) Try different optimization algorithms (constraint programming, branch-and-bound for small N)

### 4. **[LOWER PRIORITY] Per-N Specialization**

Different algorithms for different N ranges:
- N=1-10: Exhaustive rotation search (test every 0.1° rotation)
- N=11-50: Branch-and-bound or custom constructive heuristic
- N=51-100: SA with custom move operators
- N=100+: Tessellation-based with local refinement

## What NOT to Try

1. ❌ Submitting without strict overlap validation (will fail on Kaggle)
2. ❌ Running more bbox3/sa_fast iterations on same solutions (already at local optimum)
3. ❌ Ignoring the overlap validation issue

## Validation Notes

**MANDATORY before ANY submission:**
```python
# Validate EVERY N value with strict threshold
for n in range(1, 201):
    has_overlap, msg = check_overlaps_strict(xs, ys, ds)
    if has_overlap:
        raise ValueError(f"N={n}: {msg}")
```

## Submission Strategy

- We have 95 submissions remaining - ABUNDANT!
- Submit after EVERY experiment that produces a valid submission
- LB feedback is FREE information - use it!
- Even if score doesn't improve, we learn what works/doesn't work

## Key Files

- Valid baseline: `/home/nonroot/snapshots/santa-2025/21328309254/submission/submission.csv` (score 70.647327, passed Kaggle)
- Snapshot CSVs: 3437 files in `/home/nonroot/snapshots/santa-2025/`
- jonathanchan kernel: `/home/code/research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`

## Summary

The ensemble approach is CORRECT but we have two blockers:
1. **Overlap validation** - our threshold is too lenient, causing Kaggle rejections
2. **Source diversity** - only 3 snapshots contribute valid improvements

Fix #1 first (strict validation), then work on #2 (more sources + fractional translation).