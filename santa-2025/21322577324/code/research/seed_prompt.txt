# Santa 2025 - Christmas Tree Packing Challenge: Evolved Seed Prompt (Loop 2)

## Current Status
- Best CV score: 70.627582 from exp_000 (baseline)
- Best LB score: N/A (no submissions yet)
- Target: 68.901319 | Gap to target: 1.726 points (2.44%)

## CV-LB Relationship Analysis
- **CV = LB exactly** for this competition (pure optimization, no distribution shift)
- This is NOT a machine learning problem - it's a combinatorial optimization problem
- The challenge is finding better packings, not generalization

## Response to Evaluator
- Technical verdict was TRUSTWORTHY. The bbox3 experiment was well-executed.
- Evaluator's top priority: Run sa_fast_v2 with extended parameters. **PARTIALLY DONE** - sa_fast_v2 ran but produced 116/200 invalid solutions. After REPAIR, only 14 valid improvements with 0.001611 total improvement.
- Key concerns raised: bbox3 produces 60% invalid solutions, sa_fast_v2 CAN escape local optima. **CONFIRMED** - sa_fast_v2 did find some improvements but most were invalid.
- Evaluator mentioned shake_public is missing. **STILL MISSING** - need to find or implement equivalent.

## Data Understanding
- Reference notebooks: `exploration/evolver_loop2_analysis.ipynb`
- Key patterns:
  - N=1 is already at theoretical minimum (0.813173 at 45Â°)
  - Small N (1-10) contribute 5.6% of total score but are hard to improve
  - The baseline is at a STRONG LOCAL OPTIMUM
  - sa_fast_v2 produces many invalid (overlapping) solutions

## Key Findings from Analysis
1. **sa_fast_v2 results**: 14 valid improvements, 116 invalid, 70 same. Total improvement: 0.001611 points.
2. **Fractional translation** (from jonathanchan kernel): Very fine-grained moves (0.001 to 0.00001) can help escape local optima.
3. **Population-based optimization**: Keep top 3 solutions and perturb them.
4. **Backward propagation** (from crodoc kernel): Use n-config to improve (n-1)-config.

## Recommended Approaches (Priority Order)

### Priority 1: Implement Fractional Translation Optimizer
The jonathanchan kernel shows a technique that makes very small moves (0.001 to 0.00001 step sizes) in 8 directions. This could help fine-tune positions after SA.

Implementation:
```python
def fractional_translation(trees, max_iter=200):
    frac_steps = [0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001]
    directions = [(0,1), (0,-1), (1,0), (-1,0), (1,1), (1,-1), (-1,1), (-1,-1)]
    for iter in range(max_iter):
        improved = False
        for i, tree in enumerate(trees):
            for step in frac_steps:
                for dx, dy in directions:
                    # Try moving tree by (dx*step, dy*step)
                    # Accept if no overlap and smaller bounding box
```

### Priority 2: Run sa_fast_v2 with Multiple Seeds and Longer Iterations
The current run used default parameters. Try:
- Multiple seeds (42, 123, 456, 789, etc.)
- Longer iterations (MAX_ITER > 5M instead of 3.5M)
- Different temperature schedules

### Priority 3: Implement Backward Propagation
From crodoc kernel:
1. Start from n=200
2. For each n from 200 down to 2:
   - Take the n-config
   - Remove the tree that touches the boundary
   - Check if resulting (n-1) config is better than current best for (n-1)
   - If yes, update

### Priority 4: Compile and Use sa_fast_v2_all
There's a `sa_fast_v2_all` binary in snapshots that might optimize all N values (not just N>=91).

### Priority 5: Find or Implement shake_public Equivalent
The saspav kernel relies on shake_public for local optimization. Either:
- Find the binary in snapshots
- Implement equivalent in Python/C++

## What NOT to Try
- **bbox3**: Produces 60% invalid solutions, doesn't improve baseline
- **Simple grid search**: Too slow for this problem size
- **Random restarts without SA**: Won't escape local optima

## Validation Notes
- Always check for overlaps before accepting any solution
- Use REPAIR strategy: keep valid improvements, replace invalid with baseline
- Score = sum(side_length^2 / n) for n=1 to 200

## Technical Notes
- sa_fast_v2 reads from submission1.csv, writes to submission2.csv
- Use `-iter`, `-tstart`, `-tend`, `-seed`, `-threads` parameters
- Collision detection uses "touch allowed" semantics (touching is OK, overlapping is not)

## Files to Reference
- `/home/code/sa_fast_v2` - C++ SA optimizer (already compiled)
- `/home/code/sa_fast_v2_all` - C++ SA optimizer for all N (just copied)
- `/home/code/research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/` - Fractional translation technique
- `/home/code/research/kernels/crodoc_74-75-backpacking-christmas-trees/` - Backward propagation technique

## Experiment Naming Convention
- exp_003: sa_fast_v2 with multiple seeds
- exp_004: fractional_translation implementation
- exp_005: backward_propagation implementation
