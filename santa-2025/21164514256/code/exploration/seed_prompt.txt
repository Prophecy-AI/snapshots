# Santa 2025 - Christmas Tree Packing Optimization

## Problem Overview
Pack N Christmas trees (N=1 to 200) into the smallest possible square bounding box.
- Score = Σ(side_n² / n) for n=1 to 200 (lower is better)
- Target score: 68.919154
- Best achieved: 70.659437 (gap: 1.74 points, 2.5%)
- Tree shape: 15-vertex polygon with trunk, 3 tiers, and tip

## Current Status
- Best public kernels achieve ~70.66
- Pre-optimized submissions available in snapshots
- CV = LB exactly (pure optimization, no distribution shift)

## Pre-Optimized Solutions Available
Copy the best submission from snapshots:
```bash
cp /home/nonroot/snapshots/santa-2025/21156851249/submission/submission.csv ./submission.csv
```

## Key Approaches from Public Kernels

### 1. Simulated Annealing (SA) - Primary Approach
From `tree_packer_v21.cpp` and `bbox3`:
- Temperature schedule with exponential cooling
- Move operators: translate, rotate, swap positions
- Accept worse solutions with probability exp(-delta/T)
- Run with high iterations: -n 15000+ -r 80+
- Use OpenMP for parallelization (26 threads available)

### 2. Backward Propagation (BP)
Transfer solutions from N to N-1:
- For each N from 200 down to 2
- Try removing each tree that touches the bounding box
- Keep if resulting (N-1) config is better than stored
- Iterate: SA → BP → SA → BP

### 3. Squeeze and Compaction
- Squeeze: Scale all trees towards center until overlap
- Compaction: Move individual trees towards center
- Local search: 8-directional moves + rotation adjustments

### 4. Fix Direction (Rotation Tightening)
- Rotate entire configuration to minimize bounding box
- Use scipy.optimize.minimize_scalar on convex hull
- Apply after SA optimization

## Critical Insights from Discussions

### Small N Values (1-20) Have Most Room for Improvement
- N=1 contributes 0.66 to score (highest single contribution)
- Efficiency for small N: 0.37-0.59 vs 0.74 for large N
- Focus optimization effort here

### Asymmetric Solutions Outperform Symmetric
- Top teams use asymmetric configurations
- Don't assume symmetry is optimal

### Tessellations/Lattice for Large N
- For N > 100, consider grid-based placement
- Start with 2 base trees, translate in x/y directions
- Can achieve tighter bounds than random optimization

## Recommended Experiment Strategy

### Experiment 1: Baseline from Best Snapshot
1. Copy best pre-optimized submission
2. Verify score matches ~70.66
3. Visualize a few N values to understand current state

### Experiment 2: Extended SA Optimization
1. Compile tree_packer_v21.cpp with OpenMP
2. Run with high parameters: -n 50000 -r 128
3. Use all 26 threads
4. Run for several hours

### Experiment 3: Focus on Small N
1. Extract N=1-20 configurations
2. Run exhaustive angle search for N=1 (0° to 360° in 0.001° steps)
3. Use constraint programming for N=2-5
4. Apply longer SA runs specifically for N=1-20

### Experiment 4: Lattice Approach for Large N
1. For N=100, 144, 196, 200 try grid-based placement
2. Optimize base configuration and translation vectors
3. Compare with SA results

### Experiment 5: Novel Approaches
- Tabu search with diversification
- Differential evolution
- Genetic algorithm with topology crossover

## Technical Implementation Notes

### C++ Compilation
```bash
g++ -O3 -march=native -std=c++17 -fopenmp -o tree_packer tree_packer.cpp
export OMP_NUM_THREADS=26
```

### Submission Format
- Values prefixed with 's': `s0.123456`
- Columns: id, x, y, deg
- id format: `NNN_T` where NNN is tree count (001-200), T is tree index

### Overlap Detection
- Use Shapely for Python, custom polygon intersection for C++
- Check both point-in-polygon and edge intersection
- Bounding box pre-filter for efficiency

### Precision
- Use Decimal or long double for coordinates
- Scale factor: 1e15 for Decimal operations
- Round to 12+ decimal places

## What NOT to Try
- Short optimization runs (< 1 hour) - won't escape local optima
- Simple ensemble of existing solutions - one source dominates
- Micro-optimizing already-optimized submissions
- Assuming symmetry is optimal

## Validation
- Calculate score locally before submission
- Check for overlaps using Shapely
- Verify all 200 N values are present
- Ensure coordinates within [-100, 100]

## Key Files
- Sample submission: /home/data/sample_submission.csv
- Best snapshot: /home/nonroot/snapshots/santa-2025/21156851249/
- Kernels: ../research/kernels/
