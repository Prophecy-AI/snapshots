# Santa 2025 Christmas Tree Packing - Strategy for Loop 4

## Current Status
- Best CV score: 70.676816 from exp_002 (007_preoptimized_baseline)
- Best LB score: N/A (no submissions yet)
- Target: 68.922808 | Gap to target: 1.754 points

## Response to Evaluator
- Technical verdict was **TRUSTWORTHY**. The submission is valid with all 200 configurations having no overlaps.
- Evaluator's top priority: **Submit to Kaggle and create comprehensive ensemble**. AGREE - we need LB feedback to verify local score.
- Key concerns raised:
  1. Gap of 1.75 points requires more aggressive optimization - AGREE
  2. No Kaggle submission yet - AGREE, will submit this loop
  3. Potential for better ensemble - PARTIALLY ADDRESSED (found valid improvements but many sources have overlaps)

## Data Understanding
- Reference notebooks: `exploration/evolver_loop3_analysis.ipynb` for ensemble analysis
- Key patterns:
  1. Best available score from 30 sources is 70.676102 (ensemble.csv) but has overlaps
  2. Valid configs from submission.csv can improve N=170,61,41,171,114,43,157 (total ~0.001 improvement)
  3. Top N values by score contribution: N=1 (0.661), N=2 (0.451), N=3 (0.435), N=5 (0.417), N=4 (0.417)
  4. Fractional translation technique with step sizes down to 0.00001 can squeeze out improvements

## Recommended Approaches

### Priority 1: Submit Current Best to Kaggle
- Submit exp_002 (70.676816) to verify LB score matches local score
- This establishes baseline and uses 1 of 95 remaining submissions

### Priority 2: Create Best Valid Ensemble
- Load ALL 30 CSV sources from preoptimized directory
- For each N, find the best VALID (no overlaps) configuration
- This should achieve ~70.676102 or better

### Priority 3: Run Extended bbox3_advanced Optimization
- Use the C++ optimizer at `/home/code/bbox3_advanced`
- Run with higher iterations: `-n 50000 -r 100`
- Focus on high-contribution N values (N=1-10)
- Apply fractional_translation for fine-tuning

### Priority 4: Targeted Optimization on Worst N Values
- N=1 contributes 0.661 to score - optimal is ~0.98 (single tree at 45Â°)
- N=2 contributes 0.451 - room for improvement
- N=3 contributes 0.435 - room for improvement
- Run dedicated optimization passes on these

### Priority 5: Backward Propagation
- Start from N=200 and iterate backward
- For each N, try removing each tree from (N+1) config
- If resulting N config is better, use it

## What NOT to Try
- Building from scratch (pre-optimized solutions are 64 points better)
- Simple greedy placement (already exhausted in earlier experiments)
- Random restarts without leveraging existing good solutions

## Validation Notes
- All 200 configurations must be valid (no overlaps)
- Use Shapely with high-precision Decimal for overlap detection
- Score locally before submission
- Keep backup of best valid solution

## Technical Resources
- C++ optimizer: `/home/code/bbox3_advanced`
- Pre-optimized sources: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/`
- Overlap validation: Use ChristmasTree class with Shapely STRtree

## Key Insight from Top Kernels
The jonathanchan kernel shows that:
1. Ensembling from 15+ sources finds best configs per N
2. fractional_translation with step sizes [0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001] squeezes out improvements
3. Multiple optimization passes (sa_v3 + ls_v3 + fractional_translation) are needed
4. Focus extra iterations on N <= 50 (higher contribution to score)

## Expected Workflow
1. Submit current best (70.676816) to get LB feedback
2. Create best valid ensemble from all sources
3. Run bbox3_advanced with extended parameters
4. Apply fractional_translation for fine-tuning
5. Validate and submit improved solution
