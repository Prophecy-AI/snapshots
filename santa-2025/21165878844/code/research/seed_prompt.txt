# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 71.812779 from exp_001 (002_valid_submission)
- Best LB score: 71.812779 (CV-LB gap: 0.0000 - perfect calibration!)
- Target: 68.919154 | Gap to target: 2.89 points (4.2%)

## Critical Discovery: The Touching vs Non-Touching Gap
- **Touching solutions** (trees with distance ≈ 0): Score 70.647 - REJECTED by Kaggle
- **Non-touching solutions** (distance > 0): Score 71.813 - ACCEPTED
- **Gap between them**: 1.166 points

The optimizers produce touching trees because that's mathematically optimal. But Kaggle requires distance > 0. The 1.17 point penalty comes from using suboptimal non-touching configurations.

## Response to Evaluator
The evaluator correctly identified:
1. ✅ CV-LB gap is 0 - our scoring is perfectly calibrated
2. ✅ The approach of finding valid configs from existing CSVs has a ceiling
3. ✅ Micro-separation is the key insight - apply minimal separation to touching trees

**Key action items from evaluator:**
- Modify optimization to maintain gaps (gap-constrained optimization)
- Apply micro-separation post-processing to touching trees
- Focus on small N values (1-10) which contribute disproportionately

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Micro-Separation Post-Processing
Take the best touching configurations (70.65) and apply minimal separation:
- For each pair of touching trees (distance < 1e-9):
  - Calculate the minimum translation vector to achieve distance > 0.001
  - Apply half the translation to each tree
  - Re-optimize the bounding box rotation (fix_direction)
- This could recover most of the 1.17 point gap

**Implementation:**
```python
def micro_separate(trees, min_gap=0.001):
    """Separate touching trees by minimum amount"""
    for i, j in touching_pairs:
        # Get closest points between polygons
        # Calculate separation vector
        # Move each tree by half the vector
        # Verify no new overlaps created
    return trees
```

### 2. **[HIGH PRIORITY]** Gap-Constrained C++ Optimizer
Modify the sa_v1_parallel.cpp to reject moves that result in distance < min_gap:
```cpp
bool hasGap(int i, double min_gap = 0.001) const {
    for (int j = 0; j < n; j++) {
        if (i != j && distance(pl[i], pl[j]) < min_gap) return false;
    }
    return true;
}
```
This is more fundamental but requires C++ modification.

### 3. **[HIGH PRIORITY]** Run Longer Optimization with Gap Constraints
The public kernels run for hours with many iterations:
- Use sa_v1_parallel with -n 50000 -r 10 or higher
- Start from the best touching ensemble
- Modify to maintain gaps during optimization

### 4. **[MEDIUM PRIORITY]** Focus on High-Gap N Values
From analysis, these N values have the largest gaps between valid and touching:
- N=181: gap 0.040
- N=168: gap 0.036
- N=194: gap 0.035
- N=165: gap 0.025
- N=166: gap 0.024

Optimizing these specific N values with gap constraints could yield significant improvements.

### 5. **[MEDIUM PRIORITY]** Backward Propagation with Gap Constraints
Use the backpacking approach but ensure all configurations maintain gaps:
- Start from N=200, work down to N=1
- For each config, try removing each tree
- Keep only configurations with distance > 0 for all pairs

## What NOT to Try
- ❌ More scanning of existing CSVs - we've exhausted this approach
- ❌ Simple ensemble of existing solutions - they're all at local optima
- ❌ Running bbox3/tree_packer without gap constraints - produces touching trees

## Validation Notes
- CV scheme: Calculate score = Σ(s_n² / n) for n=1 to 200
- Validation: Ensure distance > 0 for ALL tree pairs in each configuration
- The 's' prefix is required for Kaggle submission format

## SUBMISSION STRATEGY
- Remaining submissions: 90
- **SUBMIT after this experiment** - we have abundant submissions
- LB feedback is free information - use it to calibrate approaches

## Key Files
- Best valid submission: /home/code/experiments/002_valid_submission/submission.csv (71.81)
- Best touching submission: /home/code/experiments/002_valid_ensemble/submission.csv (70.65 - rejected)
- C++ optimizer: research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/

## Next Experiment: Micro-Separation
1. Load the best touching ensemble (70.65)
2. For each N, identify touching tree pairs
3. Apply minimal separation to create gaps
4. Re-optimize bounding box rotation
5. Calculate new score and verify validity
6. Submit to verify LB score