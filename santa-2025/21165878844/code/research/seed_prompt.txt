# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.646824 (touching trees - INVALID for Kaggle)
- Best valid score: 71.812779 (non-touching trees - VALID for Kaggle)
- Best LB score: N/A (submission rejected with "Overlapping trees in group 004")
- Target: 68.919154 | Gap to target: 2.89 points (4.2%) from valid solution

## CRITICAL DISCOVERY: Kaggle Validation is STRICTER

**The baseline submission was REJECTED because Kaggle considers touching trees as "overlapping".**

Key findings:
1. **Touching = Overlapping for Kaggle**: Trees with distance=0 (even just sharing a point/edge) are rejected
2. **190/200 N values have touching trees** in the optimized submission
3. **Valid ensemble scores 71.81** vs touching ensemble at 70.65 - a 1.17 point penalty for non-touching
4. **Gap to target is now 2.89 points** from valid solution, not 1.73 points

## Response to Evaluator

The evaluator correctly identified:
1. ✅ Need to submit baseline to verify LB score - DONE, revealed validation issue
2. ✅ Ensemble snapshot submissions - DONE, but most have touching trees
3. ✅ N=1 optimality - N=1 is optimal at 45 degrees
4. ⚠️ fix_direction - Not yet applied, but won't help with touching issue

**NEW PRIORITY**: The touching-trees issue is the #1 blocker. We need configurations that:
- Have gaps between ALL tree pairs (distance > 0)
- Still achieve competitive scores (close to 70.65)

## Recommended Approaches (Priority Order)

### 1. **[CRITICAL]** Create Valid Submission with Small Gaps
The current valid ensemble scores 71.81. We need to:
- Apply small translations to separate touching trees
- Minimize the score impact of these separations
- Target: Get valid score below 71.0

**Approach**: For each N with touching trees:
1. Identify touching pairs
2. Apply minimal translation to create gap (e.g., 1e-6 units)
3. Re-optimize with fix_direction to minimize bbox increase

### 2. **[HIGH PRIORITY]** Run Optimization with Gap Constraint
Modify the C++ optimizers (bbox3, tree_packer) to:
- Maintain minimum gap between trees (e.g., 1e-6)
- This prevents the "touching" optimization that Kaggle rejects
- May find better solutions than post-hoc separation

### 3. **[HIGH PRIORITY]** Submit Valid Ensemble to Get LB Baseline
Even though 71.81 is far from target, we need to:
- Verify our validation matches Kaggle's
- Establish CV-LB relationship
- Use remaining 91 submissions for feedback

### 4. **[MEDIUM PRIORITY]** Implement Lattice Packing for Large N
For N >= 58, grid-based placement may achieve:
- Natural gaps between trees
- Competitive scores
- More predictable optimization

### 5. **[MEDIUM PRIORITY]** Focus on Small N (1-10)
These contribute 4.33 to score. Even small improvements matter:
- N=1: Already optimal (0.66 contribution)
- N=2-10: May have room for improvement with valid configurations

## What NOT to Try
- ❌ Using configurations with touching trees (Kaggle rejects them)
- ❌ Micro-optimization of existing solutions (they're at local optima with touching)
- ❌ Simple SA runs without gap constraints

## Technical Details

### Validation Function (MUST USE)
```python
def is_valid_configuration(trees, min_gap=1e-9):
    """Check if configuration has gaps between all trees"""
    if len(trees) <= 1:
        return True
    polygons = [t.polygon for t in trees]
    
    for i in range(len(polygons)):
        for j in range(i+1, len(polygons)):
            dist = polygons[i].distance(polygons[j])
            if dist < min_gap:
                return False
    return True
```

### Score Breakdown (Valid Ensemble)
- N=1-10: 4.33 (same as touching)
- N=11-50: 15.24 (vs 14.71 touching)
- N=51-100: 21.20 (vs 17.64 touching)
- N=101-150: 17.83 (vs 17.14 touching)
- N=151-200: 19.70 (vs 16.85 touching)

The biggest penalty is in N=51-100 range (3.56 points worse).

## SUBMISSION STRATEGY
- Remaining submissions: 91
- Submit after this experiment? **YES** - need to verify valid submission works
- Priority: Create and submit a valid ensemble first, then optimize

## Next Experiment
1. Build valid submission from best non-touching configurations
2. Apply fix_direction to minimize bbox
3. Submit to verify Kaggle accepts it
4. Use LB feedback to calibrate further optimization