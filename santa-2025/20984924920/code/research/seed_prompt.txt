## Current Status
- Best CV score: 173.6881 (Baseline Greedy N=1-5)
- Best LB score: 173.6881
- CV-LB gap: 0.0000
- Recent Failure: `sa_random_init_n20` (Score 185.86) failed to beat sample submission and had validity issues ("Overlapping trees").

## Response to Evaluator
- **Technical Verdict:** TRUSTWORTHY but NEEDS TUNING.
- **Evaluator's Top Priority:** Refine SA to start from the Sample Submission.
- **Response:** **AGREE.** Random initialization was too chaotic. I will pivot to initializing from `sample_submission.csv`. This guarantees a valid starting point and ensures monotonic improvement. I will also implement the suggested "Center Squeeze" and adaptive penalty.

## Data Understanding
- **Sample Submission:** Contains valid but loose packings (Density ~0.16-0.30). Huge potential for compaction.
- **Parsing:** The sample submission uses `s` prefixes (e.g., `s1.23`). These must be stripped for processing and re-added for submission.
- **Geometry:** `shapely.intersects` is fast and strict. Use it for the final validity check.

## Recommended Approaches
**Priority 1: Refined SA with Sample Initialization (N=1-30)**
- **Initialization:** Load `sample_submission.csv`. For each $N$, create `ChristmasTree` objects at the specified positions.
- **Energy Function:** $E = \text{Side} + \frac{C}{T} \cdot \text{Overlap} + \gamma \cdot \sum (x_i^2 + y_i^2)$
  - **Side:** Max dimension of bounding box.
  - **Overlap:** Area of intersection. Weight $\frac{C}{T}$ increases as $T \to 0$ to enforce validity.
  - **Gravity:** $\sum (x_i^2 + y_i^2)$ pulls trees towards $(0,0)$ to fill internal voids. Keep $\gamma$ small (e.g., $10^{-4}$).
- **Moves:**
  1.  **Shift:** Small random translation.
  2.  **Rotate:** Small random rotation.
  3.  **Swap:** Swap two trees.
  4.  **Global Squeeze:** Scale all positions by $0.99$ (towards origin). This is a high-impact move to reduce the bounding box.
- **Parameters:**
  -   Iterations: 100,000 (since $N$ is small, this is fast).
  -   Start Temp: Lower than random init (e.g., 0.1), since we start near a local optimum.
  -   Cooling: Geometric ($0.9999$).
- **Safety Mechanism:**
  -   Track `best_valid_solution`. Update ONLY if `overlap == 0` (checked via `intersects()`) and `side < best_valid_side`.
  -   If SA finishes without a better valid solution, **revert to the sample submission**. This prevents regression.

## What NOT to Try
- **Random Initialization:** Proven failure for $N > 1$.
- **Loose Validity Checks:** Do not rely on `overlap < 1e-6`. Use `not intersects()`.

## Validation Notes
- **Metric:** $\sum (s_n^2 / n)$.
- **Process:** Run for $N=1$ to $30$. Calculate score contribution. Compare with Sample Submission.
- **Submission:** Create `submission_sa_refined.csv`. Ensure all rows (even untouched $N > 30$) are present.
