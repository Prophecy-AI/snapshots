# Santa 2025 Christmas Tree Packing - Evolved Seed Prompt (Loop 4)

## Current Status
- Best CV score: 70.734327 from all experiments (001-004)
- Best LB score: 70.734327 (verified)
- Target: 68.931058 | Gap to target: 1.803269 (2.5%)

## Critical Findings

### The Core Problem
1. **Baseline is at a strong local optimum**: 70.734327 cannot be improved by:
   - tree_packer_v21 (C++ SA with collision constraints)
   - jonathanchan sa_v3_parallel optimizer
   - Random restart SA
   - Structured grid packing
   - Fractional translation

2. **Better configurations exist but have overlaps**:
   - ensemble_submission.csv scores 67.77 (1.16 BELOW target!)
   - But it has 30 N values with overlaps (1340 overlap pairs)
   - ALL 2.96 points of improvement are locked behind overlaps
   - Simple push-apart repair makes scores MUCH worse

3. **The improvement is concentrated in small N values**:
   - N=7: improvement of 0.24 (baseline 0.40 vs ensemble 0.16)
   - N=6: improvement of 0.23
   - N=10: improvement of 0.21
   - N=9: improvement of 0.21
   - N=5: improvement of 0.20

### What We've Tried (All Failed)
1. **exp_001**: Baseline + tree_packer_v21 → 70.734327
2. **exp_002**: Extended optimization (15000 iters, 16 restarts) → 70.734327
3. **exp_003**: Proper SA with collision constraints → 70.734327
4. **exp_004**: Structured grid packing → 70.734327

## Response to Evaluator

The evaluator correctly identified that:
1. The structured packing approach was too simplistic
2. The cpp_parallel_sa configs are fundamentally broken (overlaps)
3. Simple repair cannot fix densely packed configurations

I agree with the evaluator's assessment. The key insight is that the "better" configurations were optimized WITHOUT collision constraints, making them invalid. We need a fundamentally different approach.

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY] Implement Proper Overlap Repair with SA**
The ensemble has configurations that score 67.77 but have overlaps. Instead of simple push-apart:
- Start from the overlapping configuration
- Use SA to find a NEARBY valid configuration
- Key: Allow the SA to explore the space around the overlapping config
- The overlapping config shows WHERE good solutions exist

**Concrete implementation:**
```python
def repair_with_sa(xs, ys, degs, tx, ty, max_iter=50000):
    # Start from overlapping config
    # Use SA with VERY small step sizes
    # Accept moves that REDUCE overlaps OR improve score
    # Temperature schedule: start high, cool slowly
    # Key: Don't just push apart - explore the neighborhood
```

### 2. **[HIGH PRIORITY] Implement Egortrushin Translation SA**
The egortrushin kernel uses a different approach:
- Start with 2 base trees at optimal angles
- Use SA to optimize translation parameters (dx, dy)
- Create N trees by translating the 2 base trees in a grid pattern
- This creates collision-free packings BY CONSTRUCTION

**Key difference from exp_004:**
- exp_004 used grid search over fixed (dx, dy) values
- egortrushin uses SA to find optimal (dx, dy) in continuous space
- The SA can find much better translation distances

### 3. **[MEDIUM PRIORITY] Focus on Specific N Values**
The biggest improvements are in N=5-10. Try:
- Very long SA runs (100k+ iterations) on just these N values
- Multiple random restarts with different initial configurations
- Genetic algorithm crossover between different configurations

### 4. **[LOWER PRIORITY] Try Different Optimization Algorithms**
- Genetic algorithm with crossover between configurations
- Basin hopping (random perturbation + local optimization)
- Differential evolution

## What NOT to Try
- More iterations of tree_packer_v21 on baseline (already tried)
- Simple grid search for structured packing (already tried)
- Simple push-apart repair (makes scores worse)
- Random restart SA with standard parameters (already tried)

## Validation Notes
- CV scheme: Direct score calculation (sum of s²/n for n=1 to 200)
- Overlap detection: Shapely polygon intersection (not just bounding box)
- All submissions must have NO overlaps

## SUBMISSION STRATEGY
- Remaining submissions: 95
- Submit after this experiment? YES - we have abundant submissions
- Any improvement over 70.734327 should be submitted immediately

## Key Files
- Baseline: /home/nonroot/snapshots/santa-2025/21105319338/code/datasets/santa-2025-csv/santa-2025.csv
- Ensemble (with overlaps): /home/nonroot/snapshots/santa-2025/21108486172/code/experiments/001_baseline/ensemble_submission.csv
- tree_packer_v21: /home/nonroot/snapshots/santa-2025/21105319338/code/experiments/001_baseline/tree_packer_v21
- jonathanchan C++ source: /home/code/experiments/sa_v3_parallel.cpp
