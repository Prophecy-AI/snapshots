# Santa 2025 - Christmas Tree Packing Challenge

## Problem Overview
This is a 2D irregular polygon packing optimization problem. The goal is to pack Christmas tree-shaped polygons into the smallest possible square bounding box for configurations of 1-200 trees.

**Scoring:** score = Σ(side_length² / n) for n=1 to 200 (lower is better)
**Target:** Beat 68.931058

## Tree Shape
Each tree is a 15-vertex polygon with:
- Tip at (0, 0.8)
- Three tiers of branches at y=0.5, 0.25, 0
- Trunk from y=0 to y=-0.2
- Width: 0.7 at base, 0.4 mid, 0.25 top
- Trunk width: 0.15

Trees can be rotated (0-360 degrees) and positioned at any (x, y) coordinates.

## CRITICAL: Download Pre-Computed Solutions

**ALL top kernels use pre-computed solutions from Kaggle datasets.** These contain HOURS of optimization results.

Key datasets to look for:
- `santa-submission` - Contains bbox3 binary and optimized CSV
- `santa-2025-csv` - Contains pre-optimized solutions
- `bucket-of-chump` - Contains pre-optimized solutions

**FIRST STEP:** Download and use these pre-computed solutions as baseline!

## Top Approaches from Public Kernels

### 1. bbox3 Binary Optimizer (Most Common)
All top kernels use a compiled `bbox3` binary with parameters:
- `-n [iterations]` - Number of optimization iterations (1000-5000)
- `-r [restarts]` - Number of random restarts (4-96)

Example: `./bbox3 -n 2000 -r 96`

**Source:** See `../research/kernels/saspav_santa-submission/` and `../research/kernels/jazivxt_why-not/`

### 2. Santa Claude C++ Optimizer
Custom C++ implementation with:
- Simulated annealing with swap moves
- Multi-start with different initial angles
- Squeeze and compaction operations
- Local search with 8-directional moves
- Backward propagation (bp.cpp) - improves smaller configs from larger ones

**Source:** See `../research/kernels/smartmanoj_santa-claude/santa-claude.ipynb`

### 3. fix_direction Rotation Optimization
Post-processing step that:
1. Collects all polygon vertices
2. Computes convex hull
3. Uses scipy.minimize_scalar to find optimal rotation angle (0-90°)
4. Rotates entire configuration to minimize bounding box

**Source:** See `../research/kernels/saspav_santa-submission/santa-submission.ipynb`

## Key Optimization Techniques

### Collision Detection
- Use Shapely library with STRtree for efficient spatial queries
- Check `polygon.intersects()` but allow `polygon.touches()` (touching is OK)
- Use high-precision Decimal arithmetic (25-30 digits) for coordinates

### Squeeze Operation
```python
# Iteratively scale configuration toward center
for scale in [0.9995, 0.999, ...]:
    trial_positions = center + (positions - center) * scale
    if no_overlap(trial_positions):
        positions = trial_positions
    else:
        break
```

### Compaction
Move each tree toward center in small steps until collision, then back up.

### Local Search
- Try 8-directional moves (N, S, E, W, NE, NW, SE, SW)
- Try rotation adjustments (±5°, ±2°, ±0.8°, ±0.3°, ±0.1°)
- Accept moves that reduce bounding box

### Backward Propagation
Key insight: A good n-tree configuration can be derived from (n+1)-tree by removing one tree.
1. Start from N=200 configuration
2. For each n from 200 down to 2:
   - Try removing each boundary-touching tree
   - If result improves n-1 configuration, save it

### Overlap Repair
If optimization creates overlaps, replace those groups from donor (baseline) file:
```python
for failed_n in overlapping_groups:
    replace_group(target_file, donor_file, group_id=f'{failed_n:03d}')
```

## Recommended Experiment Pipeline

### Experiment 1: Baseline from Pre-computed Solution
1. Download pre-computed solution from Kaggle dataset
2. Validate no overlaps
3. Calculate score
4. Expected: Should match or beat target ~68.9

### Experiment 2: bbox3 Optimization
1. Start from baseline
2. Run `./bbox3 -n 2000 -r 96` (or similar parameters)
3. Apply fix_direction rotation optimization
4. Repair any overlaps from donor file
5. Validate and score

### Experiment 3: Custom C++ Optimizer
1. Compile tree_packer_v21.cpp with OpenMP
2. Run with `-n 5000 -r 16` or higher
3. Apply backward propagation (bp.exe)
4. Validate and score

### Experiment 4: Ensemble/Merge Best Configurations
1. For each n=1 to 200, take the best configuration from all experiments
2. Merge into single submission
3. Validate no overlaps

## Validation Code

```python
from shapely.geometry import Polygon
from shapely.strtree import STRtree
from shapely import affinity

def has_overlap(trees):
    polygons = [t.polygon for t in trees]
    tree_index = STRtree(polygons)
    for i, poly in enumerate(polygons):
        indices = tree_index.query(poly)
        for idx in indices:
            if idx != i and poly.intersects(polygons[idx]) and not poly.touches(polygons[idx]):
                return True
    return False

def get_score(trees, n):
    xys = np.concatenate([np.asarray(t.polygon.exterior.xy).T for t in trees])
    side = max(xys.max(axis=0) - xys.min(axis=0))
    return side**2 / n
```

## Submission Format
- CSV with columns: id, x, y, deg
- id format: `{n:03d}_{tree_index}` (e.g., "001_0", "002_0", "002_1")
- Values prefixed with 's': `s0.123456`, `s-0.789`
- Coordinates constrained to -100 ≤ x, y ≤ 100

## Key Insights

1. **Pre-computed solutions are essential** - Don't try to optimize from scratch
2. **bbox3 binary is the workhorse** - Most improvements come from this tool
3. **fix_direction provides easy gains** - Rotation optimization is cheap and effective
4. **Backward propagation is powerful** - Smaller configs benefit from larger ones
5. **Always validate overlaps** - Invalid submissions will error
6. **Use high precision** - Decimal(25-30) to avoid floating point issues

## Data Files
- `/home/data/sample_submission.csv` - Basic greedy solution (not optimized)
- Pre-computed solutions from Kaggle datasets (download required)

## References
- Getting Started: `../research/kernels/inversion_santa-2025-getting-started/`
- Santa-submission: `../research/kernels/saspav_santa-submission/`
- Why Not: `../research/kernels/jazivxt_why-not/`
- Santa Claude: `../research/kernels/smartmanoj_santa-claude/`
