# Christmas Tree Packing Optimization - Evolved Seed Prompt (Loop 2)

## Current Status
- Best CV score: 116.98 from tree_packer.exe optimization
- Best LB score: N/A (no submissions yet)
- Target: 68.931058 | Gap to target: ~48 points (still ~70% away)

## Response to Evaluator
The evaluator correctly identified that:
1. **The baseline approach (Python local search) was too weak** - Agreed. We've now switched to the C++ tree_packer.exe which is orders of magnitude faster.
2. **bbox3 or C++ tree packer should be prioritized** - Implemented. We're now using tree_packer.exe with good results.
3. **Backward propagation is important** - Implemented. We're running bp.exe after each optimization pass.

The evaluator's top priority was to get the high-performance tools working. This has been done successfully.

## Progress Summary
Starting from baseline 149.29, we've achieved:
- After tree_packer.exe (n=10000, r=32): 127.03
- After backward propagation: 125.15
- After tree_packer.exe (n=15000, r=64): 119.32
- After backward propagation: 119.28
- After tree_packer.exe (n=20000, r=128): 116.98
- After backward propagation: 116.98

**Key insight**: The tree_packer.exe is effective but we're still far from the target of 68.93. The score is improving but at a decreasing rate. We need more aggressive optimization strategies.

## Available Tools
1. **tree_packer.exe** - C++ optimizer with OpenMP (26 threads)
   - Parameters: -n (iterations), -r (restarts)
   - Includes: squeeze, compaction, local search, simulated annealing, swap moves
   - Location: /home/code/tree_packer.exe

2. **bp.exe** - Backward propagation optimizer
   - Removes trees from larger configurations to improve smaller ones
   - Location: /home/code/bp.exe

## Recommended Approaches (Priority Order)

### 1. Extended Optimization Runs (CRITICAL)
The tree_packer.exe is showing diminishing returns. We need to:
- Run with much higher iterations: -n 50000 or higher
- Run with more restarts: -r 512 or higher
- Run multiple passes, alternating with bp.exe

### 2. Multi-Phase Optimization Strategy
Based on the bbox3 runner kernel approach:
- Phase A: Short runs (5 min) to find promising configurations
- Phase B: Medium runs (15 min) on top candidates
- Phase C: Long runs (30+ min) on best few
- Apply fix_direction rotation optimization between phases

### 3. Fix Direction Optimization
The kernels show that rotating the entire configuration can significantly reduce bounding box:
- Use scipy.optimize.minimize_scalar to find optimal rotation angle
- Apply to all configurations after each optimization pass
- This is NOT currently being done by tree_packer.exe

### 4. Overlap Validation and Repair
Before submission, validate all configurations for overlaps:
- Use Shapely STRtree for efficient collision detection
- Replace invalid configurations with known-good baseline

### 5. Ensemble Best Solutions
Keep track of best solution for each n-tree configuration across all runs:
- Merge best solutions from different optimization runs
- This can capture improvements that might be lost in later passes

## What NOT to Try
- Simple Python-based local search (too slow)
- Single-pass optimization (need multiple passes)
- Low iteration counts (need high iterations for convergence)

## Validation Notes
- Score is computed directly on solution quality (no train/test split)
- Submission format: CSV with 's' prefix for precision
- Total rows: 20100 (sum of 1+2+...+200)

## Key Insights from Kernels
1. **Lattice patterns emerge**: Trees tend to form crystalline arrangements
2. **Boundary trees matter most**: Trees touching the bounding box determine the score
3. **Rotation is critical**: fix_direction can significantly reduce bounding box
4. **Incremental improvement**: Small improvements compound
5. **Precision matters**: Use high-precision Decimal arithmetic

## Next Steps
1. Run tree_packer.exe with higher parameters (-n 50000 -r 512)
2. Implement fix_direction rotation optimization
3. Run multiple optimization passes
4. Validate and submit to get LB feedback

## Files Reference
- Current submission: /home/submission/submission.csv (score ~116.98)
- Tree packer: /home/code/tree_packer.exe
- Backward propagation: /home/code/bp.exe
- Research kernels: /home/code/research/kernels/