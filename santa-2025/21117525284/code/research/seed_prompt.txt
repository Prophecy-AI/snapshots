# Christmas Tree Packing Optimization - Evolved Seed Prompt (Loop 3)

## Current Status
- Best CV score: 70.682741 from exp_002 (pre-optimized baseline with overlap repair)
- Best LB score: N/A (NO SUBMISSIONS YET - CRITICAL!)
- Target: 68.922808 | Gap to target: 1.76 points (2.5% improvement needed)

## CRITICAL: NO LB SUBMISSIONS YET!
We have 94 submissions remaining and ZERO LB feedback. This is unacceptable.
**SUBMIT IMMEDIATELY** to get LB calibration!

## Response to Evaluator
The evaluator correctly identified that:
1. The pre-optimized baseline is at a local optimum for local search methods (bbox3, fix_direction)
2. Backward propagation found tiny improvement (0.0017 points) but introduced overlaps
3. Ensemble approach should be tried

**I agree with the evaluator's assessment.** The key insight is that local search methods (bbox3, SA) cannot improve a highly-optimized baseline. We need:
1. **Ensemble** - Combine best configurations from multiple sources
2. **C++ SA optimizer with fractional translation** - Different optimizer that may escape local optima
3. **Constructive approaches** - Build solutions from scratch for specific N values

## Key Findings from Analysis

### Ensemble Results
- Created ensemble from 8 sources: santa-2025.csv, submission.csv, ensemble.csv, chistyakov, 71.97.csv, 72.49.csv, bucket-of-chump, repaired_baseline
- **Ensemble score: 70.679449** (improvement of 0.003 over repaired baseline)
- Source distribution: santa-2025.csv provides 188 N values, submission.csv provides 10, chistyakov provides 2
- Gap to target: 1.76 points

### Pre-optimized Sources Analysis
| Source | Total Score (valid N only) | Valid N | Overlaps |
|--------|---------------------------|---------|----------|
| ensemble.csv | 66.05 | 187 | 13 |
| santa-2025.csv | 66.47 | 188 | 12 |
| submission.csv | 66.74 | 189 | 11 |
| **repaired_baseline** | **70.68** | **200** | **0** |
| chistyakov | 70.93 | 200 | 0 |
| 71.97.csv | 71.97 | 200 | 0 |
| 72.49.csv | 72.49 | 200 | 0 |

**Key insight:** The sources with overlaps (ensemble.csv, santa-2025.csv) have BETTER per-N scores for valid configurations. If we could fix the overlaps, we'd have better scores!

### jonathanchan Kernel Discovery
The jonathanchan kernel has a sophisticated C++ SA optimizer (`sa_v1_parallel.cpp`) with:
1. **opt_v3** - Multi-start SA with population of 3 best solutions
2. **fractional_translation** - Fine-grained position adjustments (step sizes: 0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001)
3. **ls_v3** - Local search with 300 iterations
4. **perturb** - Random perturbation to escape local optima

This is DIFFERENT from bbox3 and could potentially improve the baseline!

## Recommended Approaches (Priority Order)

### 1. **[CRITICAL - DO FIRST]** Submit Current Best to Get LB Feedback
- Submit exp_002 candidate (70.682741) immediately
- We have 94 submissions and ZERO LB feedback
- Need to calibrate CV-LB relationship

### 2. **[HIGH PRIORITY]** Compile and Run jonathanchan C++ SA Optimizer
```bash
# Extract C++ code from notebook and compile
g++ -O3 -march=native -std=c++17 -fopenmp -o sa_v1_parallel sa_v1_parallel.cpp

# Run on ensemble baseline
./sa_v1_parallel -i ensemble_submission.csv -n 15000 -r 5
```
This optimizer has fractional translation which can make tiny improvements that bbox3 cannot.

### 3. **[HIGH PRIORITY]** Fix Overlaps in Better Sources
The ensemble.csv has score 66.05 (valid N only) but 13 overlaps.
For each overlapping N:
- Try configurations from other sources (chistyakov, 71.97.csv)
- If no valid alternative, run targeted optimization on that N

### 4. **[MEDIUM PRIORITY]** Targeted Optimization on Worst N Values
Top 10 worst-performing N values (highest scores):
- N=1: 0.661250 (already optimal at 45 deg)
- N=2: 0.450779
- N=3: 0.434745
- N=5: 0.416850
- N=4: 0.416545
- N=7: 0.399897
- N=6: 0.399610
- N=9: 0.387415
- N=8: 0.385407
- N=15: 0.379203

Run extended optimization on these specific N values.

### 5. **[MEDIUM PRIORITY]** Greedy Backtracking with Beam Search
For small N values (1-20), try constructive approach:
- Build solutions from scratch using beam search
- Keep top-k configurations at each step
- This is fundamentally different from local search

## What NOT to Try
- ❌ More bbox3 runs on current baseline - already at local optimum
- ❌ More fix_direction - already rotation-optimized
- ❌ Simple backward propagation - introduced overlaps

## Validation Notes
- CV scheme: Calculate total score = Σ(S²/N) for N=1 to 200
- Always validate for overlaps before submission
- Use Shapely STRtree for efficient collision detection

## SUBMISSION STRATEGY
- Remaining submissions: 94
- **SUBMIT AFTER EVERY EXPERIMENT** - we have abundant submissions
- LB feedback is FREE information - use it!
- Submit exp_002 (70.68) immediately to get baseline LB

## Next Experiment: 004_jonathanchan_sa_optimizer
1. Extract and compile sa_v1_parallel.cpp from jonathanchan kernel
2. Run on ensemble baseline (70.679449)
3. Apply fractional translation for fine-grained improvements
4. Submit result to get LB feedback

Expected improvement: 0.1-0.5 points (fractional translation can make tiny improvements)

## File Locations
- Ensemble submission: `/home/code/experiments/003_preoptimized/ensemble_submission.csv` (70.679449)
- Current best candidate: `/home/code/submission_candidates/candidate_002.csv` (70.682741)
- jonathanchan kernel: `/home/code/research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`
- Pre-optimized baselines: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/`
