# Santa 2025 - Christmas Tree Packing Optimization

## Problem Overview
Pack N Christmas trees (N from 1 to 200) into the smallest square bounding box.
- Score = sum(s_nÂ² / n) for all n from 1 to 200
- Lower score is better
- Target: 68.919154
- Current best: 70.676102 (from pre-optimized santa-2025.csv)
- Gap: 1.75 points (2.54%)

## CRITICAL INSIGHT: Pre-optimized Solutions Are at Local Optimum
The santa-2025.csv is already at a very tight local optimum. Previous experiments showed:
- Short optimization runs (minutes) find NO improvements
- Backward propagation finds NO improvements
- Simple ensemble doesn't help (santa-2025.csv dominates all N values)

**DO NOT waste time on micro-optimization of existing solutions!**

## Pre-optimized Resources Available
Location: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/`
- `santa-2025.csv` - Best known solution (score 70.676102)
- `bbox3` - Compiled C++ optimizer binary
- `bucket-of-chump/` - Alternative submissions
- `telegram/` - Additional submissions (71.97, 72.49)

## C++ Optimizers Available
1. **bbox3.cpp** - Complex Number Vector Coordination, Fluid Dynamics, Hinge Pivot
   - Parameters: `-n <iterations>` `-r <rounds>`
   - Uses aggressive_repair for overlap resolution
   
2. **tree_packer_v21.cpp** - Swap moves, Multi-angle restarts, Higher temperature SA
   - Parameters: `-n <iterations>` `-r <rounds>`
   - Uses squeeze, compaction, localSearch

## Strategies That MIGHT Work (Priority Order)

### 1. MUCH LONGER OPTIMIZATION RUNS (Hours, Not Minutes)
Top solutions run optimizers for HOURS with:
```bash
./bbox3 -n 20000 -r 100  # Run for 2+ hours
```
The jonathanchan kernel runs sa_v1_parallel for hours with 15000+ iterations and 80+ rounds.

### 2. LATTICE-BASED APPROACH FOR LARGE N (N >= 58)
The egortrushin kernel uses a fundamentally different approach:
- Start with 2 base trees in a specific configuration
- Translate them in x and y directions to create a grid pattern
- Use simulated annealing to optimize the base configuration
- For N=144, 156, 196, 200, this can achieve tighter bounds

Implementation concept:
```python
# For N >= 58, try crystalline packing
# nt = [rows, cols] such that rows * cols >= N
# Optimize the base configuration and translation vectors
```

### 3. FOCUS ON SMALL N VALUES (1-10)
These have the HIGHEST score contribution:
- N=1: side=0.813, contributes 0.66 to score (highest single contribution!)
- N=2: side=0.950, contributes 0.45 to score
- Small N values have lowest efficiency (1.5-2.6 trees/unit area vs 3.0+ for large N)

For N=1, optimal angle is 45 degrees (minimizes bounding box). Verify this is being used!

### 4. PERTURBATION TO ESCAPE LOCAL OPTIMA
The sa_v1_parallel code includes perturbation logic:
```cpp
start = perturb(pop[0].second, 0.1 + 0.05 * (r % 3), 42 + r * 1000 + c.n);
```
This randomly perturbs the best solution to escape local optima.

### 5. DIFFERENT STARTING CONFIGURATIONS
Instead of optimizing the pre-optimized submission:
- Generate new random configurations
- Use lattice-based initial placement
- Try different angle distributions

## What NOT to Try (Already Exhausted)
- Short optimization runs (minutes) - NO improvements found
- Simple ensemble from available sources - santa-2025.csv dominates all N values
- Backward propagation - NO improvements found
- fix_direction post-processing - causes precision loss and overlaps

## Technical Notes

### Tree Geometry
- 15-vertex polygon (trunk + 3 tiers)
- Trunk: width=0.15, height=0.2
- Base tier: width=0.7
- Middle tier: width=0.4
- Top tier: width=0.25
- Tip at y=0.8

### Precision Requirements
- Use Decimal precision (18+ decimal places)
- scale_factor = 1e15 for geometric calculations
- Kaggle rejects overlapping trees - must validate before submission

### Submission Format
```csv
id,x,y,deg
001_0,s0.0,s0.0,s45.0
002_0,s0.154097,s-0.038540,s203.629377
...
```
- Values prepended with 's' to preserve precision
- Coordinates constrained to -100 <= x,y <= 100

## Recommended Experiment Sequence

### Experiment 1: Verify Baseline
- Load santa-2025.csv and verify score = 70.676102
- Submit to confirm LB matches CV

### Experiment 2: Long Optimization Run
- Run bbox3 or tree_packer_v21 for 2+ hours with high iterations
- Use multiple random seeds
- Keep best result for each N value

### Experiment 3: Lattice Approach for Large N
- Implement grid-based placement for N >= 58
- Compare with current configurations
- Keep better ones

### Experiment 4: Small N Optimization
- Focus exhaustive search on N=1 through N=10
- Try all rotation angles in 0.001 degree increments
- These have outsized impact on total score

### Experiment 5: Hybrid Ensemble
- Combine best results from experiments 2-4
- For each N, keep the configuration with smallest side length

## Score Breakdown Analysis
To close the 1.75 point gap:
- Need to reduce average side by ~0.053 units across all N values
- OR find significant improvements in specific N values
- N=1 alone could save up to 0.16 points if optimized perfectly

## Validation
- CV = LB for this optimization problem (no distribution shift)
- Must validate for overlaps before submitting
- Use high-precision Decimal arithmetic to avoid floating-point errors
