# Santa 2025 - Christmas Tree Packing Optimization

## Problem Overview
Pack N Christmas trees (N from 1 to 200) into the smallest square bounding box.
- Score = sum(s_nÂ² / n) for all n from 1 to 200
- Lower score is better
- Target: 68.919154
- Current best: 70.676102 (from pre-optimized santa-2025.csv)
- Gap: 1.75 points (2.54%)

## Score Breakdown by N Range
- N=1-10: contributes 4.33 points (6.13% of total)
- N=1-50: contributes 19.04 points (26.94% of total)
- N=51-100: contributes 17.64 points
- N=101-200: contributes 33.99 points

**Key insight**: Large N values (101-200) contribute nearly half the score!

## CRITICAL INSIGHT: Pre-optimized Solutions Are at Local Optimum
The santa-2025.csv is already at a very tight local optimum. Previous experiments showed:
- Short optimization runs (minutes) find NO improvements
- Backward propagation finds NO improvements
- Simple ensemble doesn't help (santa-2025.csv dominates all N values)

**DO NOT waste time on micro-optimization of existing solutions!**

## Pre-optimized Resources Available
Location: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/`
- `santa-2025.csv` - Best known solution (score 70.676102)
- `bbox3` - Compiled C++ optimizer binary
- `bucket-of-chump/` - Alternative submissions
- `telegram/` - Additional submissions (71.97, 72.49)

## C++ Optimizers Available
1. **bbox3.cpp** - Complex Number Vector Coordination, Fluid Dynamics, Hinge Pivot
   - Parameters: `-n <iterations>` `-r <rounds>`
   - Uses aggressive_repair for overlap resolution
   - Source: `/home/nonroot/snapshots/santa-2025/21116303805/code/bbox3.cpp`
   
2. **tree_packer_v21.cpp** - Swap moves, Multi-angle restarts, Higher temperature SA
   - Parameters: `-n <iterations>` `-r <rounds>`
   - Uses squeeze, compaction, localSearch
   - Source: `../research/kernels/smartmanoj_santa-claude/`

## Strategies That MIGHT Work (Priority Order)

### 1. MUCH LONGER OPTIMIZATION RUNS (Hours, Not Minutes)
Top solutions run optimizers for HOURS with:
```bash
./bbox3 -n 20000 -r 100  # Run for 2+ hours
```
The jonathanchan kernel runs sa_v1_parallel for hours with 15000+ iterations and 80+ rounds.

### 2. LATTICE-BASED APPROACH FOR LARGE N (N >= 58)
The egortrushin kernel uses a fundamentally different approach:
- Start with 2 base trees in a specific configuration
- Translate them in x and y directions to create a grid pattern
- Use simulated annealing to optimize the base configuration
- For N=144, 156, 196, 200, this can achieve tighter bounds

Implementation concept:
```python
# For N >= 58, try crystalline packing
# nt = [rows, cols] such that rows * cols >= N
# Optimize the base configuration and translation vectors
```

### 3. FOCUS ON SMALL N VALUES (1-10)
These have the HIGHEST per-N score contribution:
- N=1: side=0.813, contributes 0.66 to score (highest single contribution!)
- N=2: side=0.950, contributes 0.45 to score
- Small N values have lowest efficiency (1.5-2.6 trees/unit area vs 3.0+ for large N)

**N=1 is already optimal at 45 degrees** (verified - minimizes bounding box to 0.813)

### 4. PERTURBATION TO ESCAPE LOCAL OPTIMA
The sa_v1_parallel code includes perturbation logic:
```cpp
start = perturb(pop[0].second, 0.1 + 0.05 * (r % 3), 42 + r * 1000 + c.n);
```
This randomly perturbs the best solution to escape local optima.

### 5. DIFFERENT STARTING CONFIGURATIONS
Instead of optimizing the pre-optimized submission:
- Generate new random configurations
- Use lattice-based initial placement
- Try different angle distributions

## What NOT to Try (Already Exhausted)
- Short optimization runs (minutes) - NO improvements found
- Simple ensemble from available sources - santa-2025.csv dominates all N values
- Backward propagation - NO improvements found
- fix_direction post-processing - causes precision loss and overlaps

## Technical Notes

### Tree Geometry
- 15-vertex polygon (trunk + 3 tiers)
- Bounding box: (-0.35, -0.2) to (0.35, 0.8) = width 0.7, height 1.0
- Tree area: 0.2456 square units
- Trunk: width=0.15, height=0.2
- Base tier: width=0.7
- Middle tier: width=0.4
- Top tier: width=0.25
- Tip at y=0.8

### Precision Requirements
- Use Decimal precision (18+ decimal places)
- scale_factor = 1e15 for geometric calculations
- Kaggle rejects overlapping trees - must validate before submission

### Submission Format
```csv
id,x,y,deg
001_0,s0.0,s0.0,s45.0
002_0,s0.154097,s-0.038540,s203.629377
...
```
- Values prepended with 's' to preserve precision
- Coordinates constrained to -100 <= x,y <= 100

## Recommended Experiment Sequence

### Experiment 1: Verify Baseline
- Copy santa-2025.csv from preoptimized folder
- Verify score = 70.676102
- Submit to confirm LB matches CV

### Experiment 2: Long Optimization Run
- Compile and run bbox3 or tree_packer_v21 for 2+ hours
- Use high iterations: `-n 20000 -r 100`
- Use multiple random seeds
- Keep best result for each N value

### Experiment 3: Lattice Approach for Large N
- Implement grid-based placement for N >= 58
- For N=144: try 12x12 grid
- For N=196: try 14x14 grid
- For N=200: try 14x15 or 10x20 grid
- Compare with current configurations

### Experiment 4: Ensemble from Multiple Long Runs
- Run multiple optimization sessions with different seeds
- For each N, keep the configuration with smallest side length
- Combine best results into final submission

### Experiment 5: Focus on High-Impact N Values
- N=101-200 contributes 34 points (48% of total)
- Improving large N by even 0.5% could save 0.17 points
- Try lattice approach specifically for these

## Score Gap Analysis
To close the 1.75 point gap:
- Need to reduce average side by ~0.053 units across all N values
- OR find significant improvements in specific N values
- Large N (101-200) is the biggest opportunity - contributes 34 points

## Validation
- CV = LB for this optimization problem (no distribution shift)
- Must validate for overlaps before submitting
- Use high-precision Decimal arithmetic to avoid floating-point errors

## Key Kernel References
1. `../research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/` - bbox3 runner with phased optimization
2. `../research/kernels/smartmanoj_santa-claude/` - tree_packer_v21 with swap moves
3. `../research/kernels/jazivxt_why-not/` - bbox3 with fluid dynamics
4. `../research/kernels/inversion_santa-2025-getting-started/` - greedy baseline algorithm
