# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.6761 from exp_000 (baseline)
- Best LB score: 70.6761 (confirmed - CV=LB gap is 0.0000)
- Target: 68.894234 | Gap to target: 1.78 points (2.6%)
- **STUCK AT LOCAL OPTIMUM**: 2 experiments with identical scores (70.676102)
- **SUBMISSION FAILED**: exp_001 failed with "Overlapping trees in group 016" - bbox3 introduced precision issues

## ⚠️ CRITICAL ISSUE: SUBMISSION FAILED DUE TO OVERLAPS ⚠️

The exp_001 submission failed because bbox3 modified the file and Kaggle detected overlaps that we didn't detect locally. This is likely a **numerical precision issue**.

**Root cause**: bbox3 outputs coordinates with different precision than the original baseline, causing Kaggle's overlap detection to fail.

**Solution**: We need to either:
1. Use the original baseline submission (known to work)
2. Ensure any modifications preserve the exact precision format
3. Validate submissions more carefully before submitting

## Key Findings from Research (Loop 2)

### From egortrushin kernel (126 votes):
- **2-tree base configuration approach** for large N
- Start with 2 base trees (e.g., at [-2.93, -4.25, 67°] and [-3.93, -4.17, 250°])
- Translate in x and y directions using `nt=[nx, ny]` to create nx*ny trees
- Optimize base configuration AND translation vectors jointly using SA
- This is **fundamentally different** from random optimization

### From chistyakov kernel (120 votes):
- **Rebuild from corners approach**
- For each large N configuration, check if trees closest to each corner form a better smaller N configuration
- Key insight: most problems are in corners, so checking corner subsets covers 99% of positive cases

### From previous analysis:
1. **N=1 is at theoretical minimum** - 45 degrees, score 0.661250 - NO improvement possible
2. **Baseline N=100 uses only 4 unique angles** (65° and 245°) - highly structured
3. **All 30 pre-optimized CSVs are dominated by baseline** for ALL N values
4. **Small N (1-15) have lowest efficiency** but contribute most to score
5. **Gap of 1.78 points requires ~2.5% improvement** across all N

## Response to Evaluator

The evaluator correctly identified:
1. **bbox3 run was too short** (190 seconds) - top kernels run for HOURS
2. **Lattice approach was too naive** - need optimized 2-tree base configuration
3. **No perturbation strategy** - need to escape local optima
4. **No submission made** - we have 99 submissions remaining, USE THEM

**My response**: 
- I agree the bbox3 run was too short
- However, the submission FAILED due to overlaps - we need to fix this first
- The egortrushin approach is fundamentally different and worth trying
- We should test new approaches on small N first before scaling up

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Implement egortrushin 2-tree base configuration approach
This is **fundamentally different** from running bbox3 longer. The approach:
1. Define 2 base trees with optimized positions and angles
2. Define translation vectors (dx, dy)
3. Create grid of trees by translating base trees
4. Optimize base configuration AND translation vectors jointly

**Test on small N first**: Try N=36 (6x6), N=72 (8x9), N=100 (10x10)

### 2. **[HIGH PRIORITY]** Run bbox3 MUCH longer with proper validation
If we run bbox3 longer, we MUST:
1. Validate the output has no overlaps before submitting
2. Ensure precision is preserved
3. Run for 30-60 minutes minimum

### 3. **[HIGH PRIORITY]** Try rebuild from corners approach
For each large N configuration:
1. Find trees closest to each corner
2. Check if they form a better smaller N configuration
3. This propagates good configurations from larger N to smaller N

### 4. **[MEDIUM PRIORITY]** Focus on specific N values with room for improvement
- N=2 to N=15 have lowest efficiency
- Try exhaustive search for small N
- Try different structural approaches for specific N

## What NOT to Try (CONFIRMED DEAD ENDS)
- ❌ Simple ensemble (santa-2025.csv dominates all N values)
- ❌ Short optimization runs (local optimum is too tight)
- ❌ Backward propagation alone (no improvements found)
- ❌ N=1 optimization (already at theoretical minimum)
- ❌ Simple lattice/grid patterns (much worse than baseline)
- ❌ zaburo constructive approach (much worse than baseline)

## SUBMISSION STRATEGY
- Remaining submissions: 98 (used 2, one failed)
- **SUBMIT AGGRESSIVELY** - we have abundant submissions
- **VALIDATE BEFORE SUBMITTING** - check for overlaps with high precision
- Submit after EVERY experiment to get LB feedback

## NEXT EXPERIMENT: 003_egortrushin_lattice

**Goal**: Implement the egortrushin 2-tree base configuration approach for large N values.

**Steps**:
1. Create experiment folder: `experiments/003_egortrushin_lattice`
2. Implement 2-tree base configuration with translation vectors
3. Test on N=36, N=72, N=100 first
4. If promising, scale to all large N values
5. Combine with baseline for small N values
6. Validate no overlaps before submitting
7. Submit to get LB feedback

**Key insight**: This approach creates **structured lattice patterns** that might achieve tighter packing than random optimization for large N.

## Technical Resources
- Compiled bbox3: `/home/code/experiments/002_bbox3_extended/bbox3`
- Pre-optimized CSV: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/santa-2025.csv`
- egortrushin kernel: `/home/code/research/kernels/egortrushin_santa25-simulated-annealing-with-translations/`
- chistyakov kernel: `/home/code/research/kernels/chistyakov_new-simple-fix-rebuild-large-layout-from-corners/`

## Validation Notes
- **ALWAYS check for overlaps** before submitting
- Use high precision (Decimal with 25 digits) for overlap detection
- Compare with Kaggle's detection threshold
- The baseline submission (santa-2025.csv) is known to work - use it as reference