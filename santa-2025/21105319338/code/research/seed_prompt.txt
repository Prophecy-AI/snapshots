# Santa 2025 Christmas Tree Packing - Evolved Seed Prompt (Loop 3)

## Current Status
- Best CV score: 70.734327 from exp_000 (baseline)
- Best LB score: 70.734327 (verified - CV = LB perfectly)
- Target: 68.931058 | Gap to target: 1.803 points (2.55%)

## Public Kernel Status (CRITICAL!)
- Have we implemented the best kernel yet? **PARTIALLY**
- Top kernels identified:
  1. jonathanchan/santa25-ensemble-sa-fractional-translation (174 votes) - Has C++ optimizer with fractional translation
  2. egortrushin/santa25-improved-sa-with-translations (126 votes) - Periodic structures for large N
  3. saspav/santa-submission (401 votes) - fix_direction rotation optimization
- Kernels we've implemented: tree_packer_v21 (basic SA), fix_direction (rotation)
- Kernels still to implement: **jonathanchan's sa_v1_parallel.cpp with fractional translation**

## CV-LB Relationship Analysis
- CV = LB perfectly (70.7343 for both submissions)
- This is expected for deterministic optimization - no distribution shift
- The gap to target (1.803 = 2.55%) must be closed through algorithmic innovation

## Response to Evaluator
The evaluator correctly identified that the periodic SA implementation had a critical bug (NaN values from unbounded translation vectors). The approach of using periodic/crystalline structures is sound, but the implementation needs fixing.

**Key evaluator recommendations I'm incorporating:**
1. Add bounds checking to periodic SA (tx/ty must stay positive)
2. Add NaN validation before accepting configurations
3. Test incrementally before long runs
4. Consider using jonathanchan's sa_v1_parallel.cpp which is proven to work

**My strategic decision:** Rather than fixing the buggy periodic SA, I recommend implementing the jonathanchan C++ optimizer which:
- Has been tested and proven to work
- Includes fractional translation (very fine adjustments)
- Uses population-based optimization (keeps top 3 configs)
- Can run for extended periods with checkpointing

## Key Findings from Analysis
1. **Ensemble from all 23 available CSVs still gives 70.7343** - No improvement from existing public submissions
2. **Score breakdown:**
   - N=1-20: 8.06 points (11.4%) - well-optimized
   - N=21-60: 14.59 points (20.6%)
   - N=61-200: 48.09 points (68.0%) - **MAIN OPPORTUNITY**
3. **Need to save 1.803 points** - requires ~2.5% improvement across all N

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Implement jonathanchan's sa_v1_parallel.cpp
The jonathanchan kernel has a proven C++ optimizer with:
- Simulated Annealing (T: 1.0 -> 0.000005)
- Local search with 8-directional moves
- **Fractional translation** (steps: 0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001)
- Population-based optimization (keep top 3 configs)
- Perturbation to escape local optima

**Implementation steps:**
1. Extract the C++ code from the notebook
2. Compile with: `g++ -O3 -march=native -std=c++17 -fopenmp -o sa_v1_parallel sa_v1_parallel.cpp`
3. Run with: `./sa_v1_parallel -i submission.csv -n 20000 -r 80`
4. Run for multiple generations (the code has endless mode)

### 2. **[HIGH PRIORITY]** Focus on Large N (61-200)
Large N values contribute 68% of the score. Techniques for large N:
- Periodic/crystalline structures (egortrushin approach - but fix the bugs!)
- Longer SA runs with more iterations
- Per-N optimization with targeted parameters

### 3. **[MEDIUM PRIORITY]** Extended Optimization Runs
The current submission is at a local optimum. To escape:
- Run SA for MUCH longer (hours, not minutes)
- Use population-based optimization to maintain diversity
- Apply fractional translation after each SA round

### 4. **[LOWER PRIORITY]** Fix Periodic SA Implementation
If jonathanchan's optimizer doesn't work, fix the periodic SA:
- Add bounds checking: `pc_new.tx = max(0.2L, min(2.0L, pc_new.tx))`
- Add NaN validation before accepting configurations
- Test on N=20-30 for 5 minutes before long runs

## What NOT to Try
- Building from scratch when proven kernels exist
- Short optimization runs (< 1 hour) - the baseline is already well-optimized
- Ensembling existing public submissions (already tried - no improvement)
- Periodic SA without fixing the bugs

## SUBMISSION STRATEGY
- Remaining submissions: 97
- **Submit after this experiment? YES** - we have abundant submissions
- LB feedback is valuable for calibration

## Validation Notes
- CV = LB for this problem (deterministic optimization)
- Validate configurations for overlaps before submission
- Check for NaN/inf values in output

## Technical Notes
The jonathanchan C++ code is embedded in the notebook at:
`/home/code/research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/santa25-ensemble-sa-fractional-translation.ipynb`

Key functions to extract:
- `sa_v3()` - Simulated annealing with temperature schedule
- `ls_v3()` - Local search with 8-directional moves
- `fractional_translation()` - Very fine position adjustments
- `opt_v3()` - Population-based optimization wrapper
