# Santa 2025 Christmas Tree Packing - Seed Prompt (Loop 4)

## Current Status
- Best CV score: 70.734327 from all experiments (exp_000 through exp_003)
- Best LB score: 70.734327 (verified with 2 submissions)
- Target: 68.922808 | Gap to target: 1.811519 (2.63%)

## Public Kernel Status (CRITICAL!)
- Have we implemented the best kernel yet? **PARTIALLY - but with bugs**
- Top kernels identified:
  1. egortrushin_santa25-improved-sa-with-translations - **NEVER PROPERLY TESTED** (exp_003 had NaN bugs)
  2. jonathanchan_santa25-ensemble-sa-fractional-translation - Tested in exp_004, no improvement
  3. jazivxt_why-not (bbox3 optimizer) - Cannot use due to GLIBC incompatibility
  4. saspav_santa-submission (fix_direction) - Tested, no improvement
- Kernels we've implemented: jonathanchan (exp_004), tree_packer_v21 (exp_001, exp_002)
- **Kernels still to implement: egortrushin periodic structure approach (PYTHON version)**

## CV-LB Relationship Analysis
- CV = LB perfectly (70.7343 for both submissions)
- This is expected for deterministic optimization - no distribution shift
- Any improvement in CV will translate directly to LB improvement
- The gap of 1.81 points must be closed through algorithmic innovation

## Response to Evaluator
**FULLY AGREE.** The evaluator correctly identified the critical issue:

1. **The egortrushin periodic structure approach was NEVER properly tested** - Experiment 003 failed due to NaN bugs in a custom C++ implementation. The ORIGINAL Python implementation uses Decimal precision and Shapely which are robust.

2. **The Python implementation should be used DIRECTLY** - Don't rewrite in C++. The kernel at `/home/code/research/kernels/egortrushin_santa25-improved-sa-with-translations/santa25-improved-sa-with-translations.ipynb` has working code.

3. **Target specific N values** where periodic structures work:
   - N=20 (4x5 grid)
   - N=24 (4x6 grid)
   - N=28 (4x7 grid)
   - N=35 (5x7 grid)
   - N=40 (5x8 grid)
   - N=42 (6x7 grid)
   - N=77 (7x11 grid)
   - N=96 (8x12 grid)

4. **Large N values (61-200) contribute 68% of total score** - This is where periodic structures can make the biggest impact.

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Implement egortrushin Periodic Structure SA (Python)
**Source:** `/home/code/research/kernels/egortrushin_santa25-improved-sa-with-translations/santa25-improved-sa-with-translations.ipynb`

**Key components to extract:**
- `ChristmasTree` class with Decimal precision
- `SimulatedAnnealing` class with periodic structure support
- Parameters: `nt` (grid dimensions), `append_y`, temperature schedule

**Target N values and grid configurations:**
```python
configs = [
    (20, [4, 5], False),   # 4x5 grid
    (24, [4, 6], False),   # 4x6 grid
    (28, [4, 7], False),   # 4x7 grid
    (35, [5, 7], True),    # 5x7 grid + extra row
    (40, [5, 8], False),   # 5x8 grid
    (42, [6, 7], False),   # 6x7 grid
    (77, [7, 11], True),   # 7x11 grid + extra row
    (96, [8, 12], True),   # 8x12 grid + extra row
]
```

**SA parameters from kernel:**
- T0=0.1, T1=0.0001
- iterations=100000
- position_delta, angle_delta for perturbation

**After periodic SA, apply backward propagation:**
- For N from 200 down to 2: try removing each tree and keep best N-1 config

### 2. **[HIGH PRIORITY]** Extend to more N values with nice factorizations
After validating the approach works on the 8 target N values, extend to:
- N=48 (6x8), N=54 (6x9), N=56 (7x8), N=60 (6x10)
- N=63 (7x9), N=64 (8x8), N=70 (7x10), N=72 (8x9)
- N=80 (8x10), N=81 (9x9), N=84 (7x12), N=90 (9x10)
- N=100 (10x10), N=108 (9x12), N=110 (10x11), N=120 (10x12)
- N=121 (11x11), N=132 (11x12), N=140 (10x14), N=144 (12x12)
- N=150 (10x15), N=156 (12x13), N=160 (10x16), N=168 (12x14)
- N=176 (11x16), N=180 (12x15), N=192 (12x16), N=196 (14x14)
- N=200 (10x20 or 14x15-5)

### 3. **[MEDIUM PRIORITY]** Apply "decay" refinement
From web search: "The decay refinement gradually reduces the size of allowed coarse movements during optimization—starting with large-scale moves that are tolerated early on and then progressively shrinking (decaying) the movement step size to fine-tune the tree placements."

Implement this by:
- Start with large position_delta (0.1) and angle_delta (30)
- Gradually reduce to very small values (0.0001, 0.1)
- Multiple phases of optimization

### 4. **[MEDIUM PRIORITY]** Asymmetric packing exploration
From discussion "Why the winning solutions will be Asymmetric" (33 votes):
- Asymmetric layouts consistently achieve lower scores than symmetric grids
- After periodic structure optimization, try breaking symmetry with small perturbations

## What NOT to Try
- ❌ More C++ optimizers starting from santa-2025.csv (already at deep local optimum)
- ❌ Random start optimization (tried in exp_004, no improvement)
- ❌ bbox3 binary (GLIBC incompatibility)
- ❌ Rewriting egortrushin in C++ (caused NaN bugs in exp_003)

## Implementation Notes

**Use the Python implementation directly:**
```python
# Key imports
from decimal import Decimal, getcontext
from shapely import affinity
from shapely.geometry import Polygon
from shapely.ops import unary_union

getcontext().prec = 25
scale_factor = Decimal("1e15")

# Use ChristmasTree class from egortrushin kernel
# Use SimulatedAnnealing class from egortrushin kernel
```

**Validation:**
- Check for overlaps using Shapely's intersects/touches
- Verify score calculation matches expected formula: s²/n
- Compare individual N scores with current best

**SUBMISSION STRATEGY:**
- Remaining submissions: 97
- Submit after this experiment? **YES - we have abundant submissions**
- LB feedback is free information - use it!

## Validation Notes
- CV = LB exactly for this deterministic optimization problem
- Any local improvement will translate directly to LB improvement
- Focus on finding improvements for specific N values, especially large N (>60)

## Key Insight
The santa-2025.csv submission is at a very deep local optimum for UNSTRUCTURED packing. But periodic/crystalline structures represent a DIFFERENT solution space that may have better optima for large N values. The egortrushin approach explores this different space.

**Target: Beat 68.922808 by improving large N values through periodic structure optimization.**