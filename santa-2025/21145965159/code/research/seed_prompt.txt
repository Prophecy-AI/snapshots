# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.675457 from corner_extraction ensemble
- Best LB score: 70.675457 (verified on LB)
- Target: 68.919154 | Gap to target: 1.756303 points (2.55%)

## CRITICAL INSIGHT FROM EVALUATOR
**We've been running bbox3 for 71-150 seconds while top kernels run for 3-11 HOURS.**
This is 40-150x SHORTER than what's needed!

The bbox3 runner kernel uses a 3-phase approach with 3-HOUR budget:
- Phase A: 15 combinations × 2 min = 30 min (n ∈ {1000,1200,1500,1800,2000}, r ∈ {30,60,90})
- Phase B: 3 candidates × 10 min = 30 min
- Phase C: 2 candidates × 20 min = 40 min

The saspav kernel runs for 11.7 HOURS with overlap repair.

## Response to Evaluator
The evaluator is absolutely correct:
1. Our 71-150 second runs are insufficient - we need 30+ minutes minimum
2. The "local optimum" conclusion was premature - we simply didn't run long enough
3. We need to implement the 3-phase systematic parameter search
4. We need the replace_group overlap repair mechanism

## Problem Overview
This is a 2D geometric packing optimization problem. Pack Christmas tree-shaped polygons into the smallest possible square bounding box for N=1 to N=200 trees.

**Metric:** score = Σ(side_n² / n) for n=1 to 200 (lower is better)
**Target Score:** 68.919154
**Current Best:** 70.675457
**Gap:** 1.756303 points (2.55%)

## Key Findings
1. N=1 has lowest efficiency (0.469) with score contribution 0.661 - could save 0.33 points
2. Small N values (1-10) have efficiency 0.47-0.82 vs best efficiency of 0.83
3. The solution is NOT at a true local optimum - we just haven't run long enough
4. CV = LB exactly when overlaps are avoided (verified with 3 successful submissions)

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Run bbox3 for 30+ minutes with 3-phase approach
Implement the bbox3 runner kernel's strategy:
```python
# Phase A: Short runs to find promising parameters
phaseA = {
    "timeout": 120,   # 2 min each
    "n_values": [1000, 1200, 1500, 1800, 2000],
    "r_values": [30, 60, 90],
}

# Phase B: Medium runs on top 3 candidates
phaseB = {"timeout": 600}  # 10 min each

# Phase C: Long runs on top 2 candidates
phaseC = {"timeout": 1200}  # 20 min each
```

### 2. **[HIGH PRIORITY]** Implement overlap repair mechanism
From saspav kernel - replace_group function:
```python
def replace_group(target_file, donor_file, group_id, output_file=None):
    # Replace overlapping groups with known-good solutions from donor
```
This allows aggressive optimization without worrying about invalid submissions.

### 3. **[MEDIUM PRIORITY]** Apply fix_direction rotation optimization
After each optimization phase, run fix_direction to tighten bounding boxes.

### 4. **[LOWER PRIORITY]** Focus on small N values
N=1 through N=10 have the lowest efficiency and most room for improvement.

## Available Resources
- bbox3 binary: `/home/code/experiments/007_long_bbox3/bbox3`
- Donor file for overlap repair: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/ensemble.csv`
- Current best: `/home/submission/submission.csv`
- bbox3 runner kernel code: `/home/code/research/kernels/yongsukprasertsuk_santa-2025-best-keeping-bbox3-runner/`
- saspav kernel code: `/home/code/research/kernels/saspav_santa-submission/`

## What NOT to Try
- Short optimization runs (< 5 minutes) - PROVEN INSUFFICIENT
- Concluding "local optimum" without running for hours
- Building from scratch when optimization time is the bottleneck

## SUBMISSION STRATEGY
- Remaining submissions: 92
- Submit after this experiment? YES - we have abundant submissions
- The goal is to run bbox3 for 30+ minutes and see if we can improve

## Validation Notes
- Use Decimal precision with scale_factor for polygon calculations
- Check for overlaps before submission using STRtree
- If overlaps detected, use replace_group to fix them