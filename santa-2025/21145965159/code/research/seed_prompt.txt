# Santa 2025 - Christmas Tree Packing Optimization

## Current Status
- Best CV score: 70.676102 from ensemble.csv
- Best LB score: 70.676102 (verified - matches CV exactly)
- Target: 68.919154 | Gap to target: 1.756948 points (2.55%)

## Public Kernel Status (CRITICAL!)
- Have we implemented the best kernel yet? **PARTIALLY** - we have the pre-optimized solutions but haven't run long optimization
- Top kernels identified:
  - jonathanchan/santa25-ensemble-sa-fractional-translation (175 votes) - uses advanced SA + fractional translation
  - jazivxt/why-not (298 votes) - bbox3 with fluid dynamics, global tension
  - yongsukprasertsuk/santa-2025-best-keeping-bbox3-runner (369 votes) - bbox3 runner with phases
- Kernels we've implemented: Basic bbox3 optimization (short runs)
- Kernels still to implement: **Long-running optimization with fractional translation**

## Ensemble Strategy
- Models available for ensemble: 21 pre-optimized solutions analyzed
- Current ensemble score: 70.676102 (ensemble.csv is already best for ALL 200 N values)
- **CRITICAL FINDING**: No improvement possible from ensembling - the pre-optimized solutions have already been ensembled

## CV-LB Relationship Analysis
- LB = CV exactly (no gap) - expected for deterministic optimization problem
- This is NOT a distribution shift problem - it's a LOCAL OPTIMUM problem

## Response to Evaluator
The evaluator recommended creating an ensemble of all pre-optimized solutions. I implemented this analysis and discovered:
1. **ensemble.csv is already the best for ALL 200 N values** - no improvement from ensembling
2. The 21 available solutions all have the same or worse scores for every N
3. This confirms the pre-optimized solution is already a well-curated ensemble

The evaluator also recommended:
- Running the "Why Not" kernel's advanced C++ optimizer with longer time budget
- Trying perturbation strategies instead of starting from scratch
- Focusing on medium/large N values (small N already optimal)

I agree with these recommendations. The grid-based approach (exp_003) confirmed that starting from scratch leads to worse local optima (86.4 vs 70.7). We need to:
1. Run LONGER optimization on the current best solution
2. Use advanced techniques like fractional translation
3. Try perturbation-based exploration

## Recommended Approaches (Priority Order)

### 1. **[HIGHEST PRIORITY]** Run Long Optimization with Fractional Translation
The jonathanchan kernel shows the state-of-the-art approach:
- Ensemble from many sources (already done in our baseline)
- Run SA with fractional translation (NOT done yet)
- Use 15000+ iterations with 5+ restarts per N
- Key technique: `fractional_translation()` with steps [0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001]

Implementation:
```cpp
// Fractional translation - micro-adjustments in 8 directions
double frac_steps[] = {0.001, 0.0005, 0.0002, 0.0001, 0.00005, 0.00002, 0.00001};
double dx[] = {0, 0, 1, -1, 1, 1, -1, -1};
double dy[] = {1, -1, 0, 0, 1, -1, 1, -1};
```

### 2. **[HIGH PRIORITY]** Run bbox3 with Extended Time Budget
The bbox3 runner kernel uses a 3-HOUR budget with multiple phases:
- Phase A: 2-min runs to find promising (n,r) parameters
- Phase B: 10-min runs on top candidates
- Phase C: 20-min runs on best few

Our previous runs used only 5-10 minutes. Need to run for 1+ hours.

### 3. **[MEDIUM PRIORITY]** Perturbation-Based Exploration
Instead of random restarts, perturb the current good solution:
- Swap tree positions
- Rotate groups of trees
- Translate clusters
- Re-optimize with SA

This explores nearby basins without losing the good starting point.

### 4. **[MEDIUM PRIORITY]** Focus on Worst-Efficiency N Values
Analysis shows:
- N=1 has lowest efficiency (0.609) but is already optimal at 45°
- Small N (1-10) contribute ~4 points but are well-optimized
- Medium N (50-100) may have more room for improvement

## What NOT to Try
- Ensembling pre-optimized solutions (already done, no improvement)
- Grid-based construction from scratch (converges to worse local optimum)
- Small N exhaustive optimization (already optimal)
- Short optimization runs (need 1+ hours)

## Validation Notes
- CV = LB exactly for this deterministic optimization problem
- Always validate for overlaps before submitting
- Use Decimal precision with scale_factor = 1e15 for calculations

## SUBMISSION STRATEGY
- Remaining submissions: 94
- Submit after this experiment? **YES** - we have abundant submissions
- Even if score doesn't improve, LB feedback confirms our understanding

## Key Technical Insights from Research
1. **Adaptive neighborhoods** - step size adjusted on-the-fly based on acceptance rate
2. **Lévy-flight jumps** - occasional long-range moves to escape local minima
3. **Collision-free region (CFR) vertices** - place polygons on CFR vertices for guaranteed feasibility
4. **No-fit polygons (NFPs)** - pre-computed for rapid overlap checks
5. **Hierarchical control** - outer loop adjusts container, inner loop optimizes placement

## Key Files
- Baseline: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/ensemble.csv`
- bbox3 optimizer: `/home/nonroot/snapshots/santa-2025/21116303805/code/preoptimized/bbox3`
- Advanced SA kernel: `/home/code/research/kernels/jonathanchan_santa25-ensemble-sa-fractional-translation/`
- Why-Not kernel: `/home/code/research/kernels/jazivxt_why-not/`
