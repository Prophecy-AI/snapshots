## Current Status
- Best CV score: **0.008303** from **070A0_exp030_control** (GP+MLP+LGBM ensemble)
- Best *confirmed* LB score: **0.0877** (exp_030 / exp_068)
- Target: **0.034700** | Gap to target: **+0.053020**
- Submissions remaining today: **4**

## CV-LB Relationship Analysis (CRITICAL)
- Established mapping on completed submissions: **LB ≈ 4.31 × CV + 0.0525** (R² ≈ 0.95)
- Interpretation: current approach family has a large **structural OOD intercept (~0.0525)**.
- Are all approaches on the same line? **YES (tabular models / same representation family)**
- Implication: further CV-only improvements are not the main lever; we must **change the CV→LB relationship** via OOD/shift-aware prediction.

## Response to Evaluator (REQUIRED)
- Technical verdict was **CONCERNS**. I agree: even if the model is stable, the current notebook risks **template non-compliance / fold-index misalignment**.
- Evaluator’s top priority: **move A0 into strictly template-compliant scaffold (053_exact_template) and fix mixture flip bug**. Agreed and making this our immediate next step.
- Key concerns raised and how we address them:
  1) **Ramp fold ordering**: unsorted ramps change fold indices. We will **use the official template split generators** (do not redefine them), guaranteeing fold ordering.
  2) **Output path**: must write to **/home/submission/submission.csv** in the final cell. We will follow template exactly.
  3) **Mixture flip/TTA bug**: implement flip as true **swap(A,B) + pct := 1-pct** and ensure it actually changes *directional* feature blocks (A-block/B-block), not just symmetric blends.

## Data Understanding (what matters for next steps)
- Full-data split is by **(SOLVENT A NAME, SOLVENT B NAME)** ramp. Our analysis shows membership masks are identical across implementations, but **fold order differs unless ramps are sorted**, which can break submission alignment.
- Baseline ensemble (GP+MLP+LGBM) is a strong ID anchor; our next gains must come from **OOD behavior control**.

## Recommended Approaches (priority order)

### 1) Make a submission-safe baseline notebook (A0-template) — minimal delta
**Goal:** eliminate “bad LB due to misalignment” as a failure mode.

**Instructions:**
1. Start from **`experiments/053_exact_template/exact_template.ipynb`** (this is the scaffold).
2. Keep the **last 3 cells IDENTICAL** to the template (no extra cells after final cell). Only change:
   - `model = ...` line in the 3rd-to-last and 2nd-to-last cells.
3. Implement a model class, e.g. **`GPMLPLGBMEnsemble_TemplateSafe`** (or reuse name if already exists) that reproduces exp_030 behavior.
4. Ensure the notebook writes to **`/home/submission/submission.csv`** (template behavior).
5. **Do NOT redefine split generators**. Import and use template `generate_leave_one_out_splits` and `generate_leave_one_ramp_out_splits`.
6. Run the notebook end-to-end; verify local recomputed MSE ≈ **0.0083**.

**Then SUBMIT A0-template** (uses 1 submission):
- Reason: verify that the template-safe scaffold yields a sane LB (should be in the historical ballpark, not 0.000000).

### 2) Fix mixture flip/TTA properly (must be consistent in CV + submission)
Even if some blended features are symmetric, we still need flip to work for any **directional blocks**.

**Implementation checklist:**
- In any featurizer with A/B blocks:
  - flip=True must swap A and B descriptor blocks
  - set `pctB := 1 - pctB`
- Add a unit check inside notebook:
  - pick a few mixture rows; assert `features(flip=False) != features(flip=True)` when using directional blocks.
- Only after correctness, decide whether to use:
  - training augmentation (duplicate flipped rows)
  - TTA at inference (average pred from both orderings)

### 3) A1: “Safe AD shrinkage” layer to reduce OOD intercept (minimal delta from A0)
**Goal:** change LB without relying on CV improvement.

**Core idea:** compute an OOD score per test sample (within each fold), then blend predictions toward a conservative fallback when OOD is high.

**Concrete plan (do this inside model wrapper so CV matches submission):**
- Fit an **applicability-domain distance model** inside `train_model`:
  - Single task: solvent embedding = [Spange + ACS_PCA + DRFP] (lookup by solvent name).
  - Full task: ramp embedding = concat(A_embed, B_embed, pctB, pctB*(1-pctB), |A-B|, A*B*(pctB*(1-pctB)) on low-dim blocks) — keep it light.
  - Use `NearestNeighbors(k=3..5)` on *training* embeddings.
  - For each sample in `predict`, compute mean kNN distance `d`.
- Convert distance to shrinkage weight `w` (start simple):
  - `d0 = quantile(d_train, 0.9)`; `w = clip((d - d0)/(d0*0.5), 0, 1)`.
- Conservative fallback prediction (choose ONE, keep minimal):
  1) **Fold-wise train mean** per target (strongly conservative), OR
  2) A tiny **numeric-only ridge** (time/temp/Arrhenius only), trained within fold, which may generalize better on new solvents than solvent embeddings.
- Final prediction: `pred_final = (1-w)*pred_base + w*pred_fallback`.

**Important:**
- Don’t tune a lot. Implement 1–2 sensible settings.
- Log CV; a slight CV worsening is acceptable if it plausibly reduces OOD intercept.

**Submission rule:** Only submit A1 if (a) A0-template submission is sane, and (b) A1 is a clean minimal delta.

### 4) (Optional, if time) Diversity pivot that can change representation
If A1 doesn’t move LB, we need a more fundamental pivot in representation while staying template-safe:
- A **graph-based solvent embed** (RDKit Morgan FP → small MLP) used only to compute OOD distance / similarity weighting (not a full GNN training).
- Or revive prior **GNN/ChemBERTa** attempt but *only after* ensuring class-name match in last cells and template compliance.

## What NOT to Try
- No more pure tabular CV optimization (HP sweeps, more seeds, weight tuning).
- Do not submit from notebooks that:
  - write anywhere other than `/home/submission/submission.csv`
  - have any cells after the final template submission cell
  - redefine split generators (unless the template explicitly does)

## Validation Notes
- CV scheme: must be exactly the template split generators.
- Before any submission: recompute MSE by parsing the generated submission file and matching it to template fold order.
- Track whether A1 changes the CV→LB relationship (same CV but better LB is a win).
